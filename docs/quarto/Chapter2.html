<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.28">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>2&nbsp; Exploring Spatio-Temporal Data – Spatio-Temporal Statistics with R (1st edition)</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./Chapter3.html" rel="next">
<link href="./Chapter1.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js" type="module"></script>
<script src="site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-b719d3d4935f2b08311a76135e2bf442.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-7d2e1f8220df954187ab24ed36a0da9c.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<link href="site_libs/quarto-contrib/foldbox/foldbox.css" rel="stylesheet">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<style>
.Algorithm {
  --color1: #948bde;
  --color2: #584eab;
}
</style>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="nav-sidebar floating quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./Chapter2.html"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Exploring Spatio-Temporal Data</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Spatio-Temporal Statistics with R (1st edition)</a> 
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Preface</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Chapter1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Introduction to Spatio-Temporal Statistics</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Chapter2.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Exploring Spatio-Temporal Data</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Chapter3.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Spatio-Temporal Statistical Models</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Chapter4.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Descriptive Spatio-Temporal Statistical Models</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Chapter5.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Dynamic Spatio-Temporal Models</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Chapter6.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Evaluating Spatio-Temporal Statistical Models</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./ChapterPergimus.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Pergimus (Epilogue)</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true">
 <span class="menu-text">Appendices</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./ChapterAppendixA.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">A</span>&nbsp; <span class="chapter-title">Some Useful Matrix-Algebra Definitions and Properties</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./ChapterAppendixB.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">B</span>&nbsp; <span class="chapter-title">General Smoothing Kernels</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./ChapterAppendixC.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">C</span>&nbsp; <span class="chapter-title">Estimation and Prediction for Dynamic Spatio-Temporal Models</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./ChapterAppendixD.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">D</span>&nbsp; <span class="chapter-title">Mechanistically Motivated Dynamic Spatio-Temporal Models</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./ChapterAppendixE.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">E</span>&nbsp; <span class="chapter-title">Case Study: Physical-Statistical Bayesian Hierarchical Model for Predicting Mediterranean Surface Winds</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./ChapterAppendixF.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">F</span>&nbsp; <span class="chapter-title">Case Study: Quadratic Echo State Networks for Sea Surface Temperature Long-Lead Prediction</span></span></a>
  </div>
</li>
      </ul>
  </li>
  <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./ChapterRPackages.html" class="sidebar-item-text sidebar-link">
  <span class="menu-text">List of <code>R</code> packages</span></a>
  </div>
  </li>
  <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">
  <span class="menu-text">References</span></a>
  </div>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#sec-STdata" id="toc-sec-STdata" class="nav-link active" data-scroll-target="#sec-STdata"><span class="header-section-number">2.1</span> Spatio-Temporal Data</a></li>
  <li><a href="#sec-STdatainR" id="toc-sec-STdatainR" class="nav-link" data-scroll-target="#sec-STdatainR"><span class="header-section-number">2.2</span> Representation of Spatio-Temporal Data in <code>R</code></a></li>
  <li><a href="#visualization-of-spatio-temporal-data" id="toc-visualization-of-spatio-temporal-data" class="nav-link" data-scroll-target="#visualization-of-spatio-temporal-data"><span class="header-section-number">2.3</span> Visualization of Spatio-Temporal Data</a>
  <ul class="collapse">
  <li><a href="#spatial-plots" id="toc-spatial-plots" class="nav-link" data-scroll-target="#spatial-plots"><span class="header-section-number">2.3.1</span> Spatial Plots</a></li>
  <li><a href="#time-series-plots" id="toc-time-series-plots" class="nav-link" data-scroll-target="#time-series-plots"><span class="header-section-number">2.3.2</span> Time-Series Plots</a></li>
  <li><a href="#sec-Hovplot" id="toc-sec-Hovplot" class="nav-link" data-scroll-target="#sec-Hovplot"><span class="header-section-number">2.3.3</span> Hovmöller Plots</a></li>
  <li><a href="#interactive-plots" id="toc-interactive-plots" class="nav-link" data-scroll-target="#interactive-plots"><span class="header-section-number">2.3.4</span> Interactive Plots</a></li>
  <li><a href="#animations" id="toc-animations" class="nav-link" data-scroll-target="#animations"><span class="header-section-number">2.3.5</span> Animations</a></li>
  <li><a href="#trelliscope-visualizing-large-spatio-temporal-data-sets" id="toc-trelliscope-visualizing-large-spatio-temporal-data-sets" class="nav-link" data-scroll-target="#trelliscope-visualizing-large-spatio-temporal-data-sets"><span class="header-section-number">2.3.6</span> Trelliscope: Visualizing Large Spatio-Temporal Data Sets</a></li>
  <li><a href="#visualizing-uncertainty" id="toc-visualizing-uncertainty" class="nav-link" data-scroll-target="#visualizing-uncertainty"><span class="header-section-number">2.3.7</span> Visualizing Uncertainty</a></li>
  </ul></li>
  <li><a href="#exploratory-analysis-of-spatio-temporal-data" id="toc-exploratory-analysis-of-spatio-temporal-data" class="nav-link" data-scroll-target="#exploratory-analysis-of-spatio-temporal-data"><span class="header-section-number">2.4</span> Exploratory Analysis of Spatio-Temporal Data</a>
  <ul class="collapse">
  <li><a href="#empirical-spatial-means-and-covariances" id="toc-empirical-spatial-means-and-covariances" class="nav-link" data-scroll-target="#empirical-spatial-means-and-covariances"><span class="header-section-number">2.4.1</span> Empirical Spatial Means and Covariances</a></li>
  <li><a href="#sec-STcovsemi" id="toc-sec-STcovsemi" class="nav-link" data-scroll-target="#sec-STcovsemi"><span class="header-section-number">2.4.2</span> Spatio-Temporal Covariograms and Semivariograms</a></li>
  <li><a href="#sec-EOFs" id="toc-sec-EOFs" class="nav-link" data-scroll-target="#sec-EOFs"><span class="header-section-number">2.4.3</span> Empirical Orthogonal Functions (EOFs)</a></li>
  </ul></li>
  <li><a href="#spatio-temporal-canonical-correlation-analysis" id="toc-spatio-temporal-canonical-correlation-analysis" class="nav-link" data-scroll-target="#spatio-temporal-canonical-correlation-analysis"><span class="header-section-number">2.5</span> Spatio-Temporal Canonical Correlation Analysis</a></li>
  <li><a href="#chapter-2-wrap-up" id="toc-chapter-2-wrap-up" class="nav-link" data-scroll-target="#chapter-2-wrap-up"><span class="header-section-number">2.6</span> Chapter 2 Wrap-Up</a></li>
  <li><a href="#lab-2.1-data-wrangling" id="toc-lab-2.1-data-wrangling" class="nav-link" data-scroll-target="#lab-2.1-data-wrangling">Lab 2.1: Data Wrangling</a>
  <ul class="collapse">
  <li><a href="#working-with-spatio-temporal-data-in-long-format" id="toc-working-with-spatio-temporal-data-in-long-format" class="nav-link" data-scroll-target="#working-with-spatio-temporal-data-in-long-format">Working with Spatio-Temporal Data in Long Format</a></li>
  <li><a href="#working-with-spatio-temporal-data-classes" id="toc-working-with-spatio-temporal-data-classes" class="nav-link" data-scroll-target="#working-with-spatio-temporal-data-classes">Working with Spatio-Temporal Data Classes</a></li>
  </ul></li>
  <li><a href="#lab-2.2-visualization" id="toc-lab-2.2-visualization" class="nav-link" data-scroll-target="#lab-2.2-visualization">Lab 2.2: Visualization</a>
  <ul class="collapse">
  <li><a href="#spatial-plots-1" id="toc-spatial-plots-1" class="nav-link" data-scroll-target="#spatial-plots-1">Spatial Plots</a></li>
  <li><a href="#time-series-plots-1" id="toc-time-series-plots-1" class="nav-link" data-scroll-target="#time-series-plots-1">Time-Series Plots</a></li>
  <li><a href="#hovmöller-plots" id="toc-hovmöller-plots" class="nav-link" data-scroll-target="#hovmöller-plots">Hovmöller Plots</a></li>
  <li><a href="#animations-1" id="toc-animations-1" class="nav-link" data-scroll-target="#animations-1">Animations</a></li>
  </ul></li>
  <li><a href="#lab-2.3-exploratory-data-analysis" id="toc-lab-2.3-exploratory-data-analysis" class="nav-link" data-scroll-target="#lab-2.3-exploratory-data-analysis">Lab 2.3: Exploratory Data Analysis</a>
  <ul class="collapse">
  <li><a href="#empirical-spatial-means" id="toc-empirical-spatial-means" class="nav-link" data-scroll-target="#empirical-spatial-means">Empirical Spatial Means</a></li>
  <li><a href="#empirical-temporal-means" id="toc-empirical-temporal-means" class="nav-link" data-scroll-target="#empirical-temporal-means">Empirical Temporal Means</a></li>
  <li><a href="#empirical-covariances" id="toc-empirical-covariances" class="nav-link" data-scroll-target="#empirical-covariances">Empirical Covariances</a></li>
  <li><a href="#empirical-orthogonal-functions-1" id="toc-empirical-orthogonal-functions-1" class="nav-link" data-scroll-target="#empirical-orthogonal-functions-1">Empirical Orthogonal Functions</a></li>
  <li><a href="#spatio-temporal-canonical-correlation-analysis-1" id="toc-spatio-temporal-canonical-correlation-analysis-1" class="nav-link" data-scroll-target="#spatio-temporal-canonical-correlation-analysis-1">Spatio-Temporal Canonical Correlation Analysis</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Exploring Spatio-Temporal Data</span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p>Exploration into territory unknown, or little known, requires both curiosity and survival skills. You need to know where you are, what you are looking at, and how it relates to what you have seen already. The aim of this chapter is to teach you those skills for exploring spatio-temporal data sets. The curiosity will come from you!</p>
<p>Spatio-temporal data are everywhere in science, engineering, business, and industry. This is driven to a large extent by various automated data acquisition instruments and software. In this chapter, after a brief introduction to the data sets considered in this book, we describe some basic components of spatio-temporal data structures in <code>R</code>, followed by spatio-temporal visualization and exploratory tools. The chapter concludes with fairly extensive Labs that provide examples of <code>R</code> commands for data wrangling, visualization, and exploratory data analysis.</p>
<p>When you discover the peaks and valleys, trends and seasonality, and changing landscapes in your data set, what then? Are they real or illusory? Are they important? Chapters 3–6 will give you the inferential and modeling skills required to answer these questions.</p>
<section id="sec-STdata" class="level2" data-number="2.1">
<h2 data-number="2.1" class="anchored" data-anchor-id="sec-STdata"><span class="header-section-number">2.1</span> Spatio-Temporal Data</h2>
<p>Time-series analysts consider univariate or multivariate sequential data as a random process observed at regular or irregular intervals, where the process can be defined in continuous time, discrete time, or where the temporal event is itself the random event (i.e., a <em>point process</em>). Spatial statisticians consider spatial data as either temporal aggregations or tem-por-ally frozen states (“snapshots”) of a spatio-temporal process. Spatial data are traditionally thought of as random according to either <em>geostatistical</em>, <em>areal</em> or <em>lattice</em>, or <em>point process</em> (and sometimes <em>random set</em>) behavior. We think of geostatistical data as the kind where we could have observations of some variable or variables of interest (e.g., temperature and wind speed) at continuous locations over a given spatial domain, and where we seek to predict those variables at unknown locations in space (e.g., using interpolation methodology such as <em>kriging</em>). Lattice processes are defined on a finite or countable subset in space (e.g., grid nodes, pixels, polygons, small areas), such as the process defined by work-force indicators on a specific political geography (e.g., counties in the USA) over a specific period of time. A spatial point process is a stochastic process in which the locations of the points (sometimes called <em>events</em>) are random over the spatial domain, where these events can have attributes given in terms of <em>marks</em> (e.g., locations of trees in a forest are random events, with the diameter at breast height being the mark). Given the proliferation of various data sources and geographical information system (GIS) software, it is important to broaden the perspective of spatial data to include not only points and polygons, but also <em>lines</em>, <em>trajectories</em>, and <em>objects</em>. It is also important to note that there can be significant differences in the abundance of spatial information versus temporal information.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p>Space-time data are usually provided in comma-separated value (CSV) files, which can be read into <code>R</code> using <code>read.csv</code> or <code>read.table</code>; shapefiles, which can be read into <code>R</code> using functions from <strong>rgdal</strong> and <strong>maptools</strong>; NetCDF files, which can be read into <code>R</code> using a variety of packages, such as <strong>ncdf4</strong> and <strong>RNetCDF</strong>; and HDF5 files, which can be read into <code>R</code> using the package <strong>h5</strong>.</p>
</div>
</div>
<p>It should not be surprising that data from spatio-temporal processes can be considered from either a time-series perspective or a spatial-random-process perspective, as described in the previous paragraph. In this book, we shall primarily consider spatio-temporal data that can be described by processes that are discrete in time and either geostatistical or on a lattice in space. For a discussion of a broader collection of spatio-temporal processes, see <span class="citation" data-cites="cressie2011statistics">Cressie &amp; Wikle (<a href="references.html#ref-cressie2011statistics" role="doc-biblioref">2011</a>)</span>, particularly Chapters 5–9.</p>
<p>Throughout this book, we consider the following data sets:</p>
<ul>
<li><em>NOAA daily weather data</em>. These daily data originated from the US National Oceanic and Atmospheric Administration (NOAA) National Climatic Data Center and can be obtained from the IRI/LDEO Climate Data Library at Columbia University (available at <a href="http://iridl.ldeo.columbia.edu/SOURCES/.NOAA/.NCDC/.DAILY/.FSOD/">http://iridl.ldeo.columbia.edu/SOURCES/.NOAA/.NCDC/.DAILY/.FSOD/</a>). The data set we consider consists of four variables: daily maximum temperature (<code>Tmax</code>) in degrees Fahrenheit (<span class="math inline">\(^\circ\)</span>F), minimum temperature (<code>Tmin</code>) in <span class="math inline">\(^\circ\)</span>F, dew point temperature (<code>TDP</code>) in <span class="math inline">\(^\circ\)</span>F, and precipitation (<code>Precip</code>) in inches at 138 weather stations in the central USA (between 32<span class="math inline">\(^\circ\)</span>N–46<span class="math inline">\(^\circ\)</span>N and 80<span class="math inline">\(^\circ\)</span>W–100<span class="math inline">\(^\circ\)</span>W), recorded between the years 1990 and 1993 (inclusive). These data are considered to be discrete and regular in time (daily) and geostatistical and irregular in space. However, the data are not complete, in that there are missing measurements at various stations and at various time points, and the stations themselves are obviously not located everywhere in the central USA. We will refer to these data as the “NOAA data set.” Three days of <code>Tmax</code> measurements from the NOAA data set are shown in <a href="#fig-NOAA" class="quarto-xref">Figure&nbsp;<span>2.1</span></a>.</li>
</ul>
<div id="fig-NOAA" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-NOAA-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="img/Chapter_2/NOAA3.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-NOAA-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;2.1: Maximum temperature (<code>Tmax</code>) in <span class="math inline">\(^\circ\)</span>F from the NOAA data set on 01, 15, and 30 May 1993.
</figcaption>
</figure>
</div>
<ul>
<li><em>Sea-surface temperature anomalies</em>. These sea-surface temperature (SST) anomaly data are from the NOAA Climate Prediction Center as obtained from the IRI/LDEO Climate Data Library at Columbia University (available at <a href="http://iridl.ldeo.columbia.edu/SOURCES/.CAC/">http://iridl.ldeo.columbia.edu/SOURCES/.CAC/</a>). The data are gridded at a 2<span class="math inline">\(^\circ\)</span> by 2<span class="math inline">\(^\circ\)</span> resolution from 124<span class="math inline">\(^\circ\)</span>E–70<span class="math inline">\(^\circ\)</span>W and 30<span class="math inline">\(^\circ\)</span>S–30<span class="math inline">\(^\circ\)</span>N, and they represent monthly anomalies from a January 1970–December 2003 climatology (averaged over time). We refer to this data set as the “SST data set.” Three individual months from the SST data set are shown in <a href="#fig-SST" class="quarto-xref">Figure&nbsp;<span>2.2</span></a>.</li>
</ul>
<div id="fig-SST" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-SST-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="img/Chapter_2/SST3.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-SST-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;2.2: Sea-surface temperature anomalies in <span class="math inline">\(^\circ\)</span>C for the month of January in the years 1989, 1993, and 1998. The year 1989 experienced a La Niña event (colder than normal temperatures) while the year 1998 experienced an El Niño event (warmer than normal temperatures).
</figcaption>
</figure>
</div>
<ul>
<li><em>Breeding Bird Survey (BBS) counts</em>. These data are from the North American Breeding Bird Survey (available at <a href="https://www.pwrc.usgs.gov/bbs/RawData/">https://www.pwrc.usgs.gov/bbs/RawData/</a>). Note that we used the archived 2016.0 version of the data set, doi: 10.5066/F7W0944J, which is accessible through the data archive link on the BBS website <a href="ftp://ftpext.usgs.gov/pub/er/md/laurel/BBS/Archivefiles/Version2016v0/">ftp://ftpext.usgs.gov/pub/er/md/laurel/BBS/Archivefiles/Version2016v0/</a>). In particular, we consider yearly counts of the house finch (<em>Carpodacus mexicanus</em>) at BBS routes for the period 1966–2000 and the Carolina wren (<em>Thryothorus ludovicianus</em>) for the period 1967–2014. The BBS sampling unit is a roadside route of length approximately 39.2 km. In each sampling unit, volunteer observers make 50 stops and count birds for a period of 3 minutes when they run their routes (typically in June). There are over 4000 routes in the North American survey, but not all routes are available every year. For the purposes of the analyses in this book, we consider the total route counts to occur yearly (during the breeding season) and define the spatial location of each route to be the route’s centroid. Thus, we consider the data to be discrete in time, geostatistical and irregular in space, and non-Gaussian in the sense that they are counts. We refer to this data set as the “BBS data set.” Counts of house finches for the period 1980–1999 are shown in <a href="#fig-BBS" class="quarto-xref">Figure&nbsp;<span>2.3</span></a>.</li>
</ul>
<div id="fig-BBS" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-BBS-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="img/Chapter_2/BBSplot.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-BBS-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;2.3: Counts of house finches between 1980 and 1999. The size of the points is proportional to the number of observed birds, while transparency is used to draw attention to regions of high sampling density or high observed counts.
</figcaption>
</figure>
</div>
<ul>
<li><em>Per capita personal income</em>. We consider yearly per capita personal income (in dollars) data from the US Bureau of Economic Analysis (BEA) (available at <a href="http://www.bea.gov/regional/downloadzip.cfm">http://www.bea.gov/regional/downloadzip.cfm</a>). These data have areal spatial support corresponding to USA counties in the state of Missouri, and they cover the period 1969–2014. We refer to this data set as the “BEA income data set.” <a href="#fig-BEA" class="quarto-xref">Figure&nbsp;<span>2.4</span></a> shows these data, on a log scale, for the individual years 1970, 1980, and 1990; note that these data have been adjusted for inflation.</li>
</ul>
<div id="fig-BEA" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-BEA-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="img/Chapter_2/BEAplot.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-BEA-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;2.4: Per capita personal income (in dollars) by county for residents in Missouri in the years 1970, 1980, and 1990, plotted on a log scale. The data have been adjusted for inflation. Note how both the overall level of income as well as the spatial variation change with time.
</figcaption>
</figure>
</div>
<ul>
<li><em>Sydney radar reflectivity</em>. These data are a subset of consecutive weather radar reflectivity images considered in the World Weather Research Programme (WWRP) Sydney 2000 Forecast Demonstration Project. There are 12 images at 10-minute intervals starting at 08:25 UTC on 03 November, 2000 (i.e., 08:25–10:15 UTC). The data were originally mapped to a <span class="math inline">\(45 \times 45\)</span> grid of 2.5 km pixels centered on the radar location. The data used in this book are for a region of dimension <span class="math inline">\(28 \times 40\)</span>, corresponding to a 70 km by 100 km domain. All reflectivities are given in “decibels relative to Z” (dBZ, a dimensionless logarithmic unit used for weather radar reflectivities). We refer to this data set as the “Sydney radar data set.” For more details on these data, shown in <a href="#fig-RadarData" class="quarto-xref">Figure&nbsp;<span>2.5</span></a>, see <span class="citation" data-cites="xu2005kernel">Xu et al. (<a href="references.html#ref-xu2005kernel" role="doc-biblioref">2005</a>)</span>.</li>
</ul>
<div id="fig-RadarData" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-RadarData-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="img/Chapter_2/radar_data.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-RadarData-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;2.5: Weather radar reflectivities in dBZ for Sydney, Australia, on 03 November 2000. The images correspond to consecutive 10-minute time intervals from 08:25 UTC to 10:15 UTC.
</figcaption>
</figure>
</div>
<ul>
<li><em>Mediterranean winds</em>. These data are east–west (<span class="math inline">\(u\)</span>) and north–south (<span class="math inline">\(v\)</span>) wind-component observations over the Mediterranean region (from 6.5<span class="math inline">\(^\circ\)</span>W–16.5<span class="math inline">\(^\circ\)</span>E and 33.5<span class="math inline">\(^\circ\)</span>N–45.5<span class="math inline">\(^\circ\)</span>N) for 28 time periods (every 6 hours) from 00:00 UTC on 29 January 2005 to 18:00 UTC on 04 February 2005. There are two data sources: satellite wind observations from the QuikSCAT scatterometer, and surface winds and pressures from an analysis by the European Center for Medium Range Weather Forecasting (ECMWF). The ECMWF-analysis winds and pressures are given on a <span class="math inline">\(0.5^\circ \times 0.5^\circ\)</span> spatial grid (corresponding to 47 longitude locations and 25 latitude locations), and they are available at each time period for all locations. The QuikSCAT observations are only available intermittently in space, due to the polar orbit of the satellite, but at much higher spatial resolution (25 km) than the ECMWF data when they are available. The QuikSCAT observations given for each time period correspond to all observations available in the spatial domain within 3 hours of time periods stated above. There are no QuikSCAT observations available at 00:00 UTC and 12:00 UTC in the spatial domain and time periods considered here. We refer to this data set as the “Mediterranean winds data set.” <a href="#fig-Medwinds_quiv" class="quarto-xref">Figure&nbsp;<span>2.6</span></a> shows the wind vectors (“quivers”) for the ECMWF data at 06:00 UTC on 01 February 2005. These data are a subset of the data described in <span class="citation" data-cites="cressie2011statistics">Cressie &amp; Wikle (<a href="references.html#ref-cressie2011statistics" role="doc-biblioref">2011</a>)</span> and <span class="citation" data-cites="milliff2011ocean">Milliff et al. (<a href="references.html#ref-milliff2011ocean" role="doc-biblioref">2011</a>)</span>.</li>
</ul>
<div id="fig-Medwinds_quiv" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-Medwinds_quiv-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="img/Chapter_2/Med_winds_time14e_quivB.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-Medwinds_quiv-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;2.6: ECMWF wind vector observations over the Mediterranean region for 06:00 UTC on 01 February 2005.
</figcaption>
</figure>
</div>
</section>
<section id="sec-STdatainR" class="level2" data-number="2.2">
<h2 data-number="2.2" class="anchored" data-anchor-id="sec-STdatainR"><span class="header-section-number">2.2</span> Representation of Spatio-Temporal Data in <code>R</code></h2>
<p>Although there are many ways to represent spatial data and time-series data in <code>R</code>, there are relatively few ways to represent spatio-temporal data. In this book we use the class definitions defined in the <code>R</code> package <strong>spacetime</strong>. These classes extend those used for spatial data in <strong>sp</strong> and time-series data in <strong>xts</strong>. For details, we refer the interested reader to the package documentation and vignettes in <span class="citation" data-cites="R_spacetime">Pebesma (<a href="references.html#ref-R_spacetime" role="doc-biblioref">2012</a>)</span>. Here, we just provide a brief introduction to some of the concepts that facilitate thinking about spatio-temporal data structures.</p>
<p>Although spatio-temporal data can come in quite sophisticated relational forms, they most often come in the form of fairly simple “tables.” <span class="citation" data-cites="R_spacetime">Pebesma (<a href="references.html#ref-R_spacetime" role="doc-biblioref">2012</a>)</span> classifies these simple tables into three classes:</p>
<ul>
<li><em>time-wide</em>, where columns correspond to different time points;</li>
<li><em>space-wide</em>, where columns correspond to different spatial features (e.g., locations, regions, grid points, pixels);</li>
<li><em>long formats</em>, where each record corresponds to a specific time and space coordinate.</li>
</ul>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p>Data in long format are space inefficient, as spatial coordinates and time attributes are required for each data point, whether or not data are on a lattice. However, it is easy to subset and manipulate data in long format. Powerful “data wrangling” tools in packages such as <strong>dplyr</strong> and <strong>tidyr</strong>, and visualization tools in <strong>ggplot2</strong>, are designed for data in long format.</p>
</div>
</div>
<p>Tables are very useful elementary data objects. However, an object from the <strong>spacetime</strong> package contains additional information, such as the map projection and the time zone. Polygon objects may further contain the individual areas of the polygons as well as the individual bounding boxes. These objects have elaborate, but consistent, class definitions that greatly aid the geographical (e.g., spatial) component of the analysis.</p>
<p><span class="citation" data-cites="R_spacetime">Pebesma (<a href="references.html#ref-R_spacetime" role="doc-biblioref">2012</a>)</span> considers four classes of space-time data: </p>
<ul>
<li><em>full grid</em> (<code>STF</code>), a combination of any <strong>sp</strong> object and any <strong>xts</strong> object to represent all possible locations on the implied space-time lattice;</li>
<li><em>sparse grid</em> (<code>STS</code>), as <code>STF</code>, but contains only the non-missing space-time combinations on a space-time lattice;</li>
<li><em>irregular</em> (<code>STI</code>), an irregular space-time data structure, where each point is allocated a spatial coordinate and a time stamp;</li>
<li><em>simple trajectories</em> (<code>STT</code>), a sequence of space-time points that form trajectories.</li>
</ul>
<p>Note that the “grid” in the first two classes corresponds to a <em>space-time lattice</em> — but the spatial locations may or may not be on a lattice! The sparse grid is most effective when there are missing observations, or when there are a relatively few spatial locations that have different time stamps, or when there are a relatively small number of times that have differing spatial locations.</p>
<p>It is important to note that the class objects that make up the <strong>spacetime</strong> package are not used to store data; this is accomplished through the use of the <code>R</code> data frame. As illustrated in Lab 2.1 at the end of this chapter and in <span class="citation" data-cites="R_spacetime">Pebesma (<a href="references.html#ref-R_spacetime" role="doc-biblioref">2012</a>)</span>, there are several important methods in <strong>sp</strong> and <strong>spacetime</strong> that help with the construction and manipulation of these spatio-temporal data sets. In particular, there are methods to construct an object, replace/select data or various spatial or temporal subsets, coerce spatio-temporal objects to other classes, overlay spatio-temporal observations, and aggregate over space, time, or space-time.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p>When spatio-temporal data have non-trivial support (i.e., a spatio-temporal region over which a datum is defined), and if the geometry allows it, use <strong>SpatialPixels</strong> and not <strong>SpatialPolygons</strong> as the underlying <strong>sp</strong> object. This results in faster geometric manipulations such as when finding the overlap between points and polygons using the function <code>over</code>.</p>
</div>
</div>
</section>
<section id="visualization-of-spatio-temporal-data" class="level2" data-number="2.3">
<h2 data-number="2.3" class="anchored" data-anchor-id="visualization-of-spatio-temporal-data"><span class="header-section-number">2.3</span> Visualization of Spatio-Temporal Data</h2>
<p>A picture – or a video – can be worth a thousand tables. Use of maps, color, and animation is a very powerful way to provide insight that suggests exploratory data analysis that then leads to spatio-temporal models (Chapters 3–5). Although there are distinct challenges in visualizing spatio-temporal data due to the fact that several dimensions often have to be considered simultaneously (e.g., two or three spatial dimensions and time), there are some fairly common tools that can help explore such data visually. For the most part, we are somewhat selective in what we present here as we want to convey fairly simple methods that have consistently proven useful in our own work and in the broader literature. These can be as simple as static spatial maps and time-series plots, or they can be interactive explorations of the data <span class="citation" data-cites="lamigueiro2018displaying">(<a href="references.html#ref-lamigueiro2018displaying" role="doc-biblioref">Lamigueiro, 2018</a>)</span>. In addition, because of the special dynamic component of many spatio-temporal processes, where spatial processes evolve through time, it is often quite useful to try to visualize this evolution. This can be done in the context of one-dimensional space through a space-time (<em>Hovmöller</em>) plot, or more generally through <em>animations</em>. We conclude by discussing an increasingly popular approach to help with visualization of very high-dimensional data.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p>Spatio-temporal visualization in <code>R</code> generally proceeds using one of two methods: the trellis graph or the grammar of graphics. The command <code>plot</code> invokes the trellis graph when <strong>sp</strong> or <strong>spacetime</strong> objects are supplied as arguments. The commands associated with the package <strong>ggplot2</strong> invoke the grammar of graphics. The data objects frequently need to be converted into a data frame in long format for use with <strong>ggplot2</strong>, which we often use throughout this book.</p>
</div>
</div>
<section id="spatial-plots" class="level3" data-number="2.3.1">
<h3 data-number="2.3.1" class="anchored" data-anchor-id="spatial-plots"><span class="header-section-number">2.3.1</span> Spatial Plots</h3>
<p>Snapshots of spatial processes for a given time period can be plotted in numerous ways. If the observations are irregular in space, then it is often useful to plot a symbol at the data location and give it a different color and/or size to reflect the value of the observation. For example, consider <code>Tmax</code> for 01 May 1993 from the NOAA data set plotted in the left panel of <a href="#fig-NOAA" class="quarto-xref">Figure&nbsp;<span>2.1</span></a>. In this case, the circle center corresponds to the measurement location and the color of the filled-in circle corresponds to the value of the maximum temperature. Notice the clear visual trend of decreasing temperatures from the southeast to the northwest over this region of the USA.</p>
<p>Spatial plots of gridded data are often presented as contour plots, so-called “image” plots, or surface plots. For example, <a href="#fig-SST" class="quarto-xref">Figure&nbsp;<span>2.2</span></a> shows image representations for three individual months of the Pacific SST data set. Note the La Niña signal (cooler than normal SSTs) in 1989 and the El Niño signal (warmer than normal SSTs) in 1998 in the tropical Pacific Ocean. <a href="#fig-SST1b" class="quarto-xref">Figure&nbsp;<span>2.7</span></a> shows contour and surface representations of the SST anomalies in January 1998, corresponding to the right panel (i.e., the El Niño event) in <a href="#fig-SST" class="quarto-xref">Figure&nbsp;<span>2.2</span></a>.</p>
<p>It is often useful to plot a sequence of spatial maps for consecutive times to gain greater insight into the <em>changes in</em> spatial patterns through time. <a href="#fig-SST2" class="quarto-xref">Figure&nbsp;<span>2.8</span></a> shows a sequence of SST spatial maps for the months January–June 1989. Note how the initially strong La Niña event dissipates by June 1989.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p>Multiple time-indexed spatial maps can be plotted from one long-format table using the functions <code>facet_grid</code> or <code>facet_wrap</code> in <strong>ggplot2</strong> with time as a grouping variable.</p>
</div>
</div>
<div id="fig-SST1b" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-SST1b-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="img/Chapter_2/SST3c.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-SST1b-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;2.7: Sea-surface temperature anomalies (in <span class="math inline">\(^\circ\)</span>C) for January 1998 as a contour plot (top) and as a surface plot (bottom).
</figcaption>
</figure>
</div>
<div id="fig-SST2" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-SST2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="img/Chapter_2/SST6.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-SST2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;2.8: Sea-surface temperature anomalies (in <span class="math inline">\(^\circ\)</span>C) for January–June 1989.
</figcaption>
</figure>
</div>
</section>
<section id="time-series-plots" class="level3" data-number="2.3.2">
<h3 data-number="2.3.2" class="anchored" data-anchor-id="time-series-plots"><span class="header-section-number">2.3.2</span> Time-Series Plots</h3>
<p>It can be instructive to plot time series corresponding to an observation location, an aggregation of observations, or multiple locations simultaneously. For example, <a href="#fig-TmaxTS" class="quarto-xref">Figure&nbsp;<span>2.9</span></a> shows time-series plots of daily <code>Tmax</code> for 10 of the NOAA stations (chosen randomly from the 139 stations) for the time period 01 May 1993–30 September 1993. The time-series plots are quite noisy, as is to be expected from the variability inherent in mid-latitude weather systems. However, there is an overall temporal trend corresponding to the annual seasonal cycle. That is, all of the time series appear to peak somewhat towards the center of the time horizon, which corresponds to the month of July. In this case, since we are using only five months of data, this trend appears to be roughly quadratic in time. Periodic functions are often used when considering a whole year or multiple years of data, especially with weather and economic data. Although all of these temperature series contain a seasonal component, some appear shifted on the vertical axis (<code>Tmax</code>) relative to one another (e.g., station 13881 has higher temperatures than station 14897). This is due to the latitudinal trend apparent in <a href="#fig-NOAA" class="quarto-xref">Figure&nbsp;<span>2.1</span></a>.</p>
<div id="fig-TmaxTS" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-TmaxTS-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="img/Chapter_2/TmaxTS.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-TmaxTS-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;2.9: Maximum temperature (<span class="math inline">\(^\circ\)</span>F) for ten stations chosen from the NOAA data set at random, as a function of the day number, with the first day denoting 01 May 1993 and the last day denoting 30 September 1993. The number in the grey heading of each plot denotes the station ID.
</figcaption>
</figure>
</div>
</section>
<section id="sec-Hovplot" class="level3" data-number="2.3.3">
<h3 data-number="2.3.3" class="anchored" data-anchor-id="sec-Hovplot"><span class="header-section-number">2.3.3</span> Hovmöller Plots</h3>
<p>A Hovmöller plot <span class="citation" data-cites="hovmoller1949trough">Hovmöller (<a href="references.html#ref-hovmoller1949trough" role="doc-biblioref">1949</a>)</span> is a two-dimensional space-time visualization in which space is collapsed (projected or averaged) onto one dimension and where the second dimension denotes time. These plots have traditionally been considered in the atmospheric-science and ocean-science communities to visualize propagating features. For example, the left panel of <a href="#fig-Hovmoller_SST" class="quarto-xref">Figure&nbsp;<span>2.10</span></a> shows monthly SST anomalies averaged from <span class="math inline">\(1^\circ\)</span>S–<span class="math inline">\(1^\circ\)</span>N and plotted such that longitude (over the Pacific Ocean) is on the <span class="math inline">\(x\)</span>-axis and time (from 1996 to 2003) is on the <span class="math inline">\(y\)</span>-axis (increasing from top to bottom). The darker red colors correspond to warmer than normal temperatures (i.e., El Niño events) and the darker blue colors correspond to colder than normal temperatures (i.e., La Niña events). Propagation through time is evident if a coherent color feature is “slanted.” In this plot, one can see several cases of propagating features along the longitudinal axis (e.g., both of the major La Niña events show propagation from the eastern longitudes towards the western longitudes).</p>
<p>Hovmöller plots are straightforward to generate with regular spatio-temporal data, but they can also be generated for irregular spatio-temporal data after suitable interpolation to a regular space-time grid. For example, in <a href="#fig-Hovmoller_NOAA" class="quarto-xref">Figure&nbsp;<span>2.11</span></a>, we show Hovmöller plots for the <code>Tmax</code> variable in the NOAA data set between 01 May 1993 and 30 September 1993. We see that the temporal trend is fairly constant with <em>longitude</em> (left panel), but it decreases considerably with increasing <em>latitude</em> (right panel) as expected, since overall maximum temperature decreases with increasing latitude in the conterminous USA. Such displays may affect modeling decisions of the trend (e.g., a time–latitude interaction might become evident in such plots).</p>
<div id="fig-Hovmoller_SST" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-Hovmoller_SST-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="img/Chapter_2/SST_Hovmoller.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-Hovmoller_SST-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;2.10: Hovmöller plots for both the longitude (left) and latitude (right) coordinates for the SST data set. The color denotes the temperature anomaly in <span class="math inline">\(^\circ\)</span>C.
</figcaption>
</figure>
</div>
<div id="fig-Hovmoller_NOAA" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-Hovmoller_NOAA-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="img/Chapter_2/NOAA_Hovmoller.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-Hovmoller_NOAA-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;2.11: Hovmöller plots for both the longitude (left) and latitude (right) coordinates for the <code>Tmax</code> variable in the NOAA data set between 01 May 1993 and 30 September 1993, where the data are interpolated as described in Lab 2.2. The color denotes the maximum temperature in <span class="math inline">\(^\circ\)</span>F. The dashed lines correspond to the longitude and latitude coordinates of station 13966 (compare to <a href="#fig-TmaxTS" class="quarto-xref">Figure&nbsp;<span>2.9</span></a>).
</figcaption>
</figure>
</div>
</section>
<section id="interactive-plots" class="level3" data-number="2.3.4">
<h3 data-number="2.3.4" class="anchored" data-anchor-id="interactive-plots"><span class="header-section-number">2.3.4</span> Interactive Plots</h3>
<p>Programming tools for interactive visualization are becoming increasingly accessible. These tools typically allow for a more data-immersive experience, and they allow one to explore the data without having to resort to scripting. In the simplest of cases, one can “hover” a cursor over a figure, and some information related to the data corresponding to the current location of the cursor is conveyed to the user. For example, in <a href="#fig-interactive" class="quarto-xref">Figure&nbsp;<span>2.12</span></a> we show the interaction of the user with a spatial plot of SST using the package <strong>plotly</strong>. This package works in combination with a web portal for more advanced exploration methods (e.g., the exploration of three-dimensional data).</p>
<p>There are several interactive plots that may aid with the visualization of spatio-temporal data. One of the most useful plots builds on <em>linked brushing</em>, with the link acting between time and space. Here, one hovers a cursor over a spatial observation or highlights a spatial area, and then the time series corresponding to that point or area is visualized; see <a href="#fig-interactive" class="quarto-xref">Figure&nbsp;<span>2.12</span></a>. This allows one to explore the time series corresponding to known geographic areas with minimal effort. Code for generating a linked brush is available from the book’s website (<a href="https://spacetimewithr.org">https://spacetimewithr.org</a>).</p>
<div id="fig-interactive" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-interactive-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="img/Chapter_2/ggplotly_screenshot2.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-interactive-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;2.12: Interactively exploring maximum temperatures on 01 May 1993 using the NOAA data set. The “hover” feature can be added to <strong>ggplot2</strong> objects by using <code>ggplotly</code> from the package <strong>plotly</strong> (left). A linked brush can be used to explore the time series (right) corresponding to a user-chosen set of spatial locations (middle) with the package <strong>ggvis</strong>.
</figcaption>
</figure>
</div>
</section>
<section id="animations" class="level3" data-number="2.3.5">
<h3 data-number="2.3.5" class="anchored" data-anchor-id="animations"><span class="header-section-number">2.3.5</span> Animations</h3>
<p>Everyone loves a movie. Animation captures our attention and can suggest structure in a way that a sequence of still frames cannot. Good movies should be watched again and again for understanding why the spatio-temporal data behave the way they do.</p>
<p>An animation is typically constructed by plotting spatial data frame-by-frame, and then stringing them together in sequence. When doing so, it is important to ensure that all spatial axes and color scales remain constant across all frames. In situations with missing or unequally spaced observations, one may sometimes improve the utility of an animation by performing a simple interpolation (in space and/or time) before constructing the sequence. Animations in <code>R</code> can be conveniently produced using the package <strong>animation</strong>. We provide an example using this package in Lab 2.2.</p>
</section>
<section id="trelliscope-visualizing-large-spatio-temporal-data-sets" class="level3" data-number="2.3.6">
<h3 data-number="2.3.6" class="anchored" data-anchor-id="trelliscope-visualizing-large-spatio-temporal-data-sets"><span class="header-section-number">2.3.6</span> Trelliscope: Visualizing Large Spatio-Temporal Data Sets</h3>
<p>Most spatio-temporal statistical analyses to date have been carried out on manageable data sets that can fit into a computer’s memory which, at the time of writing, was in the order of a few tens or a couple of hundreds of gigabytes in size. Being able to visualize these data is important and useful in many respects. Proceeding with modeling and prediction where not all the data can be processed in a single place (known as parallel-data algorithms) is an active area of research and will not be discussed here.</p>
<p>The Trelliscope system, available with the package <strong>trelliscope</strong>, helps users visualize massive data sets. The first advantage of <strong>trelliscope</strong> is that it facilitates exploration when, due to their size, the data may only be visualized using hundreds or thousands of plots (or panels). The Trelliscope system can calculate subset summaries (known as <em>cognostics</em>) that are then used for filtering and sorting the panels. For example, consider the SST data set. If a grouping is made by month, then there are over 300 spatial maps that can be visualized between, say, 1970 and 2003. Alternatively, one may decide to visualize only those months in which the SST exceeded a certain maximum or minimum threshold. One can formulate a cognostic using the monthly spatial mean values of SST averaged over their spatial domain and visualize them in a quantile plot (see <a href="#fig-Trelliscope" class="quarto-xref">Figure&nbsp;<span>2.13</span></a>). The analyst can use this approach to quickly view the strongest El Niño and La Niña events in this time period.</p>
<p>The second advantage is that the <strong>trelliscope</strong> package is designed to visualize data that are on a distributed file system that may be residing on more than one node. The data are processed in a <em>divide and recombine</em> fashion; that is, the data are divided and processed by group in parallel fashion and then recombined. In <strong>trelliscope</strong>, this can be useful for generating both the cognostics and the viewing panels efficiently. Therefore, the Trelliscope system provides a way to visualize terabytes of space-time data but, as quoted in its package manual, it “can also be very useful for small data sets.”</p>
<div id="fig-Trelliscope" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-Trelliscope-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="img/Chapter_2/Trelliscope_SST.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-Trelliscope-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;2.13: Exploring a large spatio-temporal data set with Trelliscope. Quantile plot of monthly averages of sea-surface temperature from the SST data set; the insets are what would be displayed if the user highlighted the circle points, corresponding to El Niño and La Niña events.
</figcaption>
</figure>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p>Processing and visualizing large data sets residing on a distributed file system using divide and recombine may seem like a daunting task. The <code>R</code> package <strong>datadr</strong>, which can be used together with <strong>trelliscope</strong>, provides an easy-to-use front-end for data residing on distributed file systems. More importantly, it reduces the barrier to entry by allowing the same, or very similar, code to be used for data residing in memory and data residing on a distributed file system such as Hadoop.</p>
</div>
</div>
</section>
<section id="visualizing-uncertainty" class="level3" data-number="2.3.7">
<h3 data-number="2.3.7" class="anchored" data-anchor-id="visualizing-uncertainty"><span class="header-section-number">2.3.7</span> Visualizing Uncertainty</h3>
<p>One of the main things that separates statistics from other areas of data science is the focus on uncertainty quantification. Uncertainties could be associated with data (e.g., measurement error in satellite observations or sampling error in a survey), estimates (e.g., uncertainty in regression parameter estimates), or predictions (e.g., uncertainties in a forecast of SST anomalies). Taking a Bayesian point of view, uncertainties could also be associated with the parameters themselves. In the case where these uncertainties are indexed in time, space, or space-time, one can use any of the methods discussed in this section to produce visualizations of these uncertainties. It is increasingly the case that one seeks methods to visualize both the values of interest and their uncertainty simultaneously. This is challenging given the difficulties in visualizing information in multiple dimensions, and it is an active area of research both in geography and statistics (see, for example, the discussion of “visuanimation” in <span class="citation" data-cites="genton2015visuanimation">Genton et al. (<a href="references.html#ref-genton2015visuanimation" role="doc-biblioref">2015</a>)</span>). For a recent overview in the case of areal data, and an accompanying <code>R</code> vignette, see <span class="citation" data-cites="lucchesi2017visualizing">Lucchesi &amp; Wikle (<a href="references.html#ref-lucchesi2017visualizing" role="doc-biblioref">2017</a>)</span> and the <code>R</code> package <strong>Vizumap</strong> (<a href="https://doi.org/10.5281/zenodo.1479951">https://doi.org/10.5281/zenodo.1479951</a>).</p>
</section>
</section>
<section id="exploratory-analysis-of-spatio-temporal-data" class="level2" data-number="2.4">
<h2 data-number="2.4" class="anchored" data-anchor-id="exploratory-analysis-of-spatio-temporal-data"><span class="header-section-number">2.4</span> Exploratory Analysis of Spatio-Temporal Data</h2>
<p>Visualization of data is certainly an important and necessary component of exploratory data analysis. In addition, we often wish to explore spatio-temporal data in terms of summaries of first-order and second-order characteristics. Here we consider visualizations of empirical means and empirical covariances, spatio-temporal covariograms and semivariograms, the use of empirical orthogonal functions and their associated principal-component time series, and spatio-temporal canonical correlation analysis. To do this, we have to start using some mathematical symbols and formulas. Mathematics is the language of science (and of statistical science), and we introduce this language along the way to help readers who are a bit less fluent. For reference, we present some fundamental definitions of vectors and matrices and their manipulation in <a href="ChapterAppendixA.html" class="quarto-xref"><span>Appendix A</span></a>. Readers who are not familiar with the symbols and basic manipulation of vectors and matrices would benefit from looking at this material before proceeding.</p>
<section id="empirical-spatial-means-and-covariances" class="level3" data-number="2.4.1">
<h3 data-number="2.4.1" class="anchored" data-anchor-id="empirical-spatial-means-and-covariances"><span class="header-section-number">2.4.1</span> Empirical Spatial Means and Covariances</h3>
<p>It can be useful to explore spatio-temporal data by examining the empirical means and empirical covariances. Assume for the moment that we have observations <span class="math inline">\(\{Z(\mathbf{s}_i;t_j)\}\)</span> for spatial locations <span class="math inline">\(\{\mathbf{s}_i: i=1,\ldots,m\}\)</span> and times <span class="math inline">\(\{t_j: j=1,\ldots,T\}\)</span>.</p>
<p>The empirical spatial mean for location <span class="math inline">\(\mathbf{s}_i\)</span>, <span class="math inline">\(\widehat{\mu}_{z,s}(\mathbf{s}_i)\)</span>, is then found by averaging over time:</p>
<p><span class="math display">\[
\widehat{\mu}_{z,s}(\mathbf{s}_i) \equiv \frac{1}{T} \sum_{j=1}^T Z(\mathbf{s}_i;t_j).
\]</span></p>
<p>If we consider the means for all spatial data locations and assume that we have <span class="math inline">\(T\)</span> observations at each location, then we can write down the spatial mean as an <span class="math inline">\(m\)</span>-dimensional vector, <span class="math inline">\(\widehat{\boldsymbol{\mu}}_{z,s}\)</span>, where</p>
<p><span id="eq-Zmean"><span class="math display">\[
\widehat{\boldsymbol{\mu}}_{z,s} \equiv  
\left[\begin{array}{c}
\widehat{\mu}_{z,s}(\mathbf{s}_1) \\
\vdots \\
\widehat{\mu}_{z,s}(\mathbf{s}_m)
\end{array} \right] =
\begin{bmatrix}
\displaystyle\frac{1}{T}\sum_{j=1}^T Z(\mathbf{s}_1;t_j) \\
\vdots \\
\displaystyle\frac{1}{T}\sum_{j=1}^T Z(\mathbf{s}_m;t_j)
\end{bmatrix} =
\frac{1}{T}\sum_{j=1}^T\mathbf{Z}_{t_j},
\tag{2.1}\]</span></span></p>
<p>and <span class="math inline">\(\mathbf{Z}_{t_j} \equiv (Z(\mathbf{s}_1;t_j),\ldots, Z(\mathbf{s}_m;t_j))'\)</span>.</p>
<p>This mean vector is a spatial quantity whose elements are indexed by their location. Therefore, it can be plotted on a map, as in the case of the maximum temperature in the NOAA data set (see <a href="#fig-NOAA" class="quarto-xref">Figure&nbsp;<span>2.1</span></a>), or as a function of the spatial coordinates (e.g., longitude or latitude) as in <a href="#fig-NOAA_spat_means" class="quarto-xref">Figure&nbsp;<span>2.14</span></a>. From these plots one can see that there is a clear trend in the empirical spatial mean of maximum temperature with latitude, but not so much with longitude. Note that one may not have the same number of observations at each location to calculate the average, in which case each location in space must be calculated separately (e.g., <span class="math inline">\(\widehat{\mu}_{z,s}(\mathbf{s}_i) = (1/T_i) \sum_{j=1}^{T_i} Z(\mathbf{s}_i;t_j)\)</span>, where <span class="math inline">\(T_i\)</span> is the number of time points at which there are data at location <span class="math inline">\(\mathbf{s}_i\)</span>).</p>
<p>Additionally, one can average across space and plot the associated time series. The empirical temporal mean for time <span class="math inline">\(t_j\)</span>, <span class="math inline">\(\widehat{\mu}_{z,t}(t_j)\)</span>, is given by</p>
<p><span id="eq-Ztimemeanscalar"><span class="math display">\[
\widehat{\mu}_{z,t}(t_j) \equiv \frac{1}{m} \sum_{i=1}^m Z(\mathbf{s}_i;t_j).
\tag{2.2}\]</span></span></p>
<p>For example, <a href="#fig-NOAA_av" class="quarto-xref">Figure&nbsp;<span>2.15</span></a> shows the time series of <code>Tmax</code> for the NOAA temperature data set averaged across all of the spatial locations. This plot of the empirical temporal means shows the seasonal nature of the mid-latitude temperature over the central USA, but it also shows variations in that seasonal pattern due to specific large-scale weather systems.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p>Computing empirical means is quick and easy using functions in the package <strong>dplyr</strong>. For example, to find a temporal average, the data in a long-format data frame can first be grouped by spatial location using the function <code>group_by</code>. A mean can then be computed for every spatial location using the function <code>summarise</code>. See Lab 2.1 for more details on these functions.</p>
</div>
</div>
<div id="fig-NOAA_spat_means" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-NOAA_spat_means-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="img/Chapter_2/NOAA_spat_means.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-NOAA_spat_means-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;2.14: Empirical spatial mean, <span class="math inline">\(\widehat{\mu}_{z,s}(\cdot)\)</span>, of <code>Tmax</code> (in <span class="math inline">\(^\circ\)</span>F) as a function of station longitude (left) and station latitude (right).
</figcaption>
</figure>
</div>
<div id="fig-NOAA_av" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-NOAA_av-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="img/Chapter_2/NOAA_av.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-NOAA_av-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;2.15: <code>Tmax</code> data (in <span class="math inline">\(^\circ\)</span>F), from the NOAA data set (blue lines, where each blue line corresponds to a station) and the empirical temporal mean <span class="math inline">\(\widehat\mu_{z,t}(\cdot)\)</span> (black line), with <span class="math inline">\(t\)</span> in units of days, ranging from 01 May 1993 to 30 September 1993.
</figcaption>
</figure>
</div>
<p>It is often useful to consider the empirical spatial covariability in the spatio-temporal data set. This covariability can be used to determine to what extent data points in the data set covary (behave similarly) as a function of space and/or time.</p>
<p>In the context of the data described above, the empirical lag-<span class="math inline">\(\tau\)</span> covariance between spatial locations <span class="math inline">\(\mathbf{s}_i\)</span> and <span class="math inline">\(\mathbf{s}_k\)</span> is given by</p>
<p><span id="eq-czscalar"><span class="math display">\[
\widehat{C}_z^{(\tau)}(\mathbf{s}_i,\mathbf{s}_k) \equiv \frac{1}{T- \tau} \sum_{j=\tau + 1}^T (Z(\mathbf{s}_i;t_j) - \widehat{\mu}_{z,s}(\mathbf{s}_i)) (Z(\mathbf{s}_k;t_j - \tau)  - \widehat{\mu}_{z,s}(\mathbf{s}_k)),
\tag{2.3}\]</span></span></p>
<p>for <span class="math inline">\(\tau = 0,1,\ldots,T-1\)</span>, which is called the empirical lag-<span class="math inline">\(\tau\)</span> spatial covariance.</p>
<p>Note that this is the average (over time) of the cross products of the centered observations at the two locations (<span class="math inline">\(\mathbf{s}_i\)</span> and <span class="math inline">\(\mathbf{s}_k\)</span>); that is, it is a summary of the covariation of these data. It is often useful to consider the <span class="math inline">\(m \times m\)</span> lag-<span class="math inline">\(\tau\)</span> empirical spatial covariance matrix, <span class="math inline">\(\widehat{\mathbf{C}}_z^{(\tau)}\)</span>, where the <span class="math inline">\((i,k)\)</span>th element is given by the formula above. Alternatively, this can be calculated directly by</p>
<p><span id="eq-emp_cov"><span class="math display">\[
\widehat{\mathbf{C}}_z^{(\tau)} \equiv \frac{1}{T - \tau}\sum_{j= \tau + 1}^T(\mathbf{Z}_{t_j} - \widehat{\boldsymbol{\mu}}_{z,s})(\mathbf{Z}_{t_j-\tau} - \widehat{\boldsymbol{\mu}}_{z,s})';\quad \tau = 0,1,\dots,T-1.
\tag{2.4}\]</span></span></p>
<p>Thus, in order to find the lag-<span class="math inline">\(\tau\)</span> covariance matrices, we consider the cross products of the residual vectors for each spatial location and each time point relative to its corresponding time-averaged empirical spatial mean.</p>
<p>In general, it can be difficult to obtain any intuition from these matrices, since locations in a two-dimensional space do not have a natural ordering. However, one can sometimes gain insight by splitting the domain into “strips” corresponding to one of the spatial dimensions (e.g., longitudinal strips) and then plotting the associated covariance matrices for those strips. For example, <a href="#fig-emp_cov_plots" class="quarto-xref">Figure&nbsp;<span>2.16</span></a> shows empirical covariance matrices for the maximum temperature in the NOAA data set (after, as shown in Lab 2.3, a quadratic trend in time has been removed), split into four longitudinal strips. Not surprisingly, these empirical spatial covariance matrices reveal the presence of spatial dependence in the residuals. The lag-0 plots seem to be qualitatively similar, suggesting that there is no strong correlational dependence on longitude but that there is a correlational dependence on latitude, with the spatial covariance decreasing with decreasing latitude.</p>
<p>We can also calculate the empirical lag-<span class="math inline">\(\tau\)</span> cross-covariance matrix between two spatio-temporal data sets, <span class="math inline">\(\{\mathbf{Z}_{t_j}\}\)</span> and <span class="math inline">\(\{\mathbf{X}_{t_j}\}\)</span>, where <span class="math inline">\(\{\mathbf{X}_{t_j}\}\)</span> corresponds to data vectors at <span class="math inline">\(n\)</span> different locations (assumed to correspond to the same time points). We define this <span class="math inline">\(m \times n\)</span> matrix by</p>
<p><span id="eq-emp_crosscov"><span class="math display">\[
\widehat{\mathbf{C}}_{z,x}^{(\tau)} \equiv \frac{1}{T-\tau} \sum_{j=\tau+1}^T ({\mathbf{Z}}_{t_j} - \widehat{\boldsymbol{\mu}}_{z,s})({\mathbf{X}}_{t_j - \tau}  - \widehat{\boldsymbol{\mu}}_{x,s})',
\tag{2.5}\]</span></span></p>
<p>for <span class="math inline">\(\tau=0,1,\ldots,T-1\)</span>, where <span class="math inline">\(\widehat{\boldsymbol{\mu}}_{x,s}\)</span> is the empirical spatial mean vector for <span class="math inline">\(\{\mathbf{X}_{t_j}\}\)</span>. Cross-covariances may be useful in characterizing the spatio-temporal dependence relationship between two different variables, for example maximum temperature and minimum temperature.</p>
<p>Although not as common in spatio-temporal applications, one can also calculate empirical temporal covariance matrices averaging across space (after <em>removing temporal means</em> averaged across space). In this case, the time index is unidimensional and ordered, so one does not have to work as hard on the interpretation as we did with empirical spatial covariance matrices.</p>
<div id="fig-emp_cov_plots" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-emp_cov_plots-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="img/Chapter_2/LagCovplots.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-emp_cov_plots-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;2.16: Maximum temperature lag-0 (top) and lag-1 (bottom) empirical spatial covariance plots for four longitudinal strips (from left to right, <span class="math inline">\([-100, -95)\)</span>, <span class="math inline">\([-95, -90)\)</span>, <span class="math inline">\([-90, -85)\)</span>, <span class="math inline">\([-85, -80)\)</span> degrees) in which the domain of interest is subdivided.
</figcaption>
</figure>
</div>
</section>
<section id="sec-STcovsemi" class="level3" data-number="2.4.2">
<h3 data-number="2.4.2" class="anchored" data-anchor-id="sec-STcovsemi"><span class="header-section-number">2.4.2</span> Spatio-Temporal Covariograms and Semivariograms</h3>
<p>In Chapter 4 we shall see that it is necessary to characterize the joint spatio-temporal dependence structure of a spatio-temporal process in order to perform optimal prediction (i.e., kriging). Thus, for measures of the joint spatio-temporal dependence, we consider empirical spatio-temporal <em>covariograms</em> (and their close cousins, <em>semivariograms</em>). The biggest difference between what we are doing here and the covariance estimates in the previous section is that we are interested in characterizing the covariability in the spatio-temporal data as a function of specific lags in time <em>and</em> in space. Note that the lag in time is a scalar, but the lag in space is a vector (corresponding to the displacement between locations in <span class="math inline">\(d\)</span>-dimensional space).</p>
<p>Consider the empirical spatio-temporal covariance function for various space and time lags. Here, we make an assumption that the first moment (mean) depends on space but not on time and that the second moment (covariance) depends only on the lag differences in space and time. Then the empirical spatio-temporal covariogram for spatial lag <span class="math inline">\(\mathbf{h}\)</span> and time lag <span class="math inline">\(\tau\)</span> is given by</p>
<p><span id="eq-spacetimecovestmoment"><span class="math display">\[
\widehat{C}_z(\mathbf{h};\tau) = \frac{1}{|N_{\mathbf{s}}(\mathbf{h})|}\frac{1}{|N_t(\tau)|}
\sum_{\mathbf{s}_i,\mathbf{s}_k \in N_{\mathbf{s}}(\mathbf{h})}  \sum_{t_j,t_{\ell} \in N_t(\tau)} (Z(\mathbf{s}_i;t_j)-\widehat{\mu}_{z,s}(\mathbf{s}_i))(Z(\mathbf{s}_k;t_\ell)-\widehat{\mu}_{z,s}(\mathbf{s}_k)),
\tag{2.6}\]</span></span></p>
<p>where you will recall that <span class="math inline">\(\widehat{\mu}_{z,s}(\mathbf{s}_i) = (1/T) \sum_{j=1}^T Z(\mathbf{s}_i;t_j)\)</span>, <span class="math inline">\(N_{\mathbf{s}}(\mathbf{h})\)</span> refers to the pairs of spatial locations with spatial lag within some tolerance of <span class="math inline">\(\mathbf{h}\)</span>, <span class="math inline">\(N_t(\tau)\)</span> refers to the pairs of time points with time lag within some tolerance of <span class="math inline">\(\tau\)</span>, and <span class="math inline">\(|N(\cdot)|\)</span> refers to the number of elements in <span class="math inline">\(N(\cdot)\)</span>. Under <em>isotropy</em>, one often considers the lag only as a function of distance, <span class="math inline">\(h = ||\mathbf{h}||\)</span>, where <span class="math inline">\(|| \cdot ||\)</span> is the Euclidean norm (see <a href="ChapterAppendixA.html" class="quarto-xref"><span>Appendix A</span></a>).</p>
<div id="nte-technote-semivariogram" class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note&nbsp;2.1: Semivariogram
</div>
</div>
<div class="callout-body-container callout-body">
<p>The semivariogram is defined as <span class="math display">\[
\gamma_z(\mathbf{s}_i, \mathbf{s}_k; t_j, t_{\ell}) \equiv \frac{1}{2} \textrm{var}(Z(\mathbf{s}_i;t_j) - Z(\mathbf{s}_k;t_{\ell})).
\]</span> In the case where the covariance depends only on displacements in space and differences in time, this can be written as <span id="eq-semivariogram"><span class="math display">\[
\begin{aligned}
\gamma_z(\mathbf{h};\tau) &amp;= \frac{1}{2} \textrm{var}(Z(\mathbf{s}+ \mathbf{h}; t+ \tau) - Z(\mathbf{s}; t)) \\
&amp;= C_z(\mathbf{0};0) - \textrm{cov}(Z(\mathbf{s}+ \mathbf{h}; t + \tau), Z(\mathbf{s};t)) \\
&amp;= C_z(\mathbf{0};0) - C_z(\mathbf{h};\tau)
\end{aligned}
\tag{2.7}\]</span></span> where <span class="math inline">\(\mathbf{h}= \mathbf{s}_k - \mathbf{s}_i\)</span> is a spatial lag and <span class="math inline">\(\tau = t_{\ell} - t_j\)</span> is a temporal lag.</p>
<p>Now, <a href="#eq-semivariogram" class="quarto-xref">Equation&nbsp;<span>2.7</span></a> does not always hold. It is possible that <span class="math inline">\(\gamma_z\)</span> is a function of spatial lag <span class="math inline">\(\mathbf{h}\)</span> and temporal lag <span class="math inline">\(\tau\)</span>, but there is no stationary covariance function <span class="math inline">\(C_z(\mathbf{h};\tau)\)</span>. We generally try to avoid these models of covariability by fitting trend terms that are linear and/or quadratic in spatio-temporal coordinates.</p>
<p>If the covariance function of the process is well defined, then the semivariogram is generally characterized by the nugget effect, the sill, and the partial sill. The nugget effect is given by <span class="math inline">\(\gamma_z(\mathbf{h};\tau)\)</span> when <span class="math inline">\(\mathbf{h}\rightarrow {\bf 0}\)</span> and <span class="math inline">\(\tau \rightarrow 0\)</span>, while the sill is <span class="math inline">\(\gamma_z(\mathbf{h};\tau)\)</span> when <span class="math inline">\(\mathbf{h}\rightarrow \infty\)</span> and <span class="math inline">\(\tau \rightarrow \infty\)</span>. The partial sill is the difference between the sill and the nugget effect. The diagram below shows these components of a semivariogram as a function of spatial distance <span class="math inline">\(\|\mathbf{h}\|\)</span>.</p>
<p><img src="./img/Chapter_2/semivariogram.png" class="img-fluid"></p>
</div>
</div>
<p>In some kriging applications, one might be interested in looking at the empirical spatio-temporal semivariogram (see <a href="#nte-technote-semivariogram" class="quarto-xref">Note&nbsp;<span>2.1</span></a>). The empirical semivariogram, for the case where the covariance only depends on the displacements in space and the time lags, is obtained from <a href="#eq-spacetimecovestmoment" class="quarto-xref">Equation&nbsp;<span>2.6</span></a> as <span class="math inline">\(\widehat{\gamma}_z(\mathbf{h};\tau) = \widehat{C}_z({\mathbf{0}};0) - \widehat{C}_z(\mathbf{h};\tau)\)</span>, and so it is easy to go back and forth between the empirical semivariogram and the covariogram in this case (see the caveat in <a href="#nte-technote-semivariogram" class="quarto-xref">Note&nbsp;<span>2.1</span></a>). Assuming a constant spatial mean <span class="math inline">\(\mu_{z,s}\)</span>, then <a href="#eq-semivariogram" class="quarto-xref">Equation&nbsp;<span>2.7</span></a> can be equivalently written as <span class="math display">\[
\gamma_z(\mathbf{h};\tau) = \frac{1}{2} E\left(Z(\mathbf{s}+ \mathbf{h}; t+ \tau) - Z(\mathbf{s};t)\right)^2,
\]</span> and hence an alternative estimate is <span id="eq-semivariogramest"><span class="math display">\[
\widehat{\gamma}_z(\mathbf{h};\tau) =  \frac{1}{2}  \frac{1}{|N_{\mathbf{s}}(\mathbf{h})|}\frac{1}{|N_t(\tau)|}
\sum_{\mathbf{s}_i,\mathbf{s}_k \in N_{\mathbf{s}}(\mathbf{h})}  \sum_{t_j,t_{\ell} \in N_t(\tau)} (Z(\mathbf{s}_i;t_j)- Z(\mathbf{s}_k;t_\ell))^2,
\tag{2.8}\]</span></span> where the notation in <a href="#eq-semivariogramest" class="quarto-xref">Equation&nbsp;<span>2.8</span></a> is the same as used above in <a href="#eq-spacetimecovestmoment" class="quarto-xref">Equation&nbsp;<span>2.6</span></a>. Note that this calculation does not need any information about the spatial means.</p>
<div id="fig-var_cov" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-var_cov-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="img/Chapter_2/STvar.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-var_cov-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;2.17: Empirical spatio-temporal semivariogram of daily <code>Tmax</code> from the NOAA data set during July 2003, computed using the function <code>variogram</code> in <strong>gstat</strong>.
</figcaption>
</figure>
</div>
</section>
<section id="sec-EOFs" class="level3" data-number="2.4.3">
<h3 data-number="2.4.3" class="anchored" data-anchor-id="sec-EOFs"><span class="header-section-number">2.4.3</span> Empirical Orthogonal Functions (EOFs)</h3>
<p>Empirical orthogonal functions (EOFs) can reveal spatial structure in spatio-temporal data and can also be used for subsequent dimensionality reduction. EOFs came out of the meteorology/climatology literature, and in the context of discrete space and time, EOF analysis is the spatio-temporal manifestation of principal component analysis (PCA) in statistics <span class="citation" data-cites="cressie2011statistics">(<a href="references.html#ref-cressie2011statistics" role="doc-biblioref">Cressie &amp; Wikle, 2011</a>)</span>. In the terminology of this chapter, one should probably modify “EOFs” to empirical <em>spatial</em> orthogonal functions, since they are obtained from an empirical <em>spatial</em> covariance matrix, but for legacy reasons we stick with “EOFs.” Before we discuss EOFs, we give a brief review of PCA.</p>
<section id="brief-review-of-principal-component-analysis" class="level4 unnumbered">
<h4 class="unnumbered anchored" data-anchor-id="brief-review-of-principal-component-analysis">Brief Review of Principal Component Analysis</h4>
<p>Assume we have two measured traits on a subject of interest (e.g., measurements of <span class="math inline">\(x_1 = \mbox{height}\)</span> (in cm) and <span class="math inline">\(x_2 = \mbox{weight}\)</span> (in kg) in a sample of women in the USA). <a href="#fig-simHWproj" class="quarto-xref">Figure&nbsp;<span>2.18</span></a> (left panel) shows a (simulated) plot of what such data might look like for <span class="math inline">\(m=500\)</span> individuals. We note that these data are quite correlated, as expected. Now, we wish to construct new variables that are linear combinations of the measured traits, say <span class="math inline">\(a_1 = w_{11} x_1 + w_{12} x_2\)</span> and <span class="math inline">\(a_2 = w_{21} x_1 + w_{22} x_2\)</span>. One way to think of this is that we are “projecting” the original data onto new axes given by the variables <span class="math inline">\(a_1\)</span> and <span class="math inline">\(a_2\)</span>. <a href="#fig-simHWproj" class="quarto-xref">Figure&nbsp;<span>2.18</span></a> (center and right panels) shows two possible projections, which differ according to the values we choose for the weights, <span class="math inline">\(\{w_{11}, w_{12}, w_{21}, w_{22}\}\)</span>. Note that in the case of the right-hand panel in <a href="#fig-simHWproj" class="quarto-xref">Figure&nbsp;<span>2.18</span></a>, the new axis <span class="math inline">\(a_1\)</span> aligns with the axis of largest variation, and the new axis <span class="math inline">\(a_2\)</span> corresponds to the axis of largest variation perpendicular (orthogonal) to the axis <span class="math inline">\(a_1\)</span>. Maximizing these axes of variation subject to orthogonality helps us think about decomposing the data into lower-dimensional representations in an optimal way. That is, the new variable on the axis <span class="math inline">\(a_1\)</span> represents the optimal linear combination of the data that accounts for the most variation in the original data. If the variation along the other axis (<span class="math inline">\(a_2\)</span>) is fairly small relative to <span class="math inline">\(a_1\)</span>, then it might be sufficient just to consider <span class="math inline">\(a_1\)</span> to represent the data.</p>
<div id="fig-simHWproj" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-simHWproj-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="img/Chapter_2/PCA1.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-simHWproj-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;2.18: Simulated height (in cm) versus weight (in kg) for <span class="math inline">\(m=500\)</span> females in the USA (left) with two orthogonal projections (center and right). The right panel shows the optimal PCA projection.
</figcaption>
</figure>
</div>
<p>How does one go about choosing the weights <span class="math inline">\(\{w_{ij}\}\)</span>? Let <span class="math inline">\({\mathbf{x}}_i = (x_{1i},\ldots, x_{pi})'\)</span> be a random vector with variance–covariance matrix <span class="math inline">\({\mathbf{C}}_x\)</span>. Note from <a href="ChapterAppendixA.html" class="quarto-xref"><span>Appendix A</span></a> that by spectral decomposition, a <span class="math inline">\(p \times p\)</span> non-negative-definite, symmetric, real matrix, <span class="math inline">\({\mathbf{\Sigma}}\)</span>, can be <em>diagonalized</em> such that <span class="math inline">\({\mathbf{W}}' {\mathbf{\Sigma}} {\mathbf{W}} = {\mathbf{\Lambda}}\)</span> (i.e., <span class="math inline">\(\boldsymbol{\Sigma}= \mathbf{W}{\mathbf{\Lambda}} \mathbf{W}'\)</span>), where <span class="math inline">\({\mathbf{\Lambda}}\)</span> is a diagonal matrix containing the eigenvalues <span class="math inline">\(\{\lambda_i\}\)</span> of <span class="math inline">\({\mathbf{\Sigma}}\)</span> (where <span class="math inline">\(\lambda_1 \ge \lambda_2 \ge \ldots \ge \lambda_p \ge 0\)</span>) and <span class="math inline">\({\mathbf{W}} = [{\mathbf{w}}_1 \; {\mathbf{w}}_2 \; \ldots \; {\mathbf{w}}_p]\)</span> is the associated matrix of orthogonal eigenvectors, <span class="math inline">\(\{{\mathbf{w}}_i\}\)</span> (i.e., <span class="math inline">\(\mathbf{W}\mathbf{W}' = \mathbf{W}' \mathbf{W}= \mathbf{I}\)</span>); thus, <span class="math inline">\({\mathbf{C}}_x = {\mathbf{W}} {\mathbf{\Lambda}}_x {\mathbf{W}}'\)</span>. It can be shown that these eigenvectors give the optimal weights, so that <span class="math inline">\({\mathbf{w}}_1\)</span> are the weights for <span class="math inline">\(a_1\)</span> and <span class="math inline">\({\mathbf{w}}_2\)</span> are the weights for <span class="math inline">\(a_2\)</span>, and so on.</p>
<p>As an example, consider the variance–covariance matrix associated with the simulated height and weight traits, where <span class="math inline">\(p=2\)</span>: <span class="math display">\[
{\mathbf{C}}_x = \left( \begin{array}{rr}
81  &amp;  50 \\
50   &amp; 49
\end{array} \right).
\]</span> Then <span class="math inline">\({\mathbf{W}}\)</span> and <span class="math inline">\({\mathbf{\Lambda}}_x\)</span> are given (using the function <code>eigen</code> in <code>R</code>) by <span class="math display">\[
{\mathbf{W}} = \left( \begin{array}{rr}
-0.8077 &amp; 0.5896 \\
-0.5896 &amp; -0.8077
\end{array} \right), \quad
{\mathbf{\Lambda}}_x = \left( \begin{array}{rr}
117.5 &amp; 0 \\
0 &amp; 12.5
\end{array} \right).
\]</span> So, for each of the observation vectors, <span class="math inline">\(\{{\mathbf{x}}_i, i=1,\ldots,500\}\)</span>, we make new variables <span class="math display">\[
a_{1i} = -0.8077 x_{1i} - 0.5896 x_{2i}
\]</span> <span class="math display">\[
a_{2i} = 0.5896 x_{1i} - 0.8077 x_{2i}.
\]</span> These coefficients (which are the data projected onto axes <span class="math inline">\((a_1,a_2)\)</span>) are plotted in <a href="#fig-simHWpc" class="quarto-xref">Figure&nbsp;<span>2.19</span></a>. Note that these new variables are uncorrelated (no slant to the points in the plot) and the first axis (<span class="math inline">\(a_1\)</span>) corresponds to the one that has the most variability. In PCA, one sometimes attempts to interpret the “loadings” given by <span class="math inline">\(\{\mathbf{w}_i: i =1,\ldots, p\}\)</span> (or some scaled version of them). That is, one contrasts the signs and magnitudes of the loadings within a given eigenvector (e.g., the first eigenvector, <span class="math inline">\({\mathbf{w}}_1 = (-0.8077, -0.5896)'\)</span>, suggests that both height and weight are important and vary in the same way, so that the first principal component might represent an overall “size” attribute).</p>
<div id="fig-simHWpc" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-simHWpc-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="img/Chapter_2/PCA2.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-simHWpc-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;2.19: Principal components corresponding to the simulated data in <a href="#fig-simHWproj" class="quarto-xref">Figure&nbsp;<span>2.18</span></a>.
</figcaption>
</figure>
</div>
<p>The notions presented in the example above extend to more than just two traits and, in general, the principal-component decomposition has some nice properties. For example, the <span class="math inline">\(k\)</span>th eigenvalue is the variance of the associated linear combination of the elements of <span class="math inline">\(\mathbf{x}\)</span>; that is, <span class="math inline">\(\textrm{var}(a_k) = \textrm{var}({\mathbf{w}}_k' {\mathbf{x}})= \lambda_k\)</span>. In addition, <span class="math display">\[
\textrm{var}(x_1) + \ldots + \textrm{var}(x_p) = \textrm{trace}({\mathbf{C}}_x) = \lambda_1 + \ldots + \lambda_p = \textrm{var}(a_1) + \ldots + \textrm{var}(a_p).
\]</span> Thus, one can consider the proportion of the total variance accounted for by the <span class="math inline">\(k\)</span>th principal component, which is <span class="math inline">\(\lambda_k/\sum_{j=1}^p \lambda_j\)</span>. In the example above, the first principal component accounts for about 90% of the variance in the original data (i.e., <span class="math inline">\(\lambda_1/(\lambda_1 + \lambda_2)= 117.5/130 = 0.90\)</span>).</p>
<p>Of course, in practice we would not know the covariance matrix, <span class="math inline">\(\mathbf{C}_x\)</span>, but we can calculate an empirical covariance matrix using <a href="#eq-emp_cov" class="quarto-xref">Equation&nbsp;<span>2.4</span></a> with <span class="math inline">\(\tau = 0\)</span>, <span class="math inline">\(\{\mathbf{Z}_{t_j}\}\)</span> replaced by <span class="math inline">\(\{\mathbf{x}_i\}\)</span>, and <span class="math inline">\(\widehat{\boldsymbol{\mu}}_{z,s}\)</span> replaced by <span class="math inline">\((1/500) \sum_{i=1}^{500} \mathbf{x}_i\)</span>. In that case, the spectral decomposition of <span class="math inline">\(\widehat{\mathbf{C}}_x\)</span> gives empirical estimates of the eigenvectors <span class="math inline">\(\widehat{\mathbf{W}}\)</span> and eigenvalues <span class="math inline">\(\widehat{\boldsymbol{\Lambda}}_x\)</span>. The analysis then proceeds with these empirical estimates.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p>The PCA routine <code>prcomp</code> is included with base <code>R</code>. When the <code>plot</code> function is used on an object returned by <code>prcomp</code>, the variances of the principal components are displayed. The function <code>biplot</code> returns a plot showing how the observations relate to the principal components.</p>
</div>
</div>
</section>
<section id="empirical-orthogonal-functions" class="level4" data-number="2.4.3.1">
<h4 data-number="2.4.3.1" class="anchored" data-anchor-id="empirical-orthogonal-functions"><span class="header-section-number">2.4.3.1</span> Empirical Orthogonal Functions</h4>
<p>The study of EOFs is related to PCA in the sense that the “traits” of the multivariate data vector now are spatially indexed, and the samples are usually taken over time. It is shown in <span class="citation" data-cites="cressie2011statistics">Cressie &amp; Wikle (<a href="references.html#ref-cressie2011statistics" role="doc-biblioref">2011</a>)</span> (Chapter 5) that the EOFs can be obtained from the data through either a spectral decomposition of an empirical (spatial or temporal) covariance matrix or a singular value decomposition (SVD) of a centered data matrix (see <a href="#nte-technote-EOFs" class="quarto-xref">Note&nbsp;<span>2.2</span></a>).</p>
<p>Let <span class="math inline">\(\mathbf{Z}_{t_j} \equiv (Z(\mathbf{s}_1;t_j),\ldots,Z(\mathbf{s}_m;t_j))'\)</span> for <span class="math inline">\(j=1,\ldots,T\)</span>. Using <a href="#eq-emp_cov" class="quarto-xref">Equation&nbsp;<span>2.4</span></a> to estimate the lag-0 spatial covariance matrix, <span class="math inline">\(\widehat{\mathbf{C}}^{(0)}_z\)</span> (which is symmetric and non-negative-definite), the PCA decomposition is given by the spectral decomposition</p>
<p><span id="eq-EOF_symdecomp"><span class="math display">\[
\widehat{\mathbf{C}}^{(0)}_z = \boldsymbol{\Psi}\boldsymbol{\Lambda}\boldsymbol{\Psi}'
\tag{2.9}\]</span></span></p>
<p>where <span class="math inline">\(\boldsymbol{\Psi}\equiv (\boldsymbol{\psi}_1,\ldots,\boldsymbol{\psi}_m)\)</span> is a matrix of spatially indexed eigenvectors given by the vectors <span class="math inline">\(\boldsymbol{\psi}_k \equiv (\psi_k(\mathbf{s}_1),\ldots,\psi_k(\mathbf{s}_m))'\)</span> for <span class="math inline">\(k=1,\ldots,m\)</span>, and <span class="math inline">\(\boldsymbol{\Lambda}\equiv \textrm{diag}(\lambda_1,\ldots,\lambda_m)\)</span> is a diagonal matrix of corresponding non-negative eigenvalues (decreasing down the diagonal). The eigenvectors are called “EOFs” and are often plotted as spatial maps (since they are spatially indexed, which is also why <span class="math inline">\({\mathbf{\Psi}}\)</span> is used to distinguish them from the more general PCA weights, <span class="math inline">\({\mathbf{W}}\)</span>, above). For <span class="math inline">\(k=1,\ldots,m\)</span>, the so-called <em><span class="math inline">\(k\)</span>th principal component (PC) time series</em> are given by <span class="math inline">\(a_k(t_j) \equiv \boldsymbol{\psi}'_k \mathbf{Z}_{t_j}\)</span>, where <span class="math inline">\(j=1,\ldots,T\)</span>. From PCA considerations, the EOFs have the nice property that <span class="math inline">\(\boldsymbol{\psi}_1\)</span> provides the linear coefficients such that <span class="math inline">\(\textrm{var}(a_1) = \lambda_1\)</span> is maximized, <span class="math inline">\(\boldsymbol{\psi}_2\)</span> provides the linear coefficients such that <span class="math inline">\(\textrm{var}(a_2) = \lambda_2\)</span> accounts for the next largest variance such that <span class="math inline">\(\textrm{cov}(a_1,a_2) = 0\)</span>, and so on. As with the principal components in PCA, the EOFs form a discrete orthonormal basis (i.e., <span class="math inline">\(\boldsymbol{\Psi}' \boldsymbol{\Psi}= \boldsymbol{\Psi}\boldsymbol{\Psi}' = \mathbf{I}\)</span>).</p>
<p>There are two primary uses for EOFs. First, it is sometimes the case that one can gain some understanding about important spatial patterns of variability in a sequence of spatio-temporal data by examining the EOF coefficient maps (loadings). But care must be taken not to interpret the EOF spatial structures in terms of dynamical or kinematic properties of the underlying process <span class="citation" data-cites="monahan2009empirical">Monahan et al. (<a href="references.html#ref-monahan2009empirical" role="doc-biblioref">2009</a>)</span>. Second, these bases can be quite useful for dimension reduction in a random-effects spatial or spatio-temporal representation (see <a href="Chapter4.html#sec-basisfunctions" class="quarto-xref"><span>Section 4.4</span></a>), although again, in general, they are not “optimal” bases in terms of reduced-order dynamical systems.</p>
<div id="nte-technote-EOFs" class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note&nbsp;2.2: Calculating EOFs
</div>
</div>
<div class="callout-body-container callout-body">
<p>As stated above, EOFs can be calculated directly from the spectral decomposition of the empirical lag-0 spatial covariance matrix (<a href="#eq-EOF_symdecomp" class="quarto-xref">Equation&nbsp;<span>2.9</span></a>). However, they are more often obtained directly through a <em>singular value decomposition</em> (SVD, see <a href="ChapterAppendixA.html" class="quarto-xref"><span>Appendix A</span></a>), which provides computational benefits in some situations. To see the equivalence, first we show how to calculate the empirical covariance-based EOFs. Let <span class="math inline">\(\mathbf{Z}\equiv [\mathbf{Z}_1,\ldots,\mathbf{Z}_T]^\prime\)</span> be the <span class="math inline">\(T \times m\)</span> space-wide data matrix and then let <span class="math inline">\(\widetilde{\mathbf{Z}}\)</span> be the “detrended” and scaled data matrix,</p>
<p><span id="eq-scaledZ"><span class="math display">\[
\widetilde{\mathbf{Z}} \equiv \frac{1}{\sqrt{T-1}}(\mathbf{Z}- \mathbf{1}_T \widehat{\boldsymbol{\mu}}_{z,s}^\prime)
\tag{2.10}\]</span></span></p>
<p>where <span class="math inline">\(\mathbf{1}_T\)</span> is a <span class="math inline">\(T\)</span>-dimensional vector of ones and <span class="math inline">\(\widehat{\boldsymbol{\mu}}_{z,s}\)</span> is the spatial mean vector given by <a href="#eq-Zmean" class="quarto-xref">Equation&nbsp;<span>2.1</span></a>. Then it is easy to show that</p>
<p><span id="eq-covZtilde"><span class="math display">\[
\mathbf{C}_z^{(0)} = \widetilde{\mathbf{Z}}' \widetilde{\mathbf{Z}} = {\boldsymbol{\Psi}} \boldsymbol{\Lambda}\boldsymbol{\Psi}'
\tag{2.11}\]</span></span></p>
<p>and the principal component (PC) time series are given by the columns of <span class="math inline">\(\mathbf{A}=  (\sqrt{T-1}) \widetilde{\mathbf{Z}} \boldsymbol{\Psi}\)</span>; that is, they are projections of the detrended data matrix onto the EOF basis functions, <span class="math inline">\({\boldsymbol{\Psi}}\)</span>. The <em>normalized PC time series</em> are then given by <span class="math inline">\(\mathbf{A}_{\mathrm{norm}} \equiv \mathbf{A}\boldsymbol{\Lambda}^{-1/2}\)</span>; these are just the PC time series divided by their standard deviation (i.e., the square root of the associated eigenvalue), so that the temporal variance of the normalized time series is equal to one. This normalization allows the <span class="math inline">\(m\)</span> time series to be plotted on the same scale, leaving their relative importance to be captured by their corresponding eigenvalues.</p>
<p>Now, consider the SVD of the detrended and scaled data matrix,</p>
<p><span id="eq-SVD"><span class="math display">\[
\widetilde{\mathbf{Z}} = \mathbf{U}\mathbf{D}\mathbf{V}'
\tag{2.12}\]</span></span></p>
<p>where <span class="math inline">\(\mathbf{U}\)</span> is the <span class="math inline">\(T \times T\)</span> matrix of left singular vectors, <span class="math inline">\(\mathbf{D}\)</span> is a <span class="math inline">\(T \times m\)</span> matrix containing singular values on the main diagonal, and <span class="math inline">\(\mathbf{V}\)</span> is an <span class="math inline">\(m \times m\)</span> matrix containing the right singular vectors, where both <span class="math inline">\(\mathbf{U}\)</span> and <span class="math inline">\(\mathbf{V}\)</span> are orthonormal matrices. Upon substituting <a href="#eq-SVD" class="quarto-xref">Equation&nbsp;<span>2.12</span></a> into <a href="#eq-covZtilde" class="quarto-xref">Equation&nbsp;<span>2.11</span></a>, it is easy to see that the EOFs are given by <span class="math inline">\(\boldsymbol{\Psi}= \mathbf{V}\)</span>, and <span class="math inline">\(\boldsymbol{\Lambda}= \mathbf{D}' \mathbf{D}\)</span>. In addition, it is straightforward to show that <span class="math inline">\(\mathbf{A}= (\sqrt{T-1}) \mathbf{U}\mathbf{D}\)</span> and that the first <span class="math inline">\(m\)</span> columns of <span class="math inline">\((\sqrt{T-1}) \mathbf{U}\)</span> correspond to the normalized PC time series, <span class="math inline">\(\mathbf{A}_{\mathrm{norm}}\)</span>. Thus, the advantages of the SVD calculation approach are: (1) we do not need to calculate the empirical spatial covariance matrix; (2) we get the normalized PC time series and EOFs simultaneously; and (3) the procedure still works when <span class="math inline">\(T &lt; m\)</span>. The case of <span class="math inline">\(T &lt; m\)</span> can be problematic in the covariance context since then <span class="math inline">\(\mathbf{C}^{(0)}_z\)</span> is not positive-definite, although, as shown in <span class="citation" data-cites="cressie2011statistics">Cressie &amp; Wikle (<a href="references.html#ref-cressie2011statistics" role="doc-biblioref">2011</a>)</span> (Section 5.3.4), in this case one can still calculate the EOFs and PC time series.</p>
</div>
</div>
<p><a href="#fig-EOFsA" class="quarto-xref">Figure&nbsp;<span>2.20</span></a> and <a href="#fig-EOFsB" class="quarto-xref">Figure&nbsp;<span>2.21</span></a> show the first four EOFs and PC time series for the SST data set. In this case, the number of spatial locations <span class="math inline">\(m = 2261\)</span>, and the number of time points <span class="math inline">\(T = 399\)</span>. The first four EOFs account for slightly more than 60% of the variation in the data. The EOF spatial patterns show strong variability in the eastern and central tropical Pacific, and they are known to be related to the El Niño and La Niña climate patterns that dominate the tropical Pacific SST variability. The corresponding PC time series (particularly for the first EOF) show time periods at which the data project very strongly on this spatial pattern (both in terms of large positive and large negative values), and it can be shown that these times correspond to strong El Niño and La Niña events, respectively.</p>
<div id="fig-EOFsA" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-EOFsA-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="img/Chapter_2/EOFsA.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-EOFsA-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;2.20: The first two empirical orthogonal functions and normalized principal-component time series for the SST data set obtained using an SVD of a space-wide matrix.
</figcaption>
</figure>
</div>
<div id="fig-EOFsB" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-EOFsB-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="img/Chapter_2/EOFsB.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-EOFsB-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;2.21: The third and fourth empirical orthogonal functions and normalized principal-component time series for the SST data set obtained using an SVD of a space-wide matrix.
</figcaption>
</figure>
</div>
<p>How many EOFs should one consider? This is a long-standing question in PCA, and there are numerous suggestions. Perhaps the simplest is just to consider the number of EOFs that account for some desired proportion of overall variance. Alternatively, one can produce a <em>scree plot</em>, which is a plot of the relative variance associated with each eigenvalue of the EOF as a function of the index of that EOF (see <a href="#fig-SSTscree" class="quarto-xref">Figure&nbsp;<span>2.22</span></a>), and where the sum of all relative variances is 1. One typically sees a fairly quick drop in relative variance with increasing order of the eigenvalue, and then the variance reduction flattens out. It is sometimes recommended that one only focus on those EOFs before the index that begins the flat part of the curve; this choice of index can be a bit subjective. One can also get a sense as to the “significance” of each component by comparing the relative variances to those in an EOF analysis in which the values for each spatial location are randomly permuted at each time <span class="citation" data-cites="hastie2009elements">(<a href="references.html#ref-hastie2009elements" role="doc-biblioref">Hastie et al., 2009, Chapter 14</a>)</span>. Then, one plots the scree plot with the actual data superimposed on the permuted data. We recommend that the EOFs retained are around the index at which the two “curves” intersect. For example, the black symbols in <a href="#fig-SSTscree" class="quarto-xref">Figure&nbsp;<span>2.22</span></a> correspond to the relative variance associated with the first 50 EOFs for the SST data, and the red symbols are the very tight boxplots of relative variances obtained from EOF analyses of 100 random permutations of the data. One can see that by about index 12, the scree plot of the actual data and the boxplots are starting to intersect, suggesting that there is very little “real” variability being accounted for by the EOFs with indices greater than about 12.</p>
<div id="fig-SSTscree" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-SSTscree-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="img/Chapter_2/SST_scree_perm.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-SSTscree-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;2.22: Scree plot for the EOF analysis of the SST data. The black symbols correspond to the relative variance associated with the ordered eigenvalues. The red symbols correspond to (very tight) boxplots of the relative variance associated with the eigenvalues from 100 EOF analyses in which the SST values at the spatial locations were randomly permuted for each time point.
</figcaption>
</figure>
</div>
</section>
<section id="some-technical-comments-on-empirical-orthogonal-functions" class="level4" data-number="2.4.3.2">
<h4 data-number="2.4.3.2" class="anchored" data-anchor-id="some-technical-comments-on-empirical-orthogonal-functions"><span class="header-section-number">2.4.3.2</span> Some Technical Comments on Empirical Orthogonal Functions</h4>
<p>The EOF decomposition is sometimes derived in a continuous-space context through a Karhunen–Loève expansion, with eigenvalues and eigenfunctions obtained through a solution of a Fredholm integral equation (<span class="citation" data-cites="cressie2011statistics">Cressie &amp; Wikle (<a href="references.html#ref-cressie2011statistics" role="doc-biblioref">2011</a>)</span>, Section 5.3). This is relevant, as it shows why one should account for the area/support associated with each spatial observation when working in a discrete-space EOF environment. In particular, one should multiply the elements of the eigenvectors by the square root of the length, area, or volume of the spatial support associated with that spatial observation (e.g., <span class="citation" data-cites="cohen1969regression">Cohen &amp; Jones (<a href="references.html#ref-cohen1969regression" role="doc-biblioref">1969</a>)</span>). For example, consider spatial location <span class="math inline">\(\mathbf{s}_i\)</span>; for each of the <span class="math inline">\(k\)</span> eigenvectors, one should multiply <span class="math inline">\(\psi_k(\mathbf{s}_i)\)</span> by <span class="math inline">\(\sqrt{e}_i\)</span>, where <span class="math inline">\(e_i\)</span> is the length, area, or volume associated with location <span class="math inline">\(\mathbf{s}_i\)</span> (and we assume that not all of the <span class="math inline">\(\{e_i\}\)</span> are identical). This modification to the eigenvectors <span class="math inline">\(\boldsymbol{\psi}_1,\ldots,\boldsymbol{\psi}_k\)</span> must be done before calculating the PC time series.</p>
<p>Although most EOF analyses in the spatio-temporal context consider spatial EOFs and PC time series, one can certainly consider the analogous decomposition in which the EOFs are time-series bases and the projection of the data onto these bases is given by PC spatial fields. Implementation is straightforward – one either works with the temporal covariance matrix (averaging over spatial location) or considers the SVD of an <span class="math inline">\(m \times T\)</span> (temporally detrended) data matrix. EOF time series are used as temporal basis functions in a spatio-temporal model in Lab 4.3.</p>
<p>It is also important to note that in cases where EOF analysis is used for dimension reduction (see <a href="Chapter4.html#sec-randomeffects" class="quarto-xref"><span>Section 4.3</span></a>), it is often necessary to either interpolate the EOFs in a sensible manner (e.g., <span class="citation" data-cites="obled1986some">Obled &amp; Creutin (<a href="references.html#ref-obled1986some" role="doc-biblioref">1986</a>)</span>) or “pre-interpolate” the data onto a finely gridded spatial domain.</p>
<p>Finally, there are many extensions to the basic EOF analysis presented here, including so-called complex EOFs, cyclostationary EOFs, multivariate EOFs, and extended EOFs. These all have particular utility depending on the type of data and the goal of the analysis. For example, complex EOFs are used for trying to identify propagating features that account for a significant amount of variation in the data. Cyclostationary EOFs are appropriate when there are strong periodicities in the data and spatial variation is expected to shift dramatically within this periodicity. Multivariate EOFs are considered when multivariate spatial data are observed at the same time points. Extended EOFs are useful for understanding spatial patterns associated with temporal lags. These methods are described in more detail in <span class="citation" data-cites="cressie2011statistics">Cressie &amp; Wikle (<a href="references.html#ref-cressie2011statistics" role="doc-biblioref">2011</a>)</span> (Section 5.3) and the references therein. In Lab 2.3 we will demonstrate the “classic” EOF analysis in <code>R</code>.</p>
</section>
</section>
</section>
<section id="spatio-temporal-canonical-correlation-analysis" class="level2" data-number="2.5">
<h2 data-number="2.5" class="anchored" data-anchor-id="spatio-temporal-canonical-correlation-analysis"><span class="header-section-number">2.5</span> Spatio-Temporal Canonical Correlation Analysis</h2>
<p>In multivariate statistics, canonical correlation analysis (CCA) seeks to create new variables that are linear combinations of two multivariate data sets (separately) such that the correlations between these new variables are maximized (e.g., <span class="citation" data-cites="hotelling1936relations">Hotelling (<a href="references.html#ref-hotelling1936relations" role="doc-biblioref">1936</a>)</span>). Such methods can be extended to the case where the two data sets are indexed in space and time, typically where a spatial location corresponds to a “trait” in a multivariate set of “traits” (this terminology is borrowed from psychometrics). Time corresponds to the samples. (Note that just as with EOFs, one can reverse the roles of space and time in this setting as well.) A spatio-temporal CCA (ST-CCA) is given below where spatial location corresponds to the multivariate trait.</p>
<p>Assume that we have two data sets that have the same temporal domain of interest but potentially different spatial domains. In particular, consider the data sets given by the collection of spatial vectors <span class="math inline">\(\{\mathbf{Z}_{t_j} \equiv (Z(\mathbf{s}_1;t_j),\ldots, Z(\mathbf{s}_m;t_j))' : j=1,\ldots,T\}\)</span>, and <span class="math inline">\(\{\mathbf{X}_{t_j} \equiv (X(\mathbf{r}_1;t_j),\ldots,X(\mathbf{r}_n;t_j))' : j=1,\ldots, T\}\)</span>. Now, consider the two new variables that are linear combinations of <span class="math inline">\(\mathbf{Z}_{t_j}\)</span> and <span class="math inline">\(\mathbf{X}_{t_j}\)</span>, respectively:</p>
<p><span id="eq-CCA_a"><span class="math display">\[
a_k(t_j) = \sum_{i=1}^m \xi_{ik} \; Z(\mathbf{s}_i;t_j) = \boldsymbol{\xi}_k^\prime \mathbf{Z}_{t_j},
\tag{2.13}\]</span></span></p>
<p><span id="eq-CCA_b"><span class="math display">\[
b_k(t_j) = \sum_{\ell=1}^n  \psi_{\ell k} \; X(\mathbf{r}_\ell;t_j) = \boldsymbol{\psi}_k^\prime \mathbf{X}_{t_j},
\tag{2.14}\]</span></span></p>
<p>For suitable choices of weights (see below), the <span class="math inline">\(k\)</span>th <em>canonical correlation</em>, for <span class="math inline">\(k=1,2,\ldots,\min\{n,m\}\)</span>, is then simply the correlation between <span class="math inline">\(a_k\)</span> and <span class="math inline">\(b_k\)</span>,</p>
<p><span class="math display">\[
r_k \equiv \mathrm{corr}(a_k,b_k) =  \frac{\mathrm{cov}(a_k,b_k)}{\sqrt{\mathrm{var}(a_k)}\sqrt{\mathrm{var}(b_k)}},
\]</span></p>
<p>which can also be written as</p>
<p><span id="eq-CCAr"><span class="math display">\[
r_k = \frac{\boldsymbol{\xi}_k^\prime \mathbf{C}^{(0)}_{z,x}\boldsymbol{\psi}_k}{(\boldsymbol{\xi}_k^\prime \mathbf{C}_z^{(0)} \boldsymbol{\xi}_k)^{1/2}(\boldsymbol{\psi}_k^\prime \mathbf{C}_x^{(0)} \boldsymbol{\psi}_k)^{1/2}},
\tag{2.15}\]</span></span></p>
<p>where the variance–covariance matrices <span class="math inline">\(\mathbf{C}^{(0)}_z\)</span> and <span class="math inline">\(\mathbf{C}^{(0)}_x\)</span> are of dimension <span class="math inline">\(m \times m\)</span> and <span class="math inline">\(n \times n\)</span>, respectively, and the cross-covariance matrix <span class="math inline">\(\mathbf{C}^{(0)}_{z,x} \equiv\mathrm{cov}(\mathbf{Z},\mathbf{X})\)</span> has dimension <span class="math inline">\(m \times n\)</span>. So the first pair of canonical variables corresponds to the weights <span class="math inline">\({\boldsymbol{\xi}}_1\)</span> and <span class="math inline">\({\boldsymbol{\psi}}_1\)</span> that maximize <span class="math inline">\(r_1\)</span> in <a href="#eq-CCAr" class="quarto-xref">Equation&nbsp;<span>2.15</span></a>. In addition, we standardize these weights such that the new canonical variables have unit variance. Given this first pair of canonical variables, we can then find a second pair, <span class="math inline">\({\boldsymbol{\xi}}_2\)</span> and <span class="math inline">\(\boldsymbol{\psi}_2\)</span>, associated with <span class="math inline">\(\{a_2, b_2\}\)</span> that are uncorrelated with <span class="math inline">\(\{a_1,b_1\}\)</span>, have unit variance, and maximize <span class="math inline">\(r_2\)</span> in <a href="#eq-CCAr" class="quarto-xref">Equation&nbsp;<span>2.15</span></a>. This procedure continues so that the <span class="math inline">\(k\)</span>th set of canonical variables are the linear combinations, <span class="math inline">\(\{a_k,b_k\}\)</span>, that have unit variance, are uncorrelated with the previous <span class="math inline">\(k-1\)</span> canonical variable pairs, and maximize <span class="math inline">\(r_k\)</span> in <a href="#eq-CCAr" class="quarto-xref">Equation&nbsp;<span>2.15</span></a>. A specific procedure for calculating ST-CCA is given in <a href="#nte-technote-STCCA" class="quarto-xref">Note&nbsp;<span>2.3</span></a>.</p>
<p>Because the weights given by <span class="math inline">\({\boldsymbol{\xi}}_k\)</span> and <span class="math inline">\({\boldsymbol{\psi}}_k\)</span> are indexed in space, they can be plotted as spatial maps, and the associated canonical variables can be plotted as time series. From an interpretation perspective, the time series of the first few canonical variables typically match up fairly closely (given they are optimized to maximize correlation), and the spatial patterns in the weights show the areas in space that are most responsible for the high correlations. Like EOFs, principal components, and other such approaches, one has to be careful with the interpretation of canonical variables beyond the first pair, given the restriction that CCA time series are uncorrelated. In addition, given that high canonical correlations within a canonical pair naturally result from this procedure, one has to be careful in evaluating the importance of that correlation. One way to do this is to randomly permute the spatial locations in the <span class="math inline">\({\mathbf{Z}}_{t_j}\)</span> and <span class="math inline">\({\mathbf{X}}_{t_j}\)</span> data vectors (separately) and recalculate the ST-CCA many times, thereby giving a permutation-based range of canonical correlations when there is no real structural relationship between the variables.</p>
<p>In addition to the consideration of two separate data sets, one can perform an ST-CCA between <span class="math inline">\({\mathbf{Z}}_{t_j}\)</span> and, say, <span class="math inline">\({\mathbf{X}}_{t_j} \equiv {\mathbf{Z}}_{t_j-\tau}\)</span>, a <span class="math inline">\(\tau\)</span>-lagged version of the <span class="math inline">\({\mathbf{Z}}_{t_j}\)</span> data. This “one-field ST-CCA” is often useful for exploratory data analysis or for generating a forecast of a spatial field. Some binning of the spatio-temporal data into temporal bins lagged by <span class="math inline">\(\tau\)</span> may be needed in practice.</p>
<p>Finally, in practice, because the covariance matrices required to implement ST-CCA are often fairly noisy (and even singular), depending on the sample size, we typically first project the data into a lower dimension using EOFs for computational stability (see <span class="citation" data-cites="cressie2011statistics">Cressie &amp; Wikle (<a href="references.html#ref-cressie2011statistics" role="doc-biblioref">2011</a>)</span>, Section 5.6.1). This is the approach we take in Lab 2.3.</p>
<p>As an example of ST-CCA, we consider a one-field ST-CCA on the SST data set. In particular, we are interested in forecasting SST seven months in the future, so we let the data <span class="math inline">\(\mathbf{X}\)</span> be the lag <span class="math inline">\(\tau = 7\)</span> month SST data and the data <span class="math inline">\(\mathbf{Z}\)</span> be the same SSTs with no lag. However, because <span class="math inline">\(T &lt; \max\{m,n\}\)</span> for these data, we first project the data onto the first 10 EOFs (which account for about 74% of the variance in the data). For the projected data, <a href="#fig-CCA1" class="quarto-xref">Figure&nbsp;<span>2.23</span></a> shows the first canonical variables (i.e., <span class="math inline">\(\{a_1(t_j),b_1(t_j): j=1,\ldots,T\}\)</span>), plotted as individual time series and which correspond to a canonical correlation of <span class="math inline">\(r_1 = 0.843\)</span>. <a href="#fig-CCA2" class="quarto-xref">Figure&nbsp;<span>2.24</span></a> shows the corresponding spatial-weights maps for <span class="math inline">\({\boldsymbol{\xi}}_1\)</span> and <span class="math inline">\({\boldsymbol{\psi}}_1\)</span>, respectively. In this example, it can be seen from the time-series plots that the series are quite highly correlated, and it can be shown that the large peaks correspond to known El Niño Southern Oscillation (ENSO) events. Similarly, the left panel of <a href="#fig-CCA2" class="quarto-xref">Figure&nbsp;<span>2.24</span></a> suggests a precursor pattern to the SST field in the right panel.</p>
<div id="nte-technote-STCCA" class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note&nbsp;2.3: Calculating ST-CCA
</div>
</div>
<div class="callout-body-container callout-body">
<p>First, let <span class="math inline">\(k=1\)</span> and, because <span class="math inline">\(\mathbf{C}_z^{(0)}\)</span> and <span class="math inline">\(\mathbf{C}_x^{(0)}\)</span> are positive-definite, note that we can write <span class="math inline">\(\mathbf{C}_z^{(0)} = (\mathbf{C}_z^{(0)})^{1/2}(\mathbf{C}_z^{(0)})^{1/2}\)</span> and <span class="math inline">\(\mathbf{C}_x^{(0)} = (\mathbf{C}_x^{(0)})^{1/2}(\mathbf{C}_x^{(0)})^{1/2}\)</span> (see <a href="ChapterAppendixA.html" class="quarto-xref"><span>Appendix A</span></a>). Thus, from <a href="#eq-CCAr" class="quarto-xref">Equation&nbsp;<span>2.15</span></a>, the square of the canonical correlation can be written as</p>
<p><span id="eq-CCAr2"><span class="math display">\[
r_1^2 = \frac{[\widetilde{\boldsymbol{\xi}}_1^\prime (\mathbf{C}_z^{(0)})^{-1/2} \mathbf{C}_{z,x}^{(0)} (\mathbf{C}_x^{(0)})^{-1/2} \widetilde{\boldsymbol{\psi}}_1]^2}{(\widetilde{\boldsymbol{\xi}}_1^\prime \widetilde{\boldsymbol{\xi}}_1)(\widetilde{\boldsymbol{\psi}}_1^\prime \widetilde{\boldsymbol{\psi}}_1)},
\tag{2.16}\]</span></span></p>
<p>with <span class="math inline">\(\widetilde{\boldsymbol{\xi}}_1 \equiv (\mathbf{C}_z^{(0)})^{1/2} \boldsymbol{\xi}_1\)</span> and <span class="math inline">\(\widetilde{\boldsymbol{\psi}}_1 \equiv (\mathbf{C}_x^{(0)})^{1/2} \boldsymbol{\psi}_1\)</span>. In the multivariate statistics literature (e.g., <span class="citation" data-cites="johnson1992applied">Johnson &amp; Wichern (<a href="references.html#ref-johnson1992applied" role="doc-biblioref">1992</a>)</span>, p.&nbsp;463), it is well known that <span class="math inline">\(r_1^2\)</span> corresponds to the largest singular value of the singular value decomposition (SVD; see <a href="ChapterAppendixA.html" class="quarto-xref"><span>Appendix A</span></a>) of</p>
<p><span id="eq-CCAsvd"><span class="math display">\[
(\mathbf{C}_z^{(0)})^{-1/2} \mathbf{C}_{z,x}^{(0)} (\mathbf{C}_x^{(0)})^{-1/2},
\tag{2.17}\]</span></span></p>
<p>where the normalized weight vectors <span class="math inline">\(\widetilde{\boldsymbol{\xi}}_1\)</span> and <span class="math inline">\(\widetilde{\boldsymbol{\psi}}_1\)</span> are the left and right singular vectors, respectively. Then we can obtain the unnormalized weights through <span class="math inline">\(\boldsymbol{\xi}_1 \equiv (\mathbf{C}_z^{(0)})^{-1/2} \widetilde{\boldsymbol{\xi}}_1\)</span> and <span class="math inline">\(\boldsymbol{\psi}_1 \equiv (\mathbf{C}_x^{(0)})^{-1/2} \widetilde{\boldsymbol{\psi}}_1\)</span>, respectively. As mentioned above, these are the first ST-CCA pattern maps. The corresponding time series of ST-CCA canonical variables are then calculated directly from <span class="math inline">\(a_1(t_j) = \boldsymbol{\xi}_1^\prime \mathbf{Z}_{t_j}\)</span> and <span class="math inline">\(b_1(t_j)
        = \boldsymbol{\psi}_1^\prime \mathbf{X}_{t_j}\)</span>, for <span class="math inline">\(j=1,\ldots,T\)</span>. More generally, <span class="math inline">\(\widetilde{\boldsymbol{\xi}}_k\)</span> and <span class="math inline">\(\widetilde{\boldsymbol{\psi}}_k\)</span> correspond to the left and right singular vectors associated with the <span class="math inline">\(k\)</span>th singular value (<span class="math inline">\(r^2_k\)</span>) in the SVD of <a href="#eq-CCAsvd" class="quarto-xref">Equation&nbsp;<span>2.17</span></a>. Then the unnormalized spatial-weights maps and the canonical time series are obtained analogously to the <span class="math inline">\(k=1\)</span> case.</p>
<p>In practice, to evaluate the SVD in <a href="#eq-CCAsvd" class="quarto-xref">Equation&nbsp;<span>2.17</span></a>, we must first calculate the empirical covariance matrices <span class="math inline">\(\widehat{\mathbf{C}}_z^{(0)}\)</span>, <span class="math inline">\(\widehat{\mathbf{C}}_x^{(0)}\)</span> using <a href="#eq-emp_cov" class="quarto-xref">Equation&nbsp;<span>2.4</span></a>, as well as the empirical cross-covariance matrix <span class="math inline">\(\widehat{\mathbf{C}}_{z,x}^{(0)}\)</span> given by <a href="#eq-emp_crosscov" class="quarto-xref">Equation&nbsp;<span>2.5</span></a>. Finally, we consider the SVD of <span class="math inline">\((\widehat{\mathbf{C}}_z^{(0)})^{-1/2} \widehat{\mathbf{C}}_{z,x}^{(0)} (\widehat{\mathbf{C}}_x^{(0)})^{-1/2}\)</span>. As mentioned in the text, the empirical covariance matrices can be unstable (or singular) unless <span class="math inline">\(T \gg \max(n,m)\)</span>, and so it is customary to work in EOF space; that is, project the data for one or both variables onto a lower-dimensional space given by a relatively few EOFs before carrying out ST-CCA.</p>
</div>
</div>
<div id="fig-CCA1" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-CCA1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="img/Chapter_2/CCA1.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-CCA1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;2.23: Time series of the first canonical variables, {a_1,b_1}, for <span class="math inline">\(\tau=7\)</span> month lagged monthly SST anomalies at time <span class="math inline">\(t_j-\tau\)</span> (blue) and at time <span class="math inline">\(t_j\)</span> (red).
</figcaption>
</figure>
</div>
<div id="fig-CCA2" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-CCA2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="img/Chapter_2/CCA2.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-CCA2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;2.24: Spatial-weights maps corresponding to the linear combination of EOFs used to construct the canonical variables for SST data lagged <span class="math inline">\(\tau=7\)</span> months (left) and unlagged SST data (right).
</figcaption>
</figure>
</div>
</section>
<section id="chapter-2-wrap-up" class="level2" data-number="2.6">
<h2 data-number="2.6" class="anchored" data-anchor-id="chapter-2-wrap-up"><span class="header-section-number">2.6</span> Chapter 2 Wrap-Up</h2>
<p>There were three main goals in this chapter. First, we wanted to expose the reader to some basic ideas about data structures in <code>R</code> that are useful for working with spatio-temporal data. Next, we wanted to illustrate some useful ways to visualize spatio-temporal data, noting that it can be particularly challenging to visualize dynamical evolution of spatial fields either without collapsing the spatial component onto one spatial dimension (e.g., as with the Hovmöller plots) or through animation. Finally, we wanted to describe some standard ways to explore spatio-temporal data in preparation for developing models in Chapter 3. In particular, we discussed the exploration of the first moments (means) in space or time, and the second-order structures (covariances) either jointly in space and time, or averaged over one of the dimensions (usually the time dimension) to give covariance and cross-covariance matrices. Stepping up the technical level, we considered eigenvector approaches to explore the structure and potentially reduce the dimensionality of the spatio-temporal data. Specifically, we considered EOFs and ST-CCA. Of these, the EOFs are the most ubiquitous in the literature. Even if the technical details were a bit elaborate, the end result is a powerful and interpretable visualization and exploration of spatio-temporal variability.</p>
<p>You now have the survival skills to start building statistical models for spatio-temporal data, with the goal of spatial prediction, parameter inference, or temporal forecasting. In subsequent chapters, spatio-temporal statistical models will be discussed from an introductory perspective in Chapter 3, from a descriptive perspective in Chapter 4, and from a dynamic perspective in Chapter 5.</p>
</section>
<section id="lab-2.1-data-wrangling" class="level2 unnumbered">
<h2 class="unnumbered anchored" data-anchor-id="lab-2.1-data-wrangling">Lab 2.1: Data Wrangling</h2>
<p></p>
<p></p>
<p>Spatio-temporal modeling and prediction generally involve substantial amounts of data that are available to the user in a variety of forms, but more often than not as tables in CSV files or text files. A considerable amount of time is usually spent in loading the data and pre-processing them in order to put them into a form that is suitable for analysis. Fortunately, there are several packages in <code>R</code> that help the user achieve these goals quickly; here we focus on the packages <strong>dplyr</strong> and <strong>tidyr</strong>, which contain functions particularly suited for the data manipulation techniques that are required. We first load the required packages, as well as <strong>STRbook</strong> (visit <a href="https://spacetimewithr.org">https://spacetimewithr.org</a> for instructions on how to install <strong>STRbook</strong>).</p>
<p></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"dplyr"</span>)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"tidyr"</span>)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"STRbook"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p></p>
<p>As a running example, we shall consider a data set from the National Oceanic and Atmospheric Administration (NOAA) that was provided to us as text in data tables available with the package <strong>STRbook</strong>. There are six data tables:</p>
<ul>
<li><code>Stationinfo.dat</code>. This table contains 328 rows (one for each station) and three columns (station ID, latitude coordinate, and longitude coordinate) containing information on the stations’ locations.</li>
<li><code>Times_1990.dat</code>. This table contains 1461 rows (one for each day between 01 January 1990 and 30 December 1993) and four columns (Julian date, year, month, day) containing the data time stamps.</li>
<li><code>Tmax_1990.dat</code>. This table contains 1461 rows (one for each time point) and 328 columns (one for each station location) containing all maximum temperature data with missing values coded as <span class="math inline">\(-9999\)</span>.</li>
<li><code>Tmin_1990.dat</code>. Same as <code>Tmax_1990.dat</code> but containing minimum temperature data.</li>
<li><code>TDP_1990.dat</code>. Same as <code>Tmax_1990.dat</code> but containing temperature dew point data with missing values coded as <span class="math inline">\(-999.90001\)</span>.</li>
<li><code>Precip_1990.dat</code>. Same as <code>Tmax_1990.dat</code> but containing precipitation data with missing values coded as <span class="math inline">\(-99.989998\)</span>.</li>
</ul>
<p>The first task is to reconcile all these data into one object. Before seeing how to use the spatio-temporal data classes to do this, we first consider the rather simpler task of reconciling them into a standard <code>R</code> data frame in long format.</p>
<section id="working-with-spatio-temporal-data-in-long-format" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="working-with-spatio-temporal-data-in-long-format">Working with Spatio-Temporal Data in Long Format</h3>
<p>The station locations, time stamps and maximum temperature data can be loaded into <code>R</code> from <strong>STRbook</strong> as follows.</p>
<p></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>locs <span class="ot">&lt;-</span> <span class="fu">read.table</span>(<span class="fu">system.file</span>(<span class="st">"extdata"</span>, <span class="st">"Stationinfo.dat"</span>,</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>                               <span class="at">package =</span> <span class="st">"STRbook"</span>),</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>                  <span class="at">col.names =</span> <span class="fu">c</span>(<span class="st">"id"</span>, <span class="st">"lat"</span>, <span class="st">"lon"</span>))</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>Times <span class="ot">&lt;-</span> <span class="fu">read.table</span>(<span class="fu">system.file</span>(<span class="st">"extdata"</span>, <span class="st">"Times_1990.dat"</span>,</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>                                <span class="at">package =</span> <span class="st">"STRbook"</span>),</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>                  <span class="at">col.names =</span> <span class="fu">c</span>(<span class="st">"julian"</span>, <span class="st">"year"</span>, <span class="st">"month"</span>, <span class="st">"day"</span>))</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>Tmax <span class="ot">&lt;-</span> <span class="fu">read.table</span>(<span class="fu">system.file</span>(<span class="st">"extdata"</span>, <span class="st">"Tmax_1990.dat"</span>,</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>                               <span class="at">package =</span> <span class="st">"STRbook"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p></p>
<p>In this case, <code>system.file</code> and its arguments are used to locate the data within the package <strong>STRbook</strong>, while <code>read.table</code> is the most important function used in <code>R</code> for reading data input from text files. By default, <code>read.table</code> assumes that data items are separated by a blank space, but this can be changed using the argument <code>sep</code>. Other important data input functions worth looking up include <code>read.csv</code> for comma-separated value files, and <code>read.delim</code>.</p>
<p>Above we have added the column names to the data <code>locs</code> and <code>Times</code> since these were not available with the original text tables. Since we did not assign column names to <code>Tmax</code>, the column names are the default ones assigned by <code>read.table</code>, that is, <code>V1, V2</code>, <span class="math inline">\(\dots\)</span>, <code>V328</code>. As these do not relate to the station ID in any way, we rename these columns as appropriate using the data in <code>locs</code>.</p>
<p></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(Tmax) <span class="ot">&lt;-</span> locs<span class="sc">$</span>id</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p></p>
<p>The other data can be loaded in a similar way to <code>Tmax</code>; we denote the resulting variables as <code>Tmin</code>, <code>TDP</code>, and <code>Precip</code>, respectively. One can, and should, use the functions <code>head</code> and <code>tail</code> to check that the loaded data are sensible.</p>
<p></p>
<p></p>
<p>Consider now the maximum-temperature data in the NOAA data set. Since each row in <code>Tmax</code> is associated with a time point, we can attach it columnwise to the data frame <code>Times</code> using <code>cbind</code>.</p>
<p></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>Tmax <span class="ot">&lt;-</span> <span class="fu">cbind</span>(Times, Tmax)</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(<span class="fu">names</span>(Tmax), <span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "julian" "year"   "month"  "day"    "3804"   "3809"   "3810"   "3811"  
 [9] "3812"   "3813"  </code></pre>
</div>
</div>
<p></p>
<p>Now <code>Tmax</code> contains the time information in the first four columns and temperature data in the other columns. To put <code>Tmax</code> into long format we need to identify a pair. In our case, the data are in space-wide format where the are the station IDs and the are the maximum temperatures (which we store in a field named <code>z</code>). The function we use to put the data frame into long format is <code>gather</code>. This function takes the data as first argument, the key–value pair, and then the next arguments are the names of any columns to exclude as values (in this case those relating to the time stamp).</p>
<p></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>Tmax_long <span class="ot">&lt;-</span> <span class="fu">gather</span>(Tmax, id, z, <span class="sc">-</span>julian, <span class="sc">-</span>year, <span class="sc">-</span>month, <span class="sc">-</span>day)</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(Tmax_long)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  julian year month day   id  z
1 726834 1990     1   1 3804 35
2 726835 1990     1   2 3804 42
3 726836 1990     1   3 3804 49
4 726837 1990     1   4 3804 59
5 726838 1990     1   5 3804 41
6 726839 1990     1   6 3804 45</code></pre>
</div>
</div>
<p></p>
<p>Note how <code>gather</code> has helped us achieve our goal: we now have a single row per measurement and multiple rows may be associated with the same time point. As is, the column <code>id</code> is of class <code>character</code> since it was extracted from the column names. Since the station ID is an integer it is more natural to ensure the field is of class <code>integer</code>.</p>
<p></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>Tmax_long<span class="sc">$</span>id <span class="ot">&lt;-</span> <span class="fu">as.integer</span>(Tmax_long<span class="sc">$</span>id)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p></p>
<p>There is little use to keep missing data (coded as <span class="math inline">\(-9999\)</span> in our case) when the data are in long format. To filter out these data we can use the function <code>filter</code>. Frequently it is better to use an criterion (e.g., less than) when filtering in this way rather than an criterion (is equal to) due to truncation error when storing data. This is what we do below, and filter out data with values less than <span class="math inline">\(-9998\)</span> rather than data with values equal to <span class="math inline">\(-9999\)</span>. This is particularly important when processing the other variables, such as precipitation, where the missing value is <span class="math inline">\(-99.989998\)</span>.</p>
<p></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="fu">nrow</span>(Tmax_long)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 479208</code></pre>
</div>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>Tmax_long <span class="ot">&lt;-</span> <span class="fu">filter</span>(Tmax_long, <span class="sc">!</span>(z <span class="sc">&lt;=</span> <span class="sc">-</span><span class="dv">9998</span>))</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="fu">nrow</span>(Tmax_long)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 196253</code></pre>
</div>
</div>
<p></p>
<p>Note how the number of rows in our data set (returned from the function <code>nrow</code>) has now decreased by more than half. One may also use the <code>R</code> function <code>subset</code>; however, <code>filter</code> tends to be faster for large data sets. Both <code>subset</code> and <code>filter</code> take a logical expression as instruction on how to filter out unwanted rows. As with <code>gather</code>, the column names in the logical expression do not appear as strings. In <code>R</code> this method of providing arguments is known as , and we shall see several instances of it in the course of the Labs.</p>
<p>Now assume we wish to include minimum temperature and the other variables inside this data frame too. The first thing we need to do is first make sure every measurement <code>z</code> is attributed to a process. In our case, we need to add a column, say <code>proc</code>, indicating what process the measurement relates to. There are a few ways in which to add a column to a data frame; here we shall introduce the function <code>mutate</code>, which will facilitate operations in the following Labs.</p>
<p></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>Tmax_long <span class="ot">&lt;-</span> <span class="fu">mutate</span>(Tmax_long, <span class="at">proc =</span> <span class="st">"Tmax"</span>)</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(Tmax_long)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  julian year month day   id  z proc
1 726834 1990     1   1 3804 35 Tmax
2 726835 1990     1   2 3804 42 Tmax
3 726836 1990     1   3 3804 49 Tmax
4 726837 1990     1   4 3804 59 Tmax
5 726838 1990     1   5 3804 41 Tmax
6 726839 1990     1   6 3804 45 Tmax</code></pre>
</div>
</div>
<p></p>
<p></p>
<p></p>
<p>Now repeat the same procedure with the other variables to obtain data frames <code>Tmin_long</code>, <code>TDP_long</code>, and <code>Precip_long</code> (remember the different codings for the missing values!). To save time, the resulting data frames can also be loaded directly from <strong>STRbook</strong> as follows.</p>
<p></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(Tmin_long, <span class="at">package =</span> <span class="st">"STRbook"</span>)</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(TDP_long, <span class="at">package =</span> <span class="st">"STRbook"</span>)</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(Precip_long, <span class="at">package =</span> <span class="st">"STRbook"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p></p>
<p>We can now construct our final data frame in long format by simply concatenating all these (rowwise) together using the function <code>rbind</code>.</p>
<p></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>NOAA_df_1990 <span class="ot">&lt;-</span> <span class="fu">rbind</span>(Tmax_long, Tmin_long, TDP_long, Precip_long)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p></p>
<p>There are many advantages of having data in long form. For example, it makes grouping and summarizing particularly easy. Let us say we want to find the mean value for each variable in each year. We do this using the functions <code>group_by</code> and <code>summarise</code>. The function <code>group_by</code> creates a , while <code>summarise</code> does an operation .</p>
<p></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>summ <span class="ot">&lt;-</span> <span class="fu">group_by</span>(NOAA_df_1990, year, proc) <span class="sc">%&gt;%</span>  <span class="co"># groupings</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>        <span class="fu">summarise</span>(<span class="at">mean_proc =</span> <span class="fu">mean</span>(z))          <span class="co"># operation</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>`summarise()` has grouped output by 'year'. You can override using the
`.groups` argument.</code></pre>
</div>
</div>
<p></p>
<p>Alternatively, we may wish to find out the number of days on which it did not rain at each station in June of every year. We can first filter out the other variables and then use <code>summarise</code>.</p>
<p></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>NOAA_precip <span class="ot">&lt;-</span> <span class="fu">filter</span>(NOAA_df_1990, proc <span class="sc">==</span> <span class="st">"Precip"</span> <span class="sc">&amp;</span> month <span class="sc">==</span> <span class="dv">6</span>)</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>summ <span class="ot">&lt;-</span> <span class="fu">group_by</span>(NOAA_precip, year, id) <span class="sc">%&gt;%</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>        <span class="fu">summarise</span>(<span class="at">days_no_precip =</span> <span class="fu">sum</span>(z <span class="sc">==</span> <span class="dv">0</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>`summarise()` has grouped output by 'year'. You can override using the
`.groups` argument.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(summ)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 3
# Groups:   year [1]
   year    id days_no_precip
  &lt;int&gt; &lt;int&gt;          &lt;int&gt;
1  1990  3804             19
2  1990  3810             26
3  1990  3811             21
4  1990  3812             24
5  1990  3813             25
6  1990  3816             23</code></pre>
</div>
</div>
<p></p>
<p>The median number of days with no recorded precipitation was</p>
<p></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="fu">median</span>(summ<span class="sc">$</span>days_no_precip)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 20</code></pre>
</div>
</div>
<p></p>
<p>In the <code>R</code>~code above, we have used the operator <code>$&gt;$</code>, known as the operator. This operator has its own nuances and should be used with care, but we find it provides a clear desciption of the processing pipeline a data set is passed through. We shall always use this operator as <code>x $&gt;$ f(y)</code>, which is shorthand for <code>f(x,y)</code>. For example, the June summaries above can be found equivalently using the commands</p>
<p></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>grps <span class="ot">&lt;-</span> <span class="fu">group_by</span>(NOAA_precip, year, id)</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>summ <span class="ot">&lt;-</span> <span class="fu">summarise</span>(grps, <span class="at">days_no_precip =</span> <span class="fu">sum</span>(z <span class="sc">==</span> <span class="dv">0</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p></p>
<p>There are other useful commands in <strong>dplyr</strong> that we use in other Labs. First, the function <code>arrange</code> sorts by a column. For example, <code>NOAA_df_1990</code> is sorted first by station ID, and then by time (Julian date). The following code sorts the data first by time and then by station ID.</p>
<p></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>NOAA_df_sorted <span class="ot">&lt;-</span> <span class="fu">arrange</span>(NOAA_df_1990, julian, id)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p></p>
<p>Calling <code>head``(NOAA_df_sorted)</code> reveals that no measurements on temperature dew point are available for the first few days of the data set.</p>
<p>Another useful function is <code>select</code>, which can be used to select or discard columns. For example, in the following, <code>df1</code> selects only the Julian date and the measurement while <code>df2</code> contains all columns except the Julian date.</p>
<p></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>df1 <span class="ot">&lt;-</span> <span class="fu">select</span>(NOAA_df_1990, julian, z)</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>df2 <span class="ot">&lt;-</span> <span class="fu">select</span>(NOAA_df_1990, <span class="sc">-</span>julian)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p></p>
<p>At present, our long data frame contains no spatial information attached to it. However, for each station ID we have an associated coordinate in the data frame <code>locs</code>. We can merge <code>locs</code> to <code>NOAA_df_1990</code> using the function <code>left_join</code>; this is considerably faster than the function <code>merge</code>. With <code>left_join</code> we need to supply the column field name by which we are merging. In our case, the field common to both data sets is <code>"id"</code>.</p>
<p></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>NOAA_df_1990 <span class="ot">&lt;-</span> <span class="fu">left_join</span>(NOAA_df_1990, locs, <span class="at">by =</span> <span class="st">"id"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p></p>
<p>Finally, it may be the case that one wishes to revert from long format to either space-wide or time-wide format. The reverse function of <code>gather</code> is <code>spread</code>. This also works by identifying the key–value pair in the data frame; the values are then “widened” into a table while the keys are used to label the columns. For example, the code below constructs a space-wide data frame of maximum temperatures, with each row denoting a different date and each column containing data <code>z</code> from a specific station <code>id</code>.</p>
<p></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>Tmax_long_sel <span class="ot">&lt;-</span> <span class="fu">select</span>(Tmax_long, julian, id, z)</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>Tmax_wide <span class="ot">&lt;-</span> <span class="fu">spread</span>(Tmax_long_sel, id, z)</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a><span class="fu">dim</span>(Tmax_wide)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1461  138</code></pre>
</div>
</div>
<p></p>
<p>The first column is the Julian date. Should one wish to construct a standard matrix containing these data, then one can simply drop this column and convert as follows.</p>
<p></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>M <span class="ot">&lt;-</span> <span class="fu">select</span>(Tmax_wide, <span class="sc">-</span>julian) <span class="sc">%&gt;%</span> <span class="fu">as.matrix</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p></p>
</section>
<section id="working-with-spatio-temporal-data-classes" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="working-with-spatio-temporal-data-classes">Working with Spatio-Temporal Data Classes</h3>
<p>Next, we convert the data into objects of class <code>STIDF</code> and <code>STFDF</code>; in these class names “DF” is short for “data frame,” which indicates that in addition to the spatio-temporal locations (which only need <code>STI</code> or <code>STF</code> objects), the objects will also contain data. These classes are defined in the package <strong>spacetime</strong>. Since sometimes we construct spatio-temporal objects using spatial objects we also need to load the package <strong>sp</strong>. For details on these classes see <span class="citation" data-cites="R_spacetime">Pebesma (<a href="references.html#ref-R_spacetime" role="doc-biblioref">2012</a>)</span>.</p>
<p></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"sp"</span>)</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"spacetime"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p></p>
<section id="constructing-an-stidf-object" class="level4 unnumbered">
<h4 class="unnumbered anchored" data-anchor-id="constructing-an-stidf-object">Constructing an <code>STIDF</code> Object</h4>
<p>The spatio-temporal object for irregular data, <code>STIDF</code>, can be constructed using two functions: <code>stConstruct</code> and <code>STIDF</code>. Let us focus on the maximum temperature in <code>Tmax_long</code>. The only thing we need to do before we call <code>stConstruct</code> is to define a formal time stamp from the <code>year,month,day</code> fields. First, we construct a field with the date in <code>year</code>–<code>month</code>–<code>day</code> format using the function <code>paste</code>, which concatenates strings together. Instead of typing <code>NOAA_df_1990$year, NOAA_df_1990$month</code> and <code>NOAA_df_1990$day</code> we embed the <code>paste</code> function within the function <code>with</code> to reduce code length.</p>
<p></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>NOAA_df_1990<span class="sc">$</span>date <span class="ot">&lt;-</span> <span class="fu">with</span>(NOAA_df_1990,</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>                       <span class="fu">paste</span>(year, month, day, <span class="at">sep =</span> <span class="st">"-"</span>))</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(NOAA_df_1990<span class="sc">$</span>date, <span class="dv">4</span>)   <span class="co"># show first four elements</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "1990-1-1" "1990-1-2" "1990-1-3" "1990-1-4"</code></pre>
</div>
</div>
<p></p>
<p>The field <code>date</code> is of type <code>character</code>. This field can now be converted into a <code>Date</code> object using <code>as.Date</code>.</p>
<p></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>NOAA_df_1990<span class="sc">$</span>date <span class="ot">&lt;-</span> <span class="fu">as.Date</span>(NOAA_df_1990<span class="sc">$</span>date)</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a><span class="fu">class</span>(NOAA_df_1990<span class="sc">$</span>date)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Date"</code></pre>
</div>
</div>
<p></p>
<p>Now we have everything in place to construct the spatio-temporal object of class <code>STIDF</code> for maximum temperature. The easiest way to do this is using <code>stConstruct</code>, in which we provide the data frame in long format and indicate which are the spatial and temporal coordinates. This is the bare minimum required for constructing a spatio-temporal data set.</p>
<p></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>Tmax_long2 <span class="ot">&lt;-</span> <span class="fu">filter</span>(NOAA_df_1990, proc <span class="sc">==</span> <span class="st">"Tmax"</span>)</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>STObj <span class="ot">&lt;-</span> <span class="fu">stConstruct</span>(<span class="at">x =</span> Tmax_long2,           <span class="co"># data set</span></span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>                     <span class="at">space =</span> <span class="fu">c</span>(<span class="st">"lon"</span>, <span class="st">"lat"</span>),  <span class="co"># spatial fields</span></span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>                     <span class="at">time =</span> <span class="st">"date"</span>)            <span class="co"># time field</span></span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a><span class="fu">class</span>(STObj)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "STIDF"
attr(,"package")
[1] "spacetime"</code></pre>
</div>
</div>
<p> The function <code>class</code> can be used to confirm we have successfully generated an object of class <code>STIDF</code>. There are several other options that can be used with <code>stConstruct</code>. For example, one can set the coordinate reference system or specify whether the time field indicates an instance or an interval. Type <code>help``(stConstruct)</code> into the <code>R</code> console for more details.</p>
<p>The function <code>STIDF</code> is slightly different from <code>stConstruct</code> as it requires one to also specify the spatial part as an object of class <code>Spatial</code> from the package <strong>sp</strong>. In our case, the spatial component is simply an object containing irregularly spaced data, which in the package <strong>sp</strong> is a <code>SpatialPoints</code> object. A <code>SpatialPoints</code> object may be constructed using the function <code>SpatialPoints</code> and by supplying the coordinates as arguments. As with <code>stConstruct</code>, several other arguments can also be supplied to <code>SpatialPoints</code>; see the help file of <code>SpatialPoints</code> for more details.</p>
<p></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>spat_part <span class="ot">&lt;-</span> <span class="fu">SpatialPoints</span>(<span class="at">coords =</span> Tmax_long2[, <span class="fu">c</span>(<span class="st">"lon"</span>, <span class="st">"lat"</span>)])</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>temp_part <span class="ot">&lt;-</span> Tmax_long2<span class="sc">$</span>date</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>STObj2 <span class="ot">&lt;-</span> <span class="fu">STIDF</span>(<span class="at">sp =</span> spat_part,</span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>                <span class="at">time =</span> temp_part,</span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>                <span class="at">data =</span> <span class="fu">select</span>(Tmax_long2, <span class="sc">-</span>date, <span class="sc">-</span>lon, <span class="sc">-</span>lat))</span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a><span class="fu">class</span>(STObj2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "STIDF"
attr(,"package")
[1] "spacetime"</code></pre>
</div>
</div>
<p></p>
</section>
<section id="constructing-an-stfdf-object" class="level4 unnumbered">
<h4 class="unnumbered anchored" data-anchor-id="constructing-an-stfdf-object">Constructing an <code>STFDF</code> Object</h4>
<p>A similar approach can be used to construct an <code>STFDF</code> object instead of an <code>STIDF</code> object. When the spatial points are fixed in time, we only need to provide as many spatial co-ord-in-ates as there are spatial points, in this case those of the station locations. We also need to provide the regular time stamps, that is, one for each day between 01 January 1990 and 30 December 1993. Finally, the data can be provided both in space-wide or time-wide format with <code>stConstruct</code>, and in long format with <code>STFDF</code>. Here we show how to use <code>STFDF</code>.</p>
<p>The spatial and temporal parts can be obtained from the original data as follows.</p>
<p></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>spat_part <span class="ot">&lt;-</span> <span class="fu">SpatialPoints</span>(<span class="at">coords =</span> locs[, <span class="fu">c</span>(<span class="st">"lon"</span>, <span class="st">"lat"</span>)])</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>temp_part <span class="ot">&lt;-</span> <span class="fu">with</span>(Times,</span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>                   <span class="fu">paste</span>(year, month, day, <span class="at">sep =</span> <span class="st">"-"</span>))</span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>temp_part <span class="ot">&lt;-</span> <span class="fu">as.Date</span>(temp_part)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p></p>
<p>The data need to be provided in long format, but now they must contain all the missing values too since a data point must be provided for every spatial and temporal combination. To get the data into long format we use <code>gather</code>.</p>
<p></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>Tmax_long3 <span class="ot">&lt;-</span> <span class="fu">gather</span>(Tmax, id, z, <span class="sc">-</span>julian, <span class="sc">-</span>year, <span class="sc">-</span>month, <span class="sc">-</span>day)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p></p>
<p>It is very important that the data frame in long format supplied to <code>STFDF</code> has the spatial index moving faster than the temporal index, and that the order of the spatial index is the same as that of the spatial component supplied.</p>
<p></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>Tmax_long3<span class="sc">$</span>id <span class="ot">&lt;-</span> <span class="fu">as.integer</span>(Tmax_long3<span class="sc">$</span>id)</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>Tmax_long3 <span class="ot">&lt;-</span> <span class="fu">arrange</span>(Tmax_long3,julian,id)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p></p>
<p>Confirming that the spatial ordering in <code>Tmax_long3</code> is the correct one can be done as follows.</p>
<p></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="fu">all</span>(<span class="fu">unique</span>(Tmax_long3<span class="sc">$</span>id) <span class="sc">==</span> locs<span class="sc">$</span>id)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] TRUE</code></pre>
</div>
</div>
<p></p>
<p>We are now ready to construct the <code>STFDF</code>.</p>
<p></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>STObj3 <span class="ot">&lt;-</span> <span class="fu">STFDF</span>(<span class="at">sp =</span> spat_part,</span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>                <span class="at">time =</span> temp_part,</span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>                <span class="at">data =</span> Tmax_long3)</span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a><span class="fu">class</span>(STObj3)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "STFDF"
attr(,"package")
[1] "spacetime"</code></pre>
</div>
</div>
<p></p>
<p>Since we will be using <code>STObj3</code> often in the Labs we further equip it with a coordinate reference system (see <span class="citation" data-cites="R_sppackage">Bivand et al. (<a href="references.html#ref-R_sppackage" role="doc-biblioref">2013</a>)</span> for details on these reference systems),</p>
<p></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="fu">proj4string</span>(STObj3) <span class="ot">&lt;-</span> <span class="fu">CRS</span>(<span class="st">"+proj=longlat +ellps=WGS84"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p></p>
<p>and replace the missing values (currently coded as <span class="math inline">\(-9999\)</span>) with <code>NA</code>s.</p>
<p></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>STObj3<span class="sc">$</span>z[STObj3<span class="sc">$</span>z <span class="sc">==</span> <span class="sc">-</span><span class="dv">9999</span>] <span class="ot">&lt;-</span> <span class="cn">NA</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p></p>
<p>For ease of access, this object is saved as a data file in <strong>STRbook</strong> and can be loaded using the command <code>data("STObj3", package = "STRbook")</code>.</p>
<p></p>
<p></p>
</section>
</section>
</section>
<section id="lab-2.2-visualization" class="level2 unnumbered">
<h2 class="unnumbered anchored" data-anchor-id="lab-2.2-visualization">Lab 2.2: Visualization</h2>
<p>In this Lab we shall visualize maximum temperature data in the NOAA data set. Specifically, we consider the maximum recorded temperature between May 1993 and September 1993 (inclusive). The packages we need are <strong>animation</strong>, <strong>dplyr</strong>, <strong>ggplot2</strong>, <strong>gstat</strong>, <strong>maps</strong>, and <strong>STRbook</strong>.</p>
<p></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"animation"</span>)</span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"dplyr"</span>)</span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"ggplot2"</span>)</span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"gstat"</span>)</span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"maps"</span>)</span>
<span id="cb50-6"><a href="#cb50-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"STRbook"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p></p>
<p></p>
<p></p>
<p>In order to ensure consistency of results and visualizations we fix the seed to 1.</p>
<p></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p></p>
<p>We now load the data set and take a subset of it using the function <code>filter</code>.</p>
<p></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(<span class="st">"NOAA_df_1990"</span>, <span class="at">package =</span> <span class="st">"STRbook"</span>)</span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>Tmax <span class="ot">&lt;-</span> <span class="fu">filter</span>(NOAA_df_1990,     <span class="co"># subset the data</span></span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a>              proc <span class="sc">==</span> <span class="st">"Tmax"</span> <span class="sc">&amp;</span>   <span class="co"># only max temperature</span></span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a>              month <span class="sc">%in%</span> <span class="dv">5</span><span class="sc">:</span><span class="dv">9</span> <span class="sc">&amp;</span>   <span class="co"># May to September</span></span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a>              year <span class="sc">==</span> <span class="dv">1993</span>)      <span class="co"># year of 1993</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p></p>
<p>The data frame we shall work with is hence denoted by <code>Tmax</code>. The first six records in <code>Tmax</code> are:</p>
<p></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>Tmax <span class="sc">%&gt;%</span> <span class="fu">select</span>(lon, lat, date, julian, z) <span class="sc">%&gt;%</span> <span class="fu">head</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>        lon   lat       date julian  z
1 -81.43333 39.35 1993-05-01 728050 82
2 -81.43333 39.35 1993-05-02 728051 84
3 -81.43333 39.35 1993-05-03 728052 79
4 -81.43333 39.35 1993-05-04 728053 72
5 -81.43333 39.35 1993-05-05 728054 73
6 -81.43333 39.35 1993-05-06 728055 78</code></pre>
</div>
</div>
<p></p>
<p>The first record has a Julian date of 728050, corresponding to 01 May 1993. To ease the following operations, we create a new variable <code>t</code> that is equal to 1 when <code>julian == 728050</code> and increases by 1 for each day in the record.</p>
<p></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a>Tmax<span class="sc">$</span>t <span class="ot">&lt;-</span> Tmax<span class="sc">$</span>julian <span class="sc">-</span> <span class="dv">728049</span>     <span class="co"># create a new time variable</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p></p>
<p>The first task faced by the spatio-temporal modeler is data visualization. This is an important preliminary task that needs to be carried out prior to the exploratory-data-analysis stage and the modeling stages. Throughout, we shall make extensive use of the <em>grammar of graphics</em> package <strong>ggplot2</strong>, which is a convenient way to plot and visualize data and results in <code>R</code>. The book by <span class="citation" data-cites="R_ggplot2">Wickham (<a href="references.html#ref-R_ggplot2" role="doc-biblioref">2016</a>)</span> provides a comprehensive introduction to <strong>ggplot2</strong>.</p>
<section id="spatial-plots-1" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="spatial-plots-1">Spatial Plots</h3>
<p>Visualization techniques vary with the data being analyzed. The NOAA data are collected at stations that are fixed in space; therefore, initial plots should give the modeler an idea of the overall spatial variation of the observed data. If there are many time points, usually only a selection of time points are chosen for visualization. In this case we choose three time points.</p>
<p></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a>Tmax_1 <span class="ot">&lt;-</span> <span class="fu">subset</span>(Tmax, t <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">15</span>, <span class="dv">30</span>))  <span class="co"># extract data</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p></p>
<p>The variable <code>Tmax_1</code> contains the data associated with the first, fifteenth, and thirtieth day in <code>Tmax</code>. We now plot this data subset using <strong>ggplot2</strong>. Note that the function <code>col_scale</code>, below, is simply a wrapper for the <strong>ggplot2</strong> function <code>scale_colour_distiller</code>, and is provided with <strong>STRbook</strong>.</p>
<p></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a>NOAA_plot <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(Tmax_1) <span class="sc">+</span>             <span class="co"># plot points</span></span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">x =</span> lon,<span class="at">y =</span> lat,       <span class="co"># lon and lat</span></span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a>                   <span class="at">colour =</span> z),           <span class="co"># attribute color</span></span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a>               <span class="at">size =</span> <span class="dv">2</span>) <span class="sc">+</span>                <span class="co"># make all points larger</span></span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">col_scale</span>(<span class="at">name =</span> <span class="st">"degF"</span>) <span class="sc">+</span>            <span class="co"># attach color scale</span></span>
<span id="cb57-6"><a href="#cb57-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">xlab</span>(<span class="st">"Longitude (deg)"</span>) <span class="sc">+</span>             <span class="co"># x-axis label</span></span>
<span id="cb57-7"><a href="#cb57-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ylab</span>(<span class="st">"Latitude (deg)"</span>) <span class="sc">+</span>              <span class="co"># y-axis label</span></span>
<span id="cb57-8"><a href="#cb57-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_path</span>(<span class="at">data =</span> <span class="fu">map_data</span>(<span class="st">"state"</span>),   <span class="co"># add US states map</span></span>
<span id="cb57-9"><a href="#cb57-9" aria-hidden="true" tabindex="-1"></a>          <span class="fu">aes</span>(<span class="at">x =</span> long, <span class="at">y =</span> lat, <span class="at">group =</span> group)) <span class="sc">+</span></span>
<span id="cb57-10"><a href="#cb57-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">facet_grid</span>(<span class="sc">~</span>date) <span class="sc">+</span>                   <span class="co"># facet by time</span></span>
<span id="cb57-11"><a href="#cb57-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">coord_fixed</span>(<span class="at">xlim =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">105</span>, <span class="sc">-</span><span class="dv">75</span>),</span>
<span id="cb57-12"><a href="#cb57-12" aria-hidden="true" tabindex="-1"></a>                <span class="at">ylim =</span> <span class="fu">c</span>(<span class="dv">25</span>, <span class="dv">50</span>))  <span class="sc">+</span>      <span class="co"># zoom in</span></span>
<span id="cb57-13"><a href="#cb57-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_bw</span>()                            <span class="co"># B&amp;W theme</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p></p>
<p></p>
<p></p>
<p><code>NOAA_plot</code> is a plot of the spatial locations of the stations. The function <code>aes</code> (short for aesthetics) for <code>geom_point</code> identifies which field in the data frame <code>Tmax_1</code> is the <span class="math inline">\(x\)</span>-coordinate and which is the <span class="math inline">\(y\)</span>-coordinate. <strong>ggplot2</strong> also allows one to attribute color (and size, if desired) to other fields in a similar fashion. Use the command <code>print(NOAA_plot)</code> to display the plot. The command <code>print(NOAA_plot)</code> generates the figure shown in <a href="#fig-NOAA" class="quarto-xref">Figure&nbsp;<span>2.1</span></a>. As can be seen, the stations are approximately regularly spaced within the domain.</p>
<p>When working with geographic data, it is also good practice to put the spatial locations of the data into perspective, by plotting country or state boundaries together with the data locations. Above, the US state boundaries are obtained from the <strong>maps</strong> package through the command <code>map_data("state")</code>. The boundaries are then overlayed on the plot using <code>geom_path</code>, which simply joins the points and draws the resulting path with <code>x</code> against <code>y</code>. Projections can be applied by adding another layer to the <strong>ggplot2</strong> object using <code>coord_map</code>. For example adding + <code>coord_map(projection = "sinusoidal")</code> will plot using a sinusoidal projection. One can also plot in three dimensions by using <code>projection = "ortho"</code>.</p>
<p>In this example we have used <strong>ggplot2</strong> to plot <em>point-referenced data</em>. Plots of regular lattice data, such as those shown in <a href="#fig-SST" class="quarto-xref">Figure&nbsp;<span>2.2</span></a>, are generated similarly by using <code>geom_tile</code> instead. Plots of irregular lattice data are generated using <code>geom_polygon</code>. As an example of the latter, consider the BEA income data set. These data can be loaded from <strong>STRbook</strong> as follows.</p>
<p></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(<span class="st">"BEA"</span>, <span class="at">package =</span> <span class="st">"STRbook"</span>)</span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(BEA <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="sc">-</span>Description), <span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>         NAME10 X1970 X1980 X1990
6     Adair, MO  2723  7399 12755
9    Andrew, MO  3577  7937 15059
12 Atchison, MO  3770  5743 14748</code></pre>
</div>
</div>
<p></p>
<p>From the first three records, we can see that the data set contains the personal income, in dollars, by county and by year for the years 1970, 1980 and 1990. These data need to be merged with Missouri county data which contain geospatial information. These county data, which are also available in <strong>STRbook</strong>, were originally processed from a shapefile that was freely available online at <a href="http://msdis-archive.missouri.edu/archive/metadata_gos/MO_2010_TIGER_Census_County_Boundaries.xml">http://msdis-archive.missouri.edu/archive/metadata_gos/MO_2010_TIGER_Census_County_Boundaries.xml</a>.</p>
<p></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(<span class="st">"MOcounties"</span>, <span class="at">package =</span> <span class="st">"STRbook"</span>)</span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(MOcounties <span class="sc">%&gt;%</span> <span class="fu">select</span>(long, lat, NAME10), <span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>      long     lat    NAME10
1 627911.9 4473554 Clark, MO
2 627921.4 4473559 Clark, MO
3 627923.0 4473560 Clark, MO</code></pre>
</div>
</div>
<p></p>
<p>The data set contains the boundary points for the counties, amongst several other variables which we do not explore here. For example, to plot the boundary of the first county one can simply type:</p>
<p></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a>County1 <span class="ot">&lt;-</span> <span class="fu">filter</span>(MOcounties, NAME10 <span class="sc">==</span> <span class="st">"Clark, MO"</span>)</span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(County1<span class="sc">$</span>long, County1<span class="sc">$</span>lat)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p></p>
<p>To add the BEA income data to the county data containing geospatial information we use <code>left_join</code>.</p>
<p></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a>MOcounties <span class="ot">&lt;-</span> <span class="fu">left_join</span>(MOcounties, BEA, <span class="at">by =</span> <span class="st">"NAME10"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p></p>
<p>Now it is just a matter of calling <code>ggplot</code> with <code>geom_polygon</code> to display the BEA income data as spatial polygons. We also use <code>geom_path</code> to draw the county boundaries. Below we show the code for 1970; similar code would be needed for 1980 and 1990. Note the use of the <code>group</code> argument to identify which points correspond to which county. The resulting plots are shown in <a href="#fig-BEA" class="quarto-xref">Figure&nbsp;<span>2.4</span></a>.</p>
<p></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a>g1 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(MOcounties) <span class="sc">+</span></span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_polygon</span>(<span class="fu">aes</span>(<span class="at">x =</span> long, <span class="at">y =</span> lat,     <span class="co"># county boundary</span></span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a>                     <span class="at">group =</span> NAME10,        <span class="co"># county group</span></span>
<span id="cb64-4"><a href="#cb64-4" aria-hidden="true" tabindex="-1"></a>                     <span class="at">fill =</span> <span class="fu">log</span>(X1970))) <span class="sc">+</span>  <span class="co"># log of income</span></span>
<span id="cb64-5"><a href="#cb64-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_path</span>(<span class="fu">aes</span>(<span class="at">x =</span> long, <span class="at">y =</span> lat,        <span class="co"># county boundary</span></span>
<span id="cb64-6"><a href="#cb64-6" aria-hidden="true" tabindex="-1"></a>                  <span class="at">group =</span> NAME10)) <span class="sc">+</span>        <span class="co"># county group</span></span>
<span id="cb64-7"><a href="#cb64-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">fill_scale</span>(<span class="at">limits =</span> <span class="fu">c</span>(<span class="fl">7.5</span>,<span class="fl">10.2</span>),</span>
<span id="cb64-8"><a href="#cb64-8" aria-hidden="true" tabindex="-1"></a>               <span class="at">name =</span> <span class="st">"log($)"</span>)  <span class="sc">+</span></span>
<span id="cb64-9"><a href="#cb64-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">coord_fixed</span>() <span class="sc">+</span> <span class="fu">ggtitle</span>(<span class="st">"1970"</span>) <span class="sc">+</span>       <span class="co"># annotations</span></span>
<span id="cb64-10"><a href="#cb64-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">xlab</span>(<span class="st">"x (m)"</span>) <span class="sc">+</span> <span class="fu">ylab</span>(<span class="st">"y (m)"</span>) <span class="sc">+</span> <span class="fu">theme_bw</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p></p>
<p>Type <code>print(g1)</code> in the R console to display the plot.</p>
<p></p>
<p></p>
<p></p>
<p></p>
</section>
<section id="time-series-plots-1" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="time-series-plots-1">Time-Series Plots</h3>
<p>Next, we look at the time series associated with the maximum temperature data in the NOAA data set. One can plot the time series at all 139 weather stations (and this is recommended); here we look at the time series at a set of stations selected at random. We first obtain the set of unique station identifiers, choose 10 at random from these, and extract the data associated with these 10 stations from the data set.</p>
<p></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a>UIDs <span class="ot">&lt;-</span> <span class="fu">unique</span>(Tmax<span class="sc">$</span>id)                     <span class="co"># extract IDs</span></span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a>UIDs_sub <span class="ot">&lt;-</span> <span class="fu">sample</span>(UIDs, <span class="dv">10</span>)                <span class="co"># sample 10 IDs</span></span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a>Tmax_sub <span class="ot">&lt;-</span> <span class="fu">filter</span>(Tmax, id <span class="sc">%in%</span> UIDs_sub)  <span class="co"># subset data</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p></p>
<p>To visualize the time series at these stations, we use <em>facets</em>. When given a long data frame, one can first subdivide the data frame into groups and generate a plot for each group. The following code displays the time series at each station. The command we use is <code>facet_wrap</code>, which automatically adjusts the number of rows and columns in which to display the facets. The command <code>facet_grid</code> instead uses columns for one grouping variable and rows for a second grouping variable, if specified.</p>
<p></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a>TmaxTS <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(Tmax_sub) <span class="sc">+</span></span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> t, <span class="at">y =</span> z)) <span class="sc">+</span> <span class="co"># line plot of z against t</span></span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">facet_wrap</span>(<span class="sc">~</span>id, <span class="at">ncol =</span> <span class="dv">5</span>) <span class="sc">+</span>    <span class="co"># facet by station</span></span>
<span id="cb66-4"><a href="#cb66-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">xlab</span>(<span class="st">"Day number (days)"</span>) <span class="sc">+</span>    <span class="co"># x label</span></span>
<span id="cb66-5"><a href="#cb66-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ylab</span>(<span class="st">"Tmax (degF)"</span>) <span class="sc">+</span>          <span class="co"># y label</span></span>
<span id="cb66-6"><a href="#cb66-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_bw</span>() <span class="sc">+</span>                   <span class="co"># BW theme</span></span>
<span id="cb66-7"><a href="#cb66-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">panel.spacing =</span> <span class="fu">unit</span>(<span class="dv">1</span>, <span class="st">"lines"</span>)) <span class="co"># facet spacing</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p></p>
<p></p>
<p></p>
<p>The argument <code>~id</code> supplied to <code>facet_wrap</code> is a <code>formula</code> in <code>R</code>. In this case, the formula is used to denote the groups by which we are faceting. The syntax <code>x~y</code> can be used to facet by two variables. The command <code>print(TmaxTS)</code> produces the required figure.</p>
</section>
<section id="hovmöller-plots" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="hovmöller-plots">Hovmöller Plots</h3>
<p>A Hovmöller plot is a two-dimensional space-time visualization, where space is collapsed (projected or averaged) onto one dimension; the second dimension then denotes time. A Hovmöller plot can be generated relatively easily if the data are on a space-time grid, but unfortunately this is rarely the case! This is where data-wrangling techniques such as those explored in Lab 2.1 come in handy.</p>
<p>Consider the latitudinal Hovmöller plot. The first step is to generate a regular grid of, say, 25 spatial points and 100 temporal points using the function <code>expand.grid</code>, with limits set to the latitudinal and temporal limits available in the data set.</p>
<p></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a>lim_lat <span class="ot">&lt;-</span> <span class="fu">range</span>(Tmax<span class="sc">$</span>lat)        <span class="co"># latitude range</span></span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a>lim_t <span class="ot">&lt;-</span> <span class="fu">range</span>(Tmax<span class="sc">$</span>t)            <span class="co"># time range</span></span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a>lat_axis <span class="ot">&lt;-</span> <span class="fu">seq</span>(lim_lat[<span class="dv">1</span>],       <span class="co"># latitude axis</span></span>
<span id="cb67-4"><a href="#cb67-4" aria-hidden="true" tabindex="-1"></a>                lim_lat[<span class="dv">2</span>],</span>
<span id="cb67-5"><a href="#cb67-5" aria-hidden="true" tabindex="-1"></a>                <span class="at">length=</span><span class="dv">25</span>)</span>
<span id="cb67-6"><a href="#cb67-6" aria-hidden="true" tabindex="-1"></a>t_axis <span class="ot">&lt;-</span> <span class="fu">seq</span>(lim_t[<span class="dv">1</span>],           <span class="co"># time axis</span></span>
<span id="cb67-7"><a href="#cb67-7" aria-hidden="true" tabindex="-1"></a>              lim_t[<span class="dv">2</span>],</span>
<span id="cb67-8"><a href="#cb67-8" aria-hidden="true" tabindex="-1"></a>              <span class="at">length=</span><span class="dv">100</span>)</span>
<span id="cb67-9"><a href="#cb67-9" aria-hidden="true" tabindex="-1"></a>lat_t_grid <span class="ot">&lt;-</span> <span class="fu">expand.grid</span>(<span class="at">lat =</span> lat_axis,</span>
<span id="cb67-10"><a href="#cb67-10" aria-hidden="true" tabindex="-1"></a>                          <span class="at">t =</span> t_axis)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p></p>
<p>We next need to associate each station’s latitudinal coordinate with the closest one on the grid. This can be done by finding the distance from the station’s latitudinal coordinate to each point of the grid, finding which gridpoint is the closest, and allocating that to it. We store the gridded data in <code>Tmax_grid</code>.</p>
<p></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a>Tmax_grid <span class="ot">&lt;-</span> Tmax</span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a>dists <span class="ot">&lt;-</span> <span class="fu">abs</span>(<span class="fu">outer</span>(Tmax<span class="sc">$</span>lat, lat_axis, <span class="st">"-"</span>))</span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a>Tmax_grid<span class="sc">$</span>lat <span class="ot">&lt;-</span> lat_axis[<span class="fu">apply</span>(dists, <span class="dv">1</span>, which.min)]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p></p>
<p>Now that we have associated each station with a latitudinal coordinate, all that is left is to group by latitude and time, and then we average all station values falling in the latitude–time bands.</p>
<p></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a>Tmax_lat_Hov <span class="ot">&lt;-</span> <span class="fu">group_by</span>(Tmax_grid, lat, t) <span class="sc">%&gt;%</span></span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a>                <span class="fu">summarise</span>(<span class="at">z =</span> <span class="fu">mean</span>(z))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>`summarise()` has grouped output by 'lat'. You can override using the `.groups`
argument.</code></pre>
</div>
</div>
<p></p>
<p>In this case, every latitude–time band contains at least one data point, so that the Hovmöller plot contains no missing points on the established grid. This may not always be the case, and simple interpolation methods, such as <code>interp</code> from the <strong>akima</strong> package, can be used to fill out grid cells with no data.</p>
<p></p>
<p></p>
<p>Plotting gridded data is facilitated using the <strong>ggplot2</strong> function <code>geom_tile</code>. The function <code>geom_tile</code> is similar to <code>geom_point</code>, except that it assumes regularly spaced data and automatically uses rectangular patches in the plot. Since rectangular patches are “filled,” we use the <strong>STRbook</strong> function <code>fill_scale</code> instead of <code>col_scale</code>, which takes the legend title in the argument <code>name</code>.</p>
<p></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a>Hovmoller_lat <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(Tmax_lat_Hov) <span class="sc">+</span>            <span class="co"># take data</span></span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a>        <span class="fu">geom_tile</span>(<span class="fu">aes</span>(<span class="at">x =</span> lat, <span class="at">y =</span> t, <span class="at">fill =</span> z)) <span class="sc">+</span> <span class="co"># plot</span></span>
<span id="cb71-3"><a href="#cb71-3" aria-hidden="true" tabindex="-1"></a>        <span class="fu">fill_scale</span>(<span class="at">name =</span> <span class="st">"degF"</span>) <span class="sc">+</span>     <span class="co"># add color scale</span></span>
<span id="cb71-4"><a href="#cb71-4" aria-hidden="true" tabindex="-1"></a>        <span class="fu">scale_y_reverse</span>() <span class="sc">+</span>             <span class="co"># rev y scale</span></span>
<span id="cb71-5"><a href="#cb71-5" aria-hidden="true" tabindex="-1"></a>        <span class="fu">ylab</span>(<span class="st">"Day number (days)"</span>) <span class="sc">+</span>     <span class="co"># add y label</span></span>
<span id="cb71-6"><a href="#cb71-6" aria-hidden="true" tabindex="-1"></a>        <span class="fu">xlab</span>(<span class="st">"Latitude (degrees)"</span>) <span class="sc">+</span>    <span class="co"># add x label</span></span>
<span id="cb71-7"><a href="#cb71-7" aria-hidden="true" tabindex="-1"></a>        <span class="fu">theme_bw</span>()                      <span class="co"># change theme</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p></p>
<p></p>
<p></p>
<p>The function <code>scale_y_reverse</code> ensures that time increases from top to bottom, as is typical in Hovmöller plots. We can generate a longitude-based Hovmöller plot in the same way. Type <code>print(Hovmoller_lat)</code> in the R console to display the plot. The resulting Hovmöller plots are shown in <a href="#fig-Hovmoller_NOAA" class="quarto-xref">Figure&nbsp;<span>2.11</span></a>.</p>
<p></p>
<p></p>
<p></p>
<p></p>
</section>
<section id="animations-1" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="animations-1">Animations</h3>
<p>To generate an animation in <code>R</code>, one can use the package <strong>animation</strong>. First, we define a function that plots a spatial map of the maximum temperature as a function of time:</p>
<p></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a>Tmax_t <span class="ot">&lt;-</span> <span class="cf">function</span>(tau) {</span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a>    Tmax_sub <span class="ot">&lt;-</span> <span class="fu">filter</span>(Tmax, t <span class="sc">==</span> tau)        <span class="co"># subset data</span></span>
<span id="cb72-3"><a href="#cb72-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggplot</span>(Tmax_sub) <span class="sc">+</span></span>
<span id="cb72-4"><a href="#cb72-4" aria-hidden="true" tabindex="-1"></a>        <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">x =</span> lon, <span class="at">y =</span> lat, <span class="at">colour =</span> z),   <span class="co"># plot</span></span>
<span id="cb72-5"><a href="#cb72-5" aria-hidden="true" tabindex="-1"></a>                   <span class="at">size =</span> <span class="dv">4</span>) <span class="sc">+</span>                         <span class="co"># pt. size</span></span>
<span id="cb72-6"><a href="#cb72-6" aria-hidden="true" tabindex="-1"></a>        <span class="fu">col_scale</span>(<span class="at">name =</span> <span class="st">"z"</span>, <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">40</span>, <span class="dv">110</span>)) <span class="sc">+</span></span>
<span id="cb72-7"><a href="#cb72-7" aria-hidden="true" tabindex="-1"></a>        <span class="fu">theme_bw</span>() <span class="co"># B&amp;W theme</span></span>
<span id="cb72-8"><a href="#cb72-8" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p></p>
<p>The function above takes a day number <code>tau</code>, filters the data frame according to the day number, and then plots the maximum temperature at the stations as a spatial map.</p>
<p>Next, we construct a function that plots the data for every day in the data set. The function that generates the animation within an HTML webpage is <code>saveHTML</code>. This takes the function that plots the sequence of images and embeds them in a webpage (by default named <code>index.html</code>) using JavaScript. The function <code>saveHTML</code> takes many arguments; type the command</p>
<p></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a><span class="fu">help</span>(saveHTML)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p></p>
<p>in the <code>R</code> console for more details.</p>
<p></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a>gen_anim <span class="ot">&lt;-</span> <span class="cf">function</span>() {</span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span>(t <span class="cf">in</span> lim_t[<span class="dv">1</span>]<span class="sc">:</span>lim_t[<span class="dv">2</span>]){  <span class="co"># for each time point</span></span>
<span id="cb74-3"><a href="#cb74-3" aria-hidden="true" tabindex="-1"></a>       <span class="fu">plot</span>(<span class="fu">Tmax_t</span>(t))            <span class="co"># plot data at this time point</span></span>
<span id="cb74-4"><a href="#cb74-4" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb74-5"><a href="#cb74-5" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb74-6"><a href="#cb74-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-7"><a href="#cb74-7" aria-hidden="true" tabindex="-1"></a><span class="fu">ani.options</span>(<span class="at">interval =</span> <span class="fl">0.2</span>)     <span class="co"># 0.2s interval between frames</span></span>
<span id="cb74-8"><a href="#cb74-8" aria-hidden="true" tabindex="-1"></a><span class="fu">saveHTML</span>(<span class="fu">gen_anim</span>(),            <span class="co"># run the main function</span></span>
<span id="cb74-9"><a href="#cb74-9" aria-hidden="true" tabindex="-1"></a>         <span class="at">autoplay =</span> <span class="cn">FALSE</span>,      <span class="co"># do not play on load</span></span>
<span id="cb74-10"><a href="#cb74-10" aria-hidden="true" tabindex="-1"></a>         <span class="at">loop =</span> <span class="cn">FALSE</span>,          <span class="co"># do not loop</span></span>
<span id="cb74-11"><a href="#cb74-11" aria-hidden="true" tabindex="-1"></a>         <span class="at">verbose =</span> <span class="cn">FALSE</span>,       <span class="co"># no verbose</span></span>
<span id="cb74-12"><a href="#cb74-12" aria-hidden="true" tabindex="-1"></a>         <span class="at">outdir =</span> <span class="st">"."</span>,          <span class="co"># save to current dir</span></span>
<span id="cb74-13"><a href="#cb74-13" aria-hidden="true" tabindex="-1"></a>         <span class="at">single.opts =</span> <span class="st">"'controls': ['first', 'previous',</span></span>
<span id="cb74-14"><a href="#cb74-14" aria-hidden="true" tabindex="-1"></a><span class="st">                                     'play', 'next', 'last',</span></span>
<span id="cb74-15"><a href="#cb74-15" aria-hidden="true" tabindex="-1"></a><span class="st">                                      'loop', 'speed'],</span></span>
<span id="cb74-16"><a href="#cb74-16" aria-hidden="true" tabindex="-1"></a><span class="st">                                      'delayMin': 0"</span>,</span>
<span id="cb74-17"><a href="#cb74-17" aria-hidden="true" tabindex="-1"></a>         <span class="at">htmlfile =</span> <span class="st">"NOAA_anim.html"</span>)  <span class="co"># save filename</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p></p>
<p>To view the animation, load <code>NOAA_anim.html</code> from your working directory. The animation reveals dynamics within the spatio-temporal data that are not apparent using other visualization methods. For example, the maximum temperature clearly drifts from west to east at several points during the animation. This suggests that a dynamic spatio-temporal model that can capture this drift could provide a good fit to these data.</p>
<!-- PLOTS FOR SST DATA -->
<p></p>
<p></p>
<!-- PLOTS FOR BBS DATA -->
<p></p>
<p></p>
<!-- PLOTS FOR PCA DATA -->
<p></p>
<p></p>
</section>
</section>
<section id="lab-2.3-exploratory-data-analysis" class="level2 unnumbered">
<h2 class="unnumbered anchored" data-anchor-id="lab-2.3-exploratory-data-analysis">Lab 2.3: Exploratory Data Analysis</h2>
<p>In this Lab we carry out exploratory data analysis (EDA), which typically requires visualization techniques similar to those utilized in Lab 2.2. There are several ways in which to carry out EDA with spatio-temporal data; in this Lab we consider the construction and visualization of the empirical means and covariances, the use of empirical orthogonal functions and their associated principal component time series, semivariogram analysis, and spatio-temporal canonical correlation analysis.</p>
<p>For the first part of the Lab, as in Lab 2.2, we shall consider the daily maximum temperatures in the NOAA data set between May 1993 and September 1993 (inclusive). The packages we need are <strong>CCA</strong>, <strong>dplyr</strong>, <strong>ggplot2</strong>, <strong>gstat</strong>, <strong>sp</strong>, <strong>spacetime</strong>, <strong>STRbook</strong> and <strong>tidyr</strong>.</p>
<p></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb75"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"CCA"</span>)</span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"dplyr"</span>)</span>
<span id="cb75-3"><a href="#cb75-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"ggplot2"</span>)</span>
<span id="cb75-4"><a href="#cb75-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"gstat"</span>)</span>
<span id="cb75-5"><a href="#cb75-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"sp"</span>)</span>
<span id="cb75-6"><a href="#cb75-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"spacetime"</span>)</span>
<span id="cb75-7"><a href="#cb75-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"STRbook"</span>)</span>
<span id="cb75-8"><a href="#cb75-8" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"tidyr"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p></p>
<p></p>
<p></p>
<p>In order to ensure consistency of results and visualizations, we fix the seed to 1.</p>
<p></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p></p>
<p>We now load the NOAA data set using the <code>data</code> command. To keep the data size manageable, we take a subset of it corresponding to the maximum daily temperatures in the months May–September 1993. As in Lab 2.2 we also add a new variable <code>t</code> which starts at 1 at the beginning of the data set and increases by 1 each day.</p>
<p></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb77"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(<span class="st">"NOAA_df_1990"</span>, <span class="at">package =</span> <span class="st">"STRbook"</span>)</span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a>Tmax <span class="ot">&lt;-</span> <span class="fu">filter</span>(NOAA_df_1990,     <span class="co"># subset the data</span></span>
<span id="cb77-3"><a href="#cb77-3" aria-hidden="true" tabindex="-1"></a>              proc <span class="sc">==</span> <span class="st">"Tmax"</span> <span class="sc">&amp;</span>   <span class="co"># only max temperature</span></span>
<span id="cb77-4"><a href="#cb77-4" aria-hidden="true" tabindex="-1"></a>              month <span class="sc">%in%</span> <span class="dv">5</span><span class="sc">:</span><span class="dv">9</span> <span class="sc">&amp;</span>   <span class="co"># May to September</span></span>
<span id="cb77-5"><a href="#cb77-5" aria-hidden="true" tabindex="-1"></a>              year <span class="sc">==</span> <span class="dv">1993</span>)      <span class="co"># year of 1993</span></span>
<span id="cb77-6"><a href="#cb77-6" aria-hidden="true" tabindex="-1"></a>Tmax<span class="sc">$</span>t <span class="ot">&lt;-</span> Tmax<span class="sc">$</span>julian <span class="sc">-</span> <span class="dv">728049</span>   <span class="co"># create a new time variable</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p></p>
<section id="empirical-spatial-means" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="empirical-spatial-means">Empirical Spatial Means</h3>
<p>The empirical spatial mean of our data is given by <a href="#eq-Zmean" class="quarto-xref">Equation&nbsp;<span>2.1</span></a>. The empirical spatial mean is a spatial quantity that can be stored in a new data frame that contains the spatial locations and the respective average maximum temperature at each location. These, and other data manipulations to follow, can be carried out easily using the tools we learned in Lab 2.1. We group by longitude and latitude, and then we compute the average maximum temperature at each of the separate longitude–latitude coordinates.</p>
<p></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb78"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a>spat_av <span class="ot">&lt;-</span> <span class="fu">group_by</span>(Tmax, lat, lon) <span class="sc">%&gt;%</span>    <span class="co"># group by lon-lat</span></span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a>           <span class="fu">summarise</span>(<span class="at">mu_emp =</span> <span class="fu">mean</span>(z))     <span class="co"># mean for each lon-lat</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p></p>
<p>We can now plot the average maximum temperature per station and see how this varies according to longitude and latitude. The following plots are shown in <a href="#fig-NOAA_spat_means" class="quarto-xref">Figure&nbsp;<span>2.14</span></a>.</p>
<p></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb79"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a>lat_means <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(spat_av) <span class="sc">+</span></span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a>             <span class="fu">geom_point</span>(<span class="fu">aes</span>(lat, mu_emp)) <span class="sc">+</span></span>
<span id="cb79-3"><a href="#cb79-3" aria-hidden="true" tabindex="-1"></a>             <span class="fu">xlab</span>(<span class="st">"Latitude (deg)"</span>) <span class="sc">+</span></span>
<span id="cb79-4"><a href="#cb79-4" aria-hidden="true" tabindex="-1"></a>             <span class="fu">ylab</span>(<span class="st">"Maximum temperature (degF)"</span>) <span class="sc">+</span> <span class="fu">theme_bw</span>()</span>
<span id="cb79-5"><a href="#cb79-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-6"><a href="#cb79-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-7"><a href="#cb79-7" aria-hidden="true" tabindex="-1"></a>lon_means <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(spat_av) <span class="sc">+</span></span>
<span id="cb79-8"><a href="#cb79-8" aria-hidden="true" tabindex="-1"></a>             <span class="fu">geom_point</span>(<span class="fu">aes</span>(lon, mu_emp)) <span class="sc">+</span></span>
<span id="cb79-9"><a href="#cb79-9" aria-hidden="true" tabindex="-1"></a>             <span class="fu">xlab</span>(<span class="st">"Longitude (deg)"</span>) <span class="sc">+</span></span>
<span id="cb79-10"><a href="#cb79-10" aria-hidden="true" tabindex="-1"></a>             <span class="fu">ylab</span>(<span class="st">"Maximum temperature (degF)"</span>) <span class="sc">+</span> <span class="fu">theme_bw</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p></p>
<p></p>
<p></p>
</section>
<section id="empirical-temporal-means" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="empirical-temporal-means">Empirical Temporal Means</h3>
<p>We now generate the plot of <a href="#fig-NOAA_av" class="quarto-xref">Figure&nbsp;<span>2.15</span></a>. The empirical temporal mean can be computed easily using the tools we learned in Lab 2.1: first, group the data by time; and second, summarize using the <code>summarise</code> function.</p>
<p></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb80"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a>Tmax_av <span class="ot">&lt;-</span> <span class="fu">group_by</span>(Tmax, date) <span class="sc">%&gt;%</span></span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a>           <span class="fu">summarise</span>(<span class="at">meanTmax =</span> <span class="fu">mean</span>(z))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p></p>
<p>The variable <code>Tmax_av</code> is a data frame containing the average maximum temperature on each day (averaged across all the stations). This can be visualized easily, together with the original raw data, using <strong>ggplot2</strong>.</p>
<p></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb81"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a>gTmaxav <span class="ot">&lt;-</span></span>
<span id="cb81-2"><a href="#cb81-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb81-3"><a href="#cb81-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="at">data =</span> Tmax, <span class="fu">aes</span>(<span class="at">x =</span> date, <span class="at">y =</span> z, <span class="at">group =</span> id),</span>
<span id="cb81-4"><a href="#cb81-4" aria-hidden="true" tabindex="-1"></a>              <span class="at">colour =</span> <span class="st">"blue"</span>, <span class="at">alpha =</span> <span class="fl">0.04</span>) <span class="sc">+</span></span>
<span id="cb81-5"><a href="#cb81-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="at">data =</span> Tmax_av, <span class="fu">aes</span>(<span class="at">x =</span> date, <span class="at">y =</span> meanTmax)) <span class="sc">+</span></span>
<span id="cb81-6"><a href="#cb81-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">xlab</span>(<span class="st">"Month"</span>) <span class="sc">+</span> <span class="fu">ylab</span>(<span class="st">"Maximum temperature (degF)"</span>) <span class="sc">+</span></span>
<span id="cb81-7"><a href="#cb81-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_bw</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p></p>
<p></p>
<p></p>
</section>
<section id="empirical-covariances" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="empirical-covariances">Empirical Covariances</h3>
<p>Before obtaining the empirical covariances, it is important that all trends are removed (not just the intercept). One simple way to do this is to first fit a linear model (that has spatial and/or temporal covariates) to the data. Then plot the empirical covariances of the detrended data (i.e., the residuals). Linear-model fitting proceeds with use of the <code>lm</code> function in R. The residuals from <code>lm</code> can then be incorporated into the original data frame <code>Tmax</code>.</p>
<p>In the plots of <a href="#fig-TmaxTS" class="quarto-xref">Figure&nbsp;<span>2.9</span></a> we observed a quadratic tendency of temperature over the chosen time span. Therefore, in what follows, we consider time and time squared as covariates. Note the use of the function <code>I</code>. This is required for <code>R</code> to interpret the power sign <code>^</code> as an arithmetic operator instead of a formula operator.</p>
<p></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb82"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a>lm1 <span class="ot">&lt;-</span> <span class="fu">lm</span>(z <span class="sc">~</span> lat <span class="sc">+</span> t <span class="sc">+</span> <span class="fu">I</span>(t<span class="sc">^</span><span class="dv">2</span>), <span class="at">data =</span> Tmax) <span class="co"># fit a linear model</span></span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true" tabindex="-1"></a>Tmax<span class="sc">$</span>residuals <span class="ot">&lt;-</span> <span class="fu">residuals</span>(lm1)             <span class="co"># store the residuals</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p></p>
<p>We also need to consider the spatial locations of the stations, which we extract from <code>Tmax</code> used above.</p>
<p></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb83"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a>spat_df <span class="ot">&lt;-</span> <span class="fu">filter</span>(Tmax, t <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span> <span class="co"># lon/lat coords of stations</span></span>
<span id="cb83-2"><a href="#cb83-2" aria-hidden="true" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">select</span>(lon, lat)  <span class="sc">%&gt;%</span>   <span class="co"># select lon/lat only</span></span>
<span id="cb83-3"><a href="#cb83-3" aria-hidden="true" tabindex="-1"></a>            <span class="fu">arrange</span>(lon, lat)       <span class="co"># sort ascending by lon/lat</span></span>
<span id="cb83-4"><a href="#cb83-4" aria-hidden="true" tabindex="-1"></a>m <span class="ot">&lt;-</span> <span class="fu">nrow</span>(spat_av)                  <span class="co"># number of stations</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p></p>
<p>The most straightforward way to compute the empirical covariance matrix shown in <a href="#eq-emp_cov" class="quarto-xref">Equation&nbsp;<span>2.4</span></a> is using the <code>cov</code> function in R. When there are missing data, the usual way forward is to drop all records that are not complete (provided there are not too many of these). Specifically, if any of the elements in <span class="math inline">\(\mathbf{Z}_{t_j}\)</span> or <span class="math inline">\(\mathbf{Z}_{t_j - \tau}\)</span> are missing, the associated term in the summation of <a href="#eq-emp_cov" class="quarto-xref">Equation&nbsp;<span>2.4</span></a> is ignored altogether. The function <code>cov</code> implements this when the argument <code>use = 'complete.obs'</code> is supplied. If there are too many records that are incomplete, imputation, or the consideration of only subsets of stations, might be required.</p>
<p>In order to compute the empirical covariance matrices, we first need to put the data into space-wide format using <code>spread</code>.</p>
<p></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb84"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a>X <span class="ot">&lt;-</span> dplyr<span class="sc">::</span><span class="fu">select</span>(Tmax, lon, lat, residuals, t) <span class="sc">%&gt;%</span> <span class="co"># select columns</span></span>
<span id="cb84-2"><a href="#cb84-2" aria-hidden="true" tabindex="-1"></a>     <span class="fu">spread</span>(t, residuals) <span class="sc">%&gt;%</span>                 <span class="co"># make time-wide</span></span>
<span id="cb84-3"><a href="#cb84-3" aria-hidden="true" tabindex="-1"></a>     dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span>lon, <span class="sc">-</span>lat) <span class="sc">%&gt;%</span>                   <span class="co"># drop coord info</span></span>
<span id="cb84-4"><a href="#cb84-4" aria-hidden="true" tabindex="-1"></a>     <span class="fu">t</span>()                                      <span class="co"># make space-wide</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p></p>
<p>Now it is simply a matter of calling <code>cov(X, use = 'complete.obs')</code> for computing the lag-0 empirical covariance matrix. For the lag-1 empirical covariance matrix, we compute the covariance between the residuals from <code>X</code> excluding the first time point and <code>X</code> excluding the last time point.</p>
<p></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb85"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a>Lag0_cov <span class="ot">&lt;-</span> <span class="fu">cov</span>(X, <span class="at">use =</span> <span class="st">'complete.obs'</span>)</span>
<span id="cb85-2"><a href="#cb85-2" aria-hidden="true" tabindex="-1"></a>Lag1_cov <span class="ot">&lt;-</span> <span class="fu">cov</span>(X[<span class="sc">-</span><span class="dv">1</span>, ], X[<span class="sc">-</span><span class="fu">nrow</span>(X),], <span class="at">use =</span> <span class="st">'complete.obs'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p></p>
<p>In practice, it is very hard to gain any intuition from these matrices, since points in a two-dimensional space do not have any specific ordering. One can, for example, order the stations by longitude and then plot the permuted spatial covariance matrix, but this works best when the domain of interest is rectangular with a longitude span that is much larger than the latitude span. In our case, with a roughly square domain, a workaround is to split the domain into either latitudinal or longitudinal strips, and then plot the spatial covariance matrix associated with each strip. In the following, we split the domain into four longitudinal strips (similar code can be used to generate latitudinal strips).</p>
<p></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb86"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a>spat_df<span class="sc">$</span>n <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(spat_df)    <span class="co"># assign an index to each station</span></span>
<span id="cb86-2"><a href="#cb86-2" aria-hidden="true" tabindex="-1"></a>lim_lon <span class="ot">&lt;-</span> <span class="fu">range</span>(spat_df<span class="sc">$</span>lon)   <span class="co"># range of lon coordinates</span></span>
<span id="cb86-3"><a href="#cb86-3" aria-hidden="true" tabindex="-1"></a>lon_strips <span class="ot">&lt;-</span> <span class="fu">seq</span>(lim_lon[<span class="dv">1</span>],   <span class="co"># create 4 long. strip boundaries</span></span>
<span id="cb86-4"><a href="#cb86-4" aria-hidden="true" tabindex="-1"></a>                  lim_lon[<span class="dv">2</span>],</span>
<span id="cb86-5"><a href="#cb86-5" aria-hidden="true" tabindex="-1"></a>                  <span class="at">length =</span> <span class="dv">5</span>)</span>
<span id="cb86-6"><a href="#cb86-6" aria-hidden="true" tabindex="-1"></a>spat_df<span class="sc">$</span>lon_strip <span class="ot">&lt;-</span> <span class="fu">cut</span>(spat_df<span class="sc">$</span>lon,     <span class="co"># bin the lon into</span></span>
<span id="cb86-7"><a href="#cb86-7" aria-hidden="true" tabindex="-1"></a>                         lon_strips,      <span class="co"># their respective bins</span></span>
<span id="cb86-8"><a href="#cb86-8" aria-hidden="true" tabindex="-1"></a>                         <span class="at">labels =</span> <span class="cn">FALSE</span>,  <span class="co"># don't assign labels</span></span>
<span id="cb86-9"><a href="#cb86-9" aria-hidden="true" tabindex="-1"></a>                         <span class="at">include.lowest =</span> <span class="cn">TRUE</span>) <span class="co"># include edges</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p></p>
<p>The first six records of <code>spat_df</code> are:</p>
<p></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb87"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(spat_df)   <span class="co"># print the first 6 records of spat_df</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>        lon      lat n lon_strip
1 -99.96667 37.76667 1         1
2 -99.76667 36.30000 2         1
3 -99.68333 32.43333 3         1
4 -99.05000 35.00000 4         1
5 -98.81667 38.86666 5         1
6 -98.51667 33.98333 6         1</code></pre>
</div>
</div>
<p></p>
<p>Now that we know in which strip each station falls, we can subset the station data frame by strip and then sort the subsetted data frame by latitude. In <strong>STRbook</strong> we provide a function <code>plot_cov_strips</code> that takes an empirical covariance matrix <code>C</code> and a data frame in the same format as <code>spat_df</code>, and then plots the covariance matrix associated with each longitudinal strip. Plotting requires the package <strong>fields</strong>. We can plot the resulting lag-0 and lag-1 covariance matrices using the following code.</p>
<p></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb89"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_cov_strips</span>(Lag0_cov, spat_df)  <span class="co"># plot the lag-0 matrices</span></span>
<span id="cb89-2"><a href="#cb89-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_cov_strips</span>(Lag1_cov, spat_df)  <span class="co"># plot the lag-1 matrices</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p></p>
<p></p>
<p></p>
<p>As expected (see <a href="#fig-emp_cov_plots" class="quarto-xref">Figure&nbsp;<span>2.16</span></a>), the empirical spatial covariance matrices reveal the presence of spatial correlation in the residuals. The four lag-0 plots seem to be qualitatively similar, suggesting that there is no strong dependence on longitude. However, there is a dependence on latitude, and the spatial covariance appears to decrease with decreasing latitude. This dependence is a type of spatial <em>non-stationarity</em>, and such plots can be used to assess whether non-stationary spatio-temporal models are required or not.</p>
<p>Similar code can be used to generate spatial correlation (instead of covariance) image plots.</p>
<section id="semivariogram-analysis" class="level4 unnumbered">
<h4 class="unnumbered anchored" data-anchor-id="semivariogram-analysis">Semivariogram Analysis</h4>
<p>From now on, in order to simplify computations, we will use a subset of the data containing only observations in July. Computing the empirical semivariogram is much faster when using objects of class <code>STFDF</code> rather than <code>STIDF</code> since the regular space-time structure can be exploited. We hence take <code>STObj3</code> computed in Lab 2.1 (load using <code>data(STObj3)</code>) and subset the month of July 1993 as follows.</p>
<p></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb90"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(<span class="st">"STObj3"</span>, <span class="at">package =</span> <span class="st">"STRbook"</span>)</span>
<span id="cb90-2"><a href="#cb90-2" aria-hidden="true" tabindex="-1"></a>STObj4 <span class="ot">&lt;-</span> STObj3[, <span class="st">"1993-07-01::1993-07-31"</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p></p>
<p>For computing the sample semivariogram we use the function <code>variogram</code>. Although the function is named “variogram,” it is in fact the sample semivariogram that is computed. We bin the distances between measurement locations into bins of size 80 km, and consider at most six time lags.</p>
<p></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb91"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a>vv <span class="ot">&lt;-</span> <span class="fu">variogram</span>(<span class="at">object =</span> z <span class="sc">~</span> <span class="dv">1</span> <span class="sc">+</span> lat, <span class="co"># fixed effect component</span></span>
<span id="cb91-2"><a href="#cb91-2" aria-hidden="true" tabindex="-1"></a>                <span class="at">data =</span> STObj4,        <span class="co"># July data</span></span>
<span id="cb91-3"><a href="#cb91-3" aria-hidden="true" tabindex="-1"></a>                <span class="at">width =</span> <span class="dv">80</span>,           <span class="co"># spatial bin (80 km)</span></span>
<span id="cb91-4"><a href="#cb91-4" aria-hidden="true" tabindex="-1"></a>                <span class="at">cutoff =</span> <span class="dv">1000</span>,        <span class="co"># consider pts &lt; 1000 km apart</span></span>
<span id="cb91-5"><a href="#cb91-5" aria-hidden="true" tabindex="-1"></a>                <span class="at">tlags =</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">6</span>)    <span class="co"># 0 days to 6 days</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p></p>
<p></p>
<p></p>
<p></p>
<p></p>
<p>The command <code>plot(vv)</code> displays the empirical semivariogram. The plot suggests that there are considerable spatio-temporal correlations in the data; spatio-temporal modeling of the residuals is thus warranted.</p>
</section>
</section>
<section id="empirical-orthogonal-functions-1" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="empirical-orthogonal-functions-1">Empirical Orthogonal Functions</h3>
<p>Empirical orthogonal functions (EOFs) can reveal spatial structure in the data and can also be used for subsequent dimensionality reduction. EOFs can be obtained from the data through either a spectral decomposition of the covariance matrix or a singular value decomposition (SVD) of the detrended space-time data matrix. The data matrix has to be in space-wide format (i.e., where space varies along the columns and time varies along the rows).</p>
<p>For this part of the Lab we use the SST data set. The SST data set does not contain any missing values, which renders our task slightly easier than when data are missing. When data are missing, one typically needs to consider interpolation, median polishing, or other imputation methods to fill in the missing values prior to computing the EOFs.</p>
<p>First we load the sea-land mask, the lon-lat coordinates of the SST grid, and the SST data set itself which is in time-wide format.</p>
<p></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb92"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(<span class="st">"SSTlandmask"</span>, <span class="at">package =</span> <span class="st">"STRbook"</span>)</span>
<span id="cb92-2"><a href="#cb92-2" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(<span class="st">"SSTlonlat"</span>, <span class="at">package =</span> <span class="st">"STRbook"</span>)</span>
<span id="cb92-3"><a href="#cb92-3" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(<span class="st">"SSTdata"</span>, <span class="at">package =</span> <span class="st">"STRbook"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p></p>
<p>Since <code>SSTdata</code> contains readings over land, we delete these using <code>SSTlandmask</code>. Further, in order to consider whole years only, we take the first 396 months (33 years) of the data, containing SST values spanning 1970–2002.</p>
<p></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb93"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a>delete_rows <span class="ot">&lt;-</span> <span class="fu">which</span>(SSTlandmask <span class="sc">==</span> <span class="dv">1</span>)</span>
<span id="cb93-2"><a href="#cb93-2" aria-hidden="true" tabindex="-1"></a>SSTdata <span class="ot">&lt;-</span> SSTdata[<span class="sc">-</span>delete_rows, <span class="dv">1</span><span class="sc">:</span><span class="dv">396</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p></p>
<p>From <a href="#eq-scaledZ" class="quarto-xref">Equation&nbsp;<span>2.10</span></a> recall that prior to carrying out an SVD, we need to put the data set into space-wide format, mean-correct it, and then standardize it. Since <code>SSTdata</code> is in time-wide format, we first transpose it to make it space-wide.</p>
<p></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb94"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Put data into space-wide form</span></span>
<span id="cb94-2"><a href="#cb94-2" aria-hidden="true" tabindex="-1"></a>Z <span class="ot">&lt;-</span> <span class="fu">t</span>(SSTdata)</span>
<span id="cb94-3"><a href="#cb94-3" aria-hidden="true" tabindex="-1"></a><span class="fu">dim</span>(Z)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1]  396 2261</code></pre>
</div>
</div>
<p></p>
<p>Note that <code>Z</code> is of size 396 <span class="math inline">\(\times\)</span> 2261, and it is hence in space-wide format as required. <a href="#eq-scaledZ" class="quarto-xref">Equation&nbsp;<span>2.10</span></a> is implemented as follows.</p>
<p></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb96"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a><span class="do">## First find the matrix we need to subtract:</span></span>
<span id="cb96-2"><a href="#cb96-2" aria-hidden="true" tabindex="-1"></a>spat_mean <span class="ot">&lt;-</span> <span class="fu">apply</span>(SSTdata, <span class="dv">1</span>, mean)</span>
<span id="cb96-3"><a href="#cb96-3" aria-hidden="true" tabindex="-1"></a>nT <span class="ot">&lt;-</span> <span class="fu">ncol</span>(SSTdata)</span>
<span id="cb96-4"><a href="#cb96-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-5"><a href="#cb96-5" aria-hidden="true" tabindex="-1"></a><span class="do">## Then subtract and standardize:</span></span>
<span id="cb96-6"><a href="#cb96-6" aria-hidden="true" tabindex="-1"></a>Zspat_detrend <span class="ot">&lt;-</span> Z <span class="sc">-</span> <span class="fu">outer</span>(<span class="fu">rep</span>(<span class="dv">1</span>, nT), spat_mean)</span>
<span id="cb96-7"><a href="#cb96-7" aria-hidden="true" tabindex="-1"></a>Zt <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">/</span><span class="fu">sqrt</span>(nT <span class="sc">-</span> <span class="dv">1</span>)<span class="sc">*</span>Zspat_detrend</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p></p>
<p>Finally, to carry out the SVD we run</p>
<p></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb97"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a>E <span class="ot">&lt;-</span> <span class="fu">svd</span>(Zt)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p></p>
<p>The SVD returns a list <code>E</code> containing the matrices <span class="math inline">\(\mathbf{V}\)</span>, <span class="math inline">\(\mathbf{U}\)</span>, and the singular values <span class="math inline">\(\textrm{diag}(\mathbf{D})\)</span>. The matrix <span class="math inline">\(\mathbf{V}\)</span> contains the EOFs in space-wide format. We change the column names of this matrix, and append the lon-lat coordinates to it as follows.</p>
<p></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb98"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a>V <span class="ot">&lt;-</span> E<span class="sc">$</span>v</span>
<span id="cb98-2"><a href="#cb98-2" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(E<span class="sc">$</span>v) <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"EOF"</span>, <span class="dv">1</span><span class="sc">:</span><span class="fu">ncol</span>(SSTdata)) <span class="co"># label columns</span></span>
<span id="cb98-3"><a href="#cb98-3" aria-hidden="true" tabindex="-1"></a>EOFs <span class="ot">&lt;-</span> <span class="fu">cbind</span>(SSTlonlat[<span class="sc">-</span>delete_rows, ], E<span class="sc">$</span>v)</span>
<span id="cb98-4"><a href="#cb98-4" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(EOFs[, <span class="dv">1</span><span class="sc">:</span><span class="dv">6</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   lon lat         EOF1         EOF2        EOF3         EOF4
16 154 -29 -0.004915064 -0.012129566 -0.02882162 8.540892e-05
17 156 -29 -0.001412275 -0.002276177 -0.02552841 6.726077e-03
18 158 -29  0.000245909  0.002298082 -0.01933020 8.591251e-03
19 160 -29  0.001454972  0.002303585 -0.01905901 1.025538e-02
20 162 -29  0.002265778  0.001643138 -0.02251571 1.125295e-02
21 164 -29  0.003598762  0.003910823 -0.02311128 1.002285e-02</code></pre>
</div>
</div>
<p></p>
<p>The matrix <span class="math inline">\(\mathbf{U}\)</span> returned from <code>svd</code> contains the principal component time series in wide-table format (i.e., each column corresponds to a time series associated with an EOF). Here we use the function <code>gather</code> in the package <strong>tidyr</strong> that reverses the operation <code>spread</code>. That is, the function takes a spatio-temporal data set in wide-table format and puts it into long-table format. We instruct the function to gather every column except the column denoting time, and we assign the key-value pair <code>EOF</code>-<code>PC</code>:</p>
<p></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb100"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true" tabindex="-1"></a>TS <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(E<span class="sc">$</span>u) <span class="sc">%&gt;%</span>            <span class="co"># convert U to data frame</span></span>
<span id="cb100-2"><a href="#cb100-2" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="at">t =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(E<span class="sc">$</span>u)) <span class="sc">%&gt;%</span>    <span class="co"># add a time field</span></span>
<span id="cb100-3"><a href="#cb100-3" aria-hidden="true" tabindex="-1"></a>      <span class="fu">gather</span>(EOF, PC, <span class="sc">-</span>t)            <span class="co"># put columns (except time)</span></span>
<span id="cb100-4"><a href="#cb100-4" aria-hidden="true" tabindex="-1"></a>                                     <span class="co"># into long-table format with</span></span>
<span id="cb100-5"><a href="#cb100-5" aria-hidden="true" tabindex="-1"></a>                                     <span class="co"># EOF-PC as key-value pair</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p></p>
<p>Finally, the normalized time series are given by:</p>
<p></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb101"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb101-1"><a href="#cb101-1" aria-hidden="true" tabindex="-1"></a>TS<span class="sc">$</span>nPC <span class="ot">&lt;-</span> TS<span class="sc">$</span>PC <span class="sc">*</span> <span class="fu">sqrt</span>(nT <span class="sc">-</span> <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p></p>
<p>We now can use the visualization tools discussed earlier to visualize the EOFs and the (normalized) principal component time series during July 2003. In Figures <a href="#fig-EOFsA" class="quarto-xref">Figure&nbsp;<span>2.20</span></a> and <a href="#fig-EOFsB" class="quarto-xref">Figure&nbsp;<span>2.21</span></a>, we show the first three EOFs and the first three principal component time series. We can use the following code to illustrate the first EOF:</p>
<p></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb102"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(EOFs) <span class="sc">+</span> <span class="fu">geom_tile</span>(<span class="fu">aes</span>(<span class="at">x =</span> lon, <span class="at">y =</span> lat, <span class="at">fill =</span> EOF1)) <span class="sc">+</span></span>
<span id="cb102-2"><a href="#cb102-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">fill_scale</span>(<span class="at">name =</span> <span class="st">"degC"</span>) <span class="sc">+</span> <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb102-3"><a href="#cb102-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">xlab</span>(<span class="st">"Longitude (deg)"</span>) <span class="sc">+</span> <span class="fu">ylab</span>(<span class="st">"Latitude (deg)"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p></p>
<p></p>
<p></p>
<p>Plotting of other EOFs and principal component time series is left as an exercise to the reader. The EOFs reveal interesting spatial structure in the residuals. The second EOF is a west-east gradient, while the third EOF again reveals a temporally dependent north-south gradient. This north-south gradient has a lower effect in the initial part of the time series, and a higher effect towards the end.</p>
<p></p>
<p></p>
<p></p>
<p></p>
<p>EOFs can also be constructed by using <code>eof</code> in the package <strong>spacetime</strong>. With the latter, one must cast the data into an <code>STFDF</code> object using the function <code>stConstruct</code> before calling the function <code>eof</code>. The last example in the help file of <code>stConstruct</code> shows how one can do this from a space-wide matrix. The function <code>eof</code> uses <code>prcomp</code> (short for principal component analysis) to find the EOFs, which in turn uses <code>svd</code>.</p>
<p></p>
<p></p>
</section>
<section id="spatio-temporal-canonical-correlation-analysis-1" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="spatio-temporal-canonical-correlation-analysis-1">Spatio-Temporal Canonical Correlation Analysis</h3>
<p>We can carry out a canonical correlation analysis (CCA) using the package <strong>CCA</strong> in R. One cannot implement CCA on the raw data since <span class="math inline">\(T &lt; n\)</span>. Instead, we carry out CCA on the SST projected onto EOF space, specifically the first 10 EOFs which explain just over 74% of the variance of the signal (you can show this from the singular values in the object <code>E</code>). In this example, we consider the problem of long-lead prediction, and we check whether SST is a useful predictor for SST in 7 months’ time. To this end, we split the data set into two parts, one containing SST and another containing SST lagged by 7 months.</p>
<p></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb103"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb103-1"><a href="#cb103-1" aria-hidden="true" tabindex="-1"></a>nEOF <span class="ot">&lt;-</span> <span class="dv">10</span></span>
<span id="cb103-2"><a href="#cb103-2" aria-hidden="true" tabindex="-1"></a>EOFset1 <span class="ot">&lt;-</span> E<span class="sc">$</span>u[<span class="dv">1</span><span class="sc">:</span>(nT<span class="dv">-7</span>), <span class="dv">1</span><span class="sc">:</span>nEOF] <span class="sc">*</span> <span class="fu">sqrt</span>(nT <span class="sc">-</span> <span class="dv">1</span>)</span>
<span id="cb103-3"><a href="#cb103-3" aria-hidden="true" tabindex="-1"></a>EOFset2 <span class="ot">&lt;-</span> E<span class="sc">$</span>u[<span class="dv">8</span><span class="sc">:</span>nT, <span class="dv">1</span><span class="sc">:</span>nEOF] <span class="sc">*</span> <span class="fu">sqrt</span>(nT <span class="sc">-</span> <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p></p>
<p></p>
<p></p>
<p>The CCA is carried out by running the function <code>cancor</code>.</p>
<p></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb104"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb104-1"><a href="#cb104-1" aria-hidden="true" tabindex="-1"></a>cc <span class="ot">&lt;-</span> <span class="fu">cancor</span>(EOFset1, EOFset2)  <span class="co"># compute CCA</span></span>
<span id="cb104-2"><a href="#cb104-2" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">digits =</span> <span class="dv">3</span>)             <span class="co"># print to three d.p.</span></span>
<span id="cb104-3"><a href="#cb104-3" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(cc<span class="sc">$</span>cor[<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>])              <span class="co"># print</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.843 0.758 0.649 0.584 0.463</code></pre>
</div>
<div class="sourceCode cell-code" id="cb106"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb106-1"><a href="#cb106-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(cc<span class="sc">$</span>cor[<span class="dv">6</span><span class="sc">:</span><span class="dv">10</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.4137 0.3067 0.2058 0.0700 0.0273</code></pre>
</div>
</div>
<p></p>
<p>The returned quantity <code>cc$cor</code> provides the correlations between the canonical variates of the unshifted and shifted SSTs in EOF space. The correlations decrease, as expected, but the first two canonical variates are highly correlated. The time series of the first canonical variables can be found by multiplying the EOF weights with the computed coefficients as follows (see <a href="#eq-CCA_a" class="quarto-xref">Equation&nbsp;<span>2.13</span></a> and <a href="#eq-CCA_b" class="quarto-xref">Equation&nbsp;<span>2.14</span></a>).</p>
<p></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb108"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb108-1"><a href="#cb108-1" aria-hidden="true" tabindex="-1"></a>CCA_df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">t =</span> <span class="dv">1</span><span class="sc">:</span>(nT <span class="sc">-</span> <span class="dv">7</span>),</span>
<span id="cb108-2"><a href="#cb108-2" aria-hidden="true" tabindex="-1"></a>                    <span class="at">CCAvar1 =</span> (EOFset1 <span class="sc">%*%</span> cc<span class="sc">$</span>xcoef[,<span class="dv">1</span>])[,<span class="dv">1</span>],</span>
<span id="cb108-3"><a href="#cb108-3" aria-hidden="true" tabindex="-1"></a>                    <span class="at">CCAvar2 =</span> (EOFset2 <span class="sc">%*%</span> cc<span class="sc">$</span>ycoef[,<span class="dv">1</span>])[,<span class="dv">1</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p></p>
<p>A plot can be made using standard <strong>ggplot2</strong> commands.</p>
<p></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb109"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb109-1"><a href="#cb109-1" aria-hidden="true" tabindex="-1"></a>t_breaks <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">1</span>, nT, <span class="at">by =</span> <span class="dv">60</span>)     <span class="co"># breaks for x-labels</span></span>
<span id="cb109-2"><a href="#cb109-2" aria-hidden="true" tabindex="-1"></a>year_breaks <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">1970</span>, <span class="dv">2002</span>, <span class="at">by=</span><span class="dv">5</span>)  <span class="co"># labels for x-axis</span></span>
<span id="cb109-3"><a href="#cb109-3" aria-hidden="true" tabindex="-1"></a>g <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(CCA_df) <span class="sc">+</span></span>
<span id="cb109-4"><a href="#cb109-4" aria-hidden="true" tabindex="-1"></a>     <span class="fu">geom_line</span>(<span class="fu">aes</span>(t, CCAvar1), <span class="at">col =</span> <span class="st">"dark blue"</span>) <span class="sc">+</span></span>
<span id="cb109-5"><a href="#cb109-5" aria-hidden="true" tabindex="-1"></a>     <span class="fu">geom_line</span>(<span class="fu">aes</span>(t, CCAvar2), <span class="at">col =</span> <span class="st">"dark red"</span>) <span class="sc">+</span></span>
<span id="cb109-6"><a href="#cb109-6" aria-hidden="true" tabindex="-1"></a>     <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> t_breaks, <span class="at">labels =</span> year_breaks) <span class="sc">+</span></span>
<span id="cb109-7"><a href="#cb109-7" aria-hidden="true" tabindex="-1"></a>     <span class="fu">ylab</span>(<span class="st">"CCA variables"</span>) <span class="sc">+</span> <span class="fu">xlab</span>(<span class="st">"Year"</span>) <span class="sc">+</span> <span class="fu">theme_bw</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p></p>
<p></p>
<p></p>
<p>The plot of the time series of the first canonical variables is shown in <a href="#fig-CCA1" class="quarto-xref">Figure&nbsp;<span>2.23</span></a>. The plot shows a high correlation between the first pair of canonical variables. What are these canonical variables? They are simply a linear combination of the EOFs, where the linear weights are given in <code>cc$xcoef[,1]</code> and <code>cc$ycoef[,1]</code>, respectively.</p>
<p></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb110"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb110-1"><a href="#cb110-1" aria-hidden="true" tabindex="-1"></a>EOFs_CCA <span class="ot">&lt;-</span> EOFs[,<span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>] <span class="co"># first two columns are lon-lat</span></span>
<span id="cb110-2"><a href="#cb110-2" aria-hidden="true" tabindex="-1"></a>EOFs_CCA[,<span class="dv">3</span>] <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">as.matrix</span>(EOFs[,<span class="dv">3</span><span class="sc">:</span><span class="dv">12</span>]) <span class="sc">%*%</span> cc<span class="sc">$</span>xcoef[,<span class="dv">1</span>])</span>
<span id="cb110-3"><a href="#cb110-3" aria-hidden="true" tabindex="-1"></a>EOFs_CCA[,<span class="dv">4</span>] <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">as.matrix</span>(EOFs[,<span class="dv">3</span><span class="sc">:</span><span class="dv">12</span>]) <span class="sc">%*%</span> cc<span class="sc">$</span>ycoef[,<span class="dv">1</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p></p>
<p>Plotting of the weights as spatial maps is straightforward and left as an exercise. We plot weights (recall these are just linear combination of EOFs) for the lagged SSTs and the unlagged SSTs in <a href="#fig-CCA2" class="quarto-xref">Figure&nbsp;<span>2.24</span></a>.</p>
<p></p>
<p></p>
<p></p>
<p></p>


<div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" data-line-spacing="2" role="list" style="display: none">
<div id="ref-R_sppackage" class="csl-entry" role="listitem">
Bivand, R. S., Pebesma, E., &amp; Gomez-Rubio, V. (2013). <em>Applied spatial data analysis with <code>R</code></em> (second). Springer. <a href="http://www.asdar-book.org/">http://www.asdar-book.org/</a>
</div>
<div id="ref-cohen1969regression" class="csl-entry" role="listitem">
Cohen, A., &amp; Jones, R. H. (1969). Regression on a random field. <em>Journal of the American Statistical Association</em>, <em>64</em>(328), 1172–1182.
</div>
<div id="ref-cressie2011statistics" class="csl-entry" role="listitem">
Cressie, N., &amp; Wikle, C. K. (2011). <em>Statistics for spatio-temporal data</em>. John Wiley &amp; Sons.
</div>
<div id="ref-genton2015visuanimation" class="csl-entry" role="listitem">
Genton, M. G., Castruccio, S., Crippa, P., Dutta, S., Huser, R., Sun, Y., &amp; Vettori, S. (2015). Visuanimation in statistics. <em>Stat</em>, <em>4</em>(1), 81–96.
</div>
<div id="ref-hastie2009elements" class="csl-entry" role="listitem">
Hastie, T., Tibshirani, R., &amp; Friedman, J. (2009). <em>The elements of statistical learning</em> (2nd ed.). Springer.
</div>
<div id="ref-hotelling1936relations" class="csl-entry" role="listitem">
Hotelling, H. (1936). Relations between two sets of variates. <em>Biometrika</em>, <em>28</em>(3/4), 321–377.
</div>
<div id="ref-hovmoller1949trough" class="csl-entry" role="listitem">
Hovmöller, E. (1949). The trough-and-ridge diagram. <em>Tellus</em>, <em>1</em>(2), 62–66.
</div>
<div id="ref-johnson1992applied" class="csl-entry" role="listitem">
Johnson, R. A., &amp; Wichern, D. W. (1992). Applied multivariate statistical analysis. In <em>Prentice Hall</em> (3rd ed.). Prentice Hall.
</div>
<div id="ref-lamigueiro2018displaying" class="csl-entry" role="listitem">
Lamigueiro, O. P. (2018). <em>Displaying time series, spatial, and space-time data with r</em> (2nd ed.). Chapman; Hall/CRC.
</div>
<div id="ref-lucchesi2017visualizing" class="csl-entry" role="listitem">
Lucchesi, L. R., &amp; Wikle, C. K. (2017). Visualizing uncertainty in areal data with bivariate choropleth maps, map pixelation, and glyph rotation. <em>Stat</em>, <em>6</em>, 292–302.
</div>
<div id="ref-milliff2011ocean" class="csl-entry" role="listitem">
Milliff, R. F., Bonazzi, A., Wikle, C. K., Pinardi, N., &amp; Berliner, L. M. (2011). Ocean ensemble forecasting. Part i: Ensemble mediterranean winds from a bayesian hierarchical model. <em>Quarterly Journal of the Royal Meteorological Society</em>, <em>137</em>(657), 858–878.
</div>
<div id="ref-monahan2009empirical" class="csl-entry" role="listitem">
Monahan, A. H., Fyfe, J. C., Ambaum, M. H., Stephenson, D. B., &amp; North, G. R. (2009). Empirical orthogonal functions: The medium is the message. <em>Journal of Climate</em>, <em>22</em>(24), 6501–6514.
</div>
<div id="ref-obled1986some" class="csl-entry" role="listitem">
Obled, Ch., &amp; Creutin, J. D. (1986). Some developments in the use of empirical orthogonal functions for mapping meteorological fields. <em>Journal of Climate and Applied Meteorology</em>, <em>25</em>(9), 1189–1204.
</div>
<div id="ref-R_spacetime" class="csl-entry" role="listitem">
Pebesma, E. (2012). <span class="nocase">spacetime</span>: Spatio-temporal data in <code>R</code>. <em>Journal of Statistical Software</em>, <em>51</em>(7), 1–30. <a href="http://www.jstatsoft.org/v51/i07/">http://www.jstatsoft.org/v51/i07/</a>
</div>
<div id="ref-R_ggplot2" class="csl-entry" role="listitem">
Wickham, H. (2016). <em>ggplot2: Elegant graphics for data analysis</em> (2nd ed.). Springer.
</div>
<div id="ref-xu2005kernel" class="csl-entry" role="listitem">
Xu, K., Wikle, C. K., &amp; Fox, N. I. (2005). A kernel-based spatio-temporal dynamical model for nowcasting weather radar reflectivities. <em>Journal of the American Statistical Association</em>, <em>100</em>(472), 1133–1144.
</div>
</div>
</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./Chapter1.html" class="pagination-link" aria-label="Introduction to Spatio-Temporal Statistics">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Introduction to Spatio-Temporal Statistics</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./Chapter3.html" class="pagination-link" aria-label="Spatio-Temporal Statistical Models">
        <span class="nav-page-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Spatio-Temporal Statistical Models</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->




</body></html>